USE [msdb]
GO

/****** Object:  Job [DBA - AUTO KILL JOB_20 MINS]    Script Date: 2/9/2026 8:03:26 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [Database Maintenance]    Script Date: 2/9/2026 8:03:26 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'Database Maintenance' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'Database Maintenance'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA - AUTO KILL JOB_20 MINS', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'to Kill the long running jobs more than 60 mins', 
		@category_name=N'Database Maintenance', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [execute the sp]    Script Date: 2/9/2026 8:03:26 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'execute the sp', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXEC dbo.usp_Monitor_LongRunning_Jobs 
     @Threshold = 180, 
     @JobName = null,
     @Recipients = N''Aswin.kumarvpkothuru@thyrocare.com;techsupport@thyrocare.com;oms-dev@pharmeasy.in'';', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'every 10 mins', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=10, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20251117, 
		@active_end_date=99991231, 
		@active_start_time=109, 
		@active_end_time=235959, 
		@schedule_uid=N'aeed8ac3-1ffd-4923-8a95-2b275feb8183'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA - Regressing_Jobs]    Script Date: 2/9/2026 8:03:26 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:26 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA - Regressing_Jobs', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=2, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Send email notifications to _
                                @RrecipientsList (last parameter in SP) on CURRENTLY RUNNING _
                                Agent Jobs that regress in performance by duration compared to _
                                baseline (baseline collected during the number of days before _
                                getdate() specified by the first parameter @history_days.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'sa', 
		@notify_email_operator_name=N'geopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [asp_long_running_Regressing_Jobs_Alerts]    Script Date: 2/9/2026 8:03:26 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'asp_long_running_Regressing_Jobs_Alerts', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'exec        [dbo].[asp_long_running_Regressing_Jobs_Alerts1]   
            @history_days = 15,
            @avg_duration_multiplier = 2,
            @bEmail = 1,
            @bSaveToTable = 0,
            @RecipientsList  = ''sudhir@pharmeasy.in;db@thyrocare.com;retheesh.pillai@thyrocare.com;dinesh.jain@pharmeasy.in;dbasupport@geopits.freshdesk.com;mssqlsupport@geopits.com;'',
            @ignore_zero_durations = 0', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'every 1 min', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20201222, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'999ac144-4e13-4965-82f2-55555cc37a09'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA - Replication Latency]    Script Date: 2/9/2026 8:03:26 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:26 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA - Replication Latency', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'To send alerts DB team if latency in replication', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [execute sp]    Script Date: 2/9/2026 8:03:26 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'execute sp', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'exec Dba_CheckReplicationLatency', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Every 5 mins', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=5, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20240821, 
		@active_end_date=99991231, 
		@active_start_time=412, 
		@active_end_time=235959, 
		@schedule_uid=N'5e7f20bc-3490-4e57-89f1-1506848c50ed'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Archival]    Script Date: 2/9/2026 8:03:26 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [Database Maintenance]    Script Date: 2/9/2026 8:03:26 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'Database Maintenance' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'Database Maintenance'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Archival', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Thyrocare_Wo_DTL_Deletion', 
		@category_name=N'Database Maintenance', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [CharbiDB]    Script Date: 2/9/2026 8:03:26 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'CharbiDB', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=4, 
		@on_success_step_id=2, 
		@on_fail_action=4, 
		@on_fail_step_id=2, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'exec charbi..USP_SCHEDULED_RETENTION', 
		@database_name=N'charbi', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [wo_hdr-90days]    Script Date: 2/9/2026 8:03:26 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'wo_hdr-90days', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=4, 
		@on_success_step_id=3, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE THYROCARE
GO
DECLARE @BATCHSIZE INT = 4999
WHILE 1 = 1
BEGIN
DELETE TOP (@BATCHSIZE)
FROM THYROCARE..WO_HDR WITH (ROWLOCK,READPAST)
WHERE SDATE <=GETDATE()-90
IF @@ROWCOUNT < @BATCHSIZE BREAK
END', 
		@database_name=N'Thyrocare', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [wo_dtl-90days]    Script Date: 2/9/2026 8:03:26 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'wo_dtl-90days', 
		@step_id=3, 
		@cmdexec_success_code=0, 
		@on_success_action=4, 
		@on_success_step_id=4, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE THYROCARE
GO
DECLARE @BATCHSIZE INT = 4999
WHILE 1 = 1
BEGIN
DELETE TOP (@BATCHSIZE)
FROM THYROCARE..WO_DTL WITH (ROWLOCK,READPAST)
WHERE SDATE <=GETDATE()-90
IF @@ROWCOUNT < @BATCHSIZE BREAK
END', 
		@database_name=N'Thyrocare', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [AVM-730days]    Script Date: 2/9/2026 8:03:26 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'AVM-730days', 
		@step_id=4, 
		@cmdexec_success_code=0, 
		@on_success_action=4, 
		@on_success_step_id=5, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE THYROCARE
GO
DECLARE @BATCHSIZE INT = 4999
WHILE 1 = 1
BEGIN
DELETE TOP (@BATCHSIZE)
FROM THYROCARE..AVM_VP_BILLED WITH (ROWLOCK,READPAST)
WHERE SDATE <=GETDATE()-730
IF @@ROWCOUNT < @BATCHSIZE BREAK
END', 
		@database_name=N'Thyrocare', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Results_Header-30days]    Script Date: 2/9/2026 8:03:26 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Results_Header-30days', 
		@step_id=5, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE THYROCARE
GO
DECLARE @BATCHSIZE INT = 4999
WHILE 1 = 1
BEGIN
DELETE TOP (@BATCHSIZE)
FROM THYROCARE..tbl_Results_Header WITH (ROWLOCK,READPAST)
WHERE SDATE <=GETDATE()-30
IF @@ROWCOUNT < @BATCHSIZE BREAK
END', 
		@database_name=N'Thyrocare', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Archival', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20230616, 
		@active_end_date=99991231, 
		@active_start_time=90101, 
		@active_end_time=235959, 
		@schedule_uid=N'474649a1-f884-4ed5-b3f6-6bd2552f565a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA CPU Utilization data]    Script Date: 2/9/2026 8:03:26 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]    Script Date: 2/9/2026 8:03:26 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA CPU Utilization data', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:26 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE DBADB
go
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
insert into DBADB.dbo.CPUUtilisationdata
SELECT
getdate(),
         cpu_idle = record.value(''(./Record/SchedulerMonitorEvent/SystemHealth/SystemIdle)[1]'', ''int''),
         cpu_sql = record.value(''(./Record/SchedulerMonitorEvent/SystemHealth/ProcessUtilization)[1]'', ''int''),
Other_process = 100 - record.value(''(./Record/SchedulerMonitorEvent/SystemHealth/SystemIdle)[1]'', ''int'') - record.value(''(./Record/SchedulerMonitorEvent/SystemHealth/ProcessUtilization)[1]'', ''int'')
FROM (
         SELECT TOP 1 CONVERT(XML, record) AS record
         FROM sys.dm_os_ring_buffers
         WHERE ring_buffer_type = N''RING_BUFFER_SCHEDULER_MONITOR''
         AND record LIKE ''% %''
ORDER BY TIMESTAMP DESC
)
as cpu_usage', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20230209, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'cedf6157-d5f8-49a7-95cf-0a670f5e91e9'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA DAILY STATS UPDATE]    Script Date: 2/9/2026 8:03:26 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:26 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA DAILY STATS UPDATE', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Update daily stats', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Step1]    Script Date: 2/9/2026 8:03:27 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Step1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @TimeLimitSec int = 60 * 60 * 4 -- max 4 hours

EXECUTE dbo.IndexOptimize
@Databases = ''thyrocare'',
@FragmentationLow = NULL,
@FragmentationMedium = NULL,
@FragmentationHigh = NULL,
@UpdateStatistics = ''ALL'',
@OnlyModifiedStatistics = ''Y'',
@TimeLimit = @TimeLimitSec,
@MaxDOP = 4,
@Delay = 5,
@PartitionLevel = ''Y'',
@LogToTable = ''Y'',
@Execute = ''Y''', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 11', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20240305, 
		@active_end_date=99991231, 
		@active_start_time=110005, 
		@active_end_time=235959, 
		@schedule_uid=N'46520479-b752-4bb5-bf4b-3944e23e79fe'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Database Size report]    Script Date: 2/9/2026 8:03:27 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:27 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Database Size report', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:27 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Insert into Common Table
DECLARE @SNAME VARCHAR(100)
DECLARE DB_CURSOR CURSOR FOR SELECT @@SERVERNAME 
OPEN DB_CURSOR
FETCH DB_CURSOR INTO @SNAME
WHILE @@FETCH_STATUS = 0
BEGIN
	DECLARE @NAME varchar(100)
	declare @var2 table (Name varchar(300))
	declare @var1 nvarchar(3000)
	DECLARE @VAR3 nvarchar(50)
	SELECT @VAR3 = @@SERVERNAME
		IF(@SNAME != @VAR3) 
		BEGIN
	select @var1 =''select * from openquery(''+@SNAME+'',''''select name from sys.sysdatabases where name not in (''''THYROCARE2010'''',''''THYROCARE2011'''',''''THYROCARE2012'''',''''THYROCARE2013'''',''''THYROCARE2014''''
,''''THYROCARE2015'''',''''THYROCARE2016'''',''''THYROCARE2017'''',''''THYROCARE2018'''',''''master'''',''''model'''',''''distribution'''',''''DBADB'''',''''ReportServer'''',''''ReportServerTempDB'''')'''')''
	insert into @var2 exec sp_executesql @var1
	DECLARE @INSNAME table(InstanceName varchar(100))
	DECLARE @VAR nvarchar(500)
	SET @VAR = ''select * from openquery(''+@SNAME+'',''''SELECT @@SERVERNAME'''')''
	insert into @INSNAME exec sp_executesql @VAR
	END
	ELSE
	BEGIN 
	INSERT into @var2 select name from sys.sysdatabases
	where name not in (''THYROCARE2010'',''THYROCARE2011'',''THYROCARE2012'',''THYROCARE2013'',''THYROCARE2014''
,''THYROCARE2015'',''THYROCARE2016'',''THYROCARE2017'',''THYROCARE2018'',''master'',''model'',''distribution'',''DBADB'',''ReportServer'',''ReportServerTempDB'')

	INSERT into @INSNAME select @@SERVERNAME
	End
DECLARE DB_CURSOR1 CURSOR FOR select Name from @var2
	OPEN DB_CURSOR1
	FETCH DB_CURSOR1 INTO @NAME
	WHILE @@FETCH_STATUS = 0
		BEGIN
			declare @cmd nvarchar(1000)
			DECLARE @SQL TABLE (databasename varchar(100),Size varchar(100))
			insert into @SQL exec (''[''+@NAME+''].dbo.sp_executesql N''''SELECT db_name() AS [Database Name],
			SUM(CAST(size AS DECIMAL(18,2))/128.0) AS [DatabaseSize MB]
			FROM [''+@NAME+''].sys.sysfiles'''''')
			insert into DBADB.dbo.DB_Meta select (select InstanceName from @INSNAME),databasename,GETDATE(),Size from @SQL
			delete from @SQL
			FETCH  DB_CURSOR1 INTO @NAME
		END
	CLOSE DB_CURSOR1
	DEALLOCATE DB_CURSOR1
	delete from @var2
	delete from @INSNAME
	FETCH  DB_CURSOR INTO @SNAME		
END
CLOSE DB_CURSOR
DEALLOCATE DB_CURSOR
--Send Table in HTML
SET NOCOUNT ON
DECLARE  @xml nvarchar(max)
SELECT @xml = Cast((SELECT a.Instance_Name AS ''td'',
'''',
a.Database_Names AS ''td'',
'''',
b.size2 AS ''td'',
'''',
a.size1 AS ''td'',
'''',
(cast(cast(((a.size1 - b.size2)/b.size2 * 100) as decimal(18,2)) as varchar(100)) +'' %'') AS ''td''
FROM (SELECT Database_Names,Instance_Name,[Size MB] as size1 from DBADB.dbo.DB_Meta
where Dates=cast(GETDATE() as date)) as a
inner join 
(SELECT Database_Names,Instance_Name,[Size MB] as size2 from DBADB.dbo.DB_Meta where Dates=cast(GETDATE()-1 as date)) as b 
on  a.Database_Names=b.Database_Names and a.Instance_Name=b.Instance_Name 
where a.Database_Names not in (''THYROCARE2010'',''THYROCARE2011'',''THYROCARE2012'',''THYROCARE2013'',''THYROCARE2014''
,''THYROCARE2015'',''THYROCARE2016'',''THYROCARE2017'',''THYROCARE2018'',''master'',''model'',''distribution'',''DBADB'',''ReportServer'',''ReportServerTempDB'')
order by a.Instance_Name
FOR xml path(''tr''), elements) AS NVARCHAR(max))
Declare @body nvarchar(max)
SET @body =
''<html>
	<head>
		<style>
			table, th, td 
			{
				border: 1px solid black;
				border-collapse: collapse;
				text-align: center;
			}
		</style>
	</head>
	<body>
		<H2>
		Database Size Report
		</H2>
		<table> 
			<tr>
				<th> Server </th> <th>Database Name</th> <th>Yesterday DB Size(MB)</th><th>Today DB Size(MB)</th> <th>Difference</th>   
			</tr>''
			SET @body = @body + @xml + ''
		</table>
	</body>
</html>''
if(@xml is not null)
BEGIN
EXEC msdb.dbo.Sp_send_dbmail
@profile_name = ''DBA'',
@body = @body,
@body_format =''html'',
@recipients = ''mssqlsupport@geopits.com'',
--@copy_recipients ='''',
@blind_copy_recipients=''mssqlsupport@geopits.com'',
@subject = ''Database Size Report:192.168.0.30'';
END
SET NOCOUNT OFF

', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20231121, 
		@active_end_date=99991231, 
		@active_start_time=180000, 
		@active_end_time=235959, 
		@schedule_uid=N'b6e778e6-2632-4859-8b51-e6eef5ec8c6f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA DB File Size Data]    Script Date: 2/9/2026 8:03:27 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:27 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA DB File Size Data', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:27 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'insert into DBADB.dbo. DB_FileSizeData

SELECT top 1
    d.name AS ''Database'',
 
                  m.name AS ''File'',

                   m.type_desc as Type,
  
	 -- m.size,
   	
	 m.size * 8/1024 ''Size (MB)'',
   
	 SUM(m.size * 8/1024) OVER (PARTITION BY d.name) AS ''Database Total'',

	Getdate() as Date
  
	 -- m.max_size
FROM sys.master_files m
	
INNER JOIN sys.databases d
	 ON
d.database_id = m.database_id;', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Backupinfo]    Script Date: 2/9/2026 8:03:27 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Backupinfo', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'INSERT INTO DBADB.dbo.Backupinfodata

SELECT
    CONVERT(CHAR(100), SERVERPROPERTY(''Servername'')) AS ServerName,
    bs.database_name,
    bs.backup_start_date,
    bs.backup_finish_date,
    bs.expiration_date,
    CASE bs.type
        WHEN ''D'' THEN ''Database''
        WHEN ''I'' THEN ''DIFF''
        WHEN ''L'' THEN ''Log''
    END AS BackupType,
    bs.backup_size,
    bmf.physical_device_name,
    bs.name AS BackupSetName,
    bs.description
FROM msdb.dbo.backupset bs
INNER JOIN msdb.dbo.backupmediafamily bmf 
    ON bmf.media_set_id = bs.media_set_id
WHERE bs.backup_start_date >= DATEADD(DAY, -8, GETDATE())
  AND NOT EXISTS (
      SELECT 1
      FROM DBADB.dbo.Backupinfodata t
      WHERE t.DbNmae   = bs.database_name
        AND t.BackupStartDate = bs.backup_start_date
        AND t.BackupEndTime= bs.backup_finish_date
        AND t.BackupType      = CASE bs.type
                                  WHEN ''D'' THEN ''Database''
                                  WHEN ''I'' THEN ''DIFF''
                                  WHEN ''L'' THEN ''Log''
                                END
  )
ORDER BY bs.database_name, bs.backup_finish_date;
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20240115, 
		@active_end_date=99991231, 
		@active_start_time=234000, 
		@active_end_time=235959, 
		@schedule_uid=N'6f8cd905-11b7-4e05-9fcc-e6cebb5d7dce'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Health Check Report]    Script Date: 2/9/2026 8:03:27 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]    Script Date: 2/9/2026 8:03:27 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Health Check Report', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:27 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @RC int
DECLARE @MailProfile nvarchar(200)
DECLARE @MailID nvarchar(2000)
DECLARE @Server varchar(100)
 
-- TODO: Set parameter values here.
 
EXECUTE @RC = DBADB.[dbo].[SQLhealthcheck_report]
   ''DBA''
  ,''mssqlsupport@geopits.com''
  ,''192.168.0.30''
GO
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20230209, 
		@active_end_date=99991231, 
		@active_start_time=63000, 
		@active_end_time=235959, 
		@schedule_uid=N'8cd5eaac-e5ef-422f-9a7d-fe4e5a23b1d3'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA High CPU Alert]    Script Date: 2/9/2026 8:03:27 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]    Script Date: 2/9/2026 8:03:27 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA High CPU Alert', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:27 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE DBADB;
GO

SET NOCOUNT ON;

DECLARE @total_util_count INT, @total_avg FLOAT, @sql_avg FLOAT, @other_avg FLOAT;
DECLARE @cpu_threshold INT = 90; -- Threshold set to 90% CPU utilization
DECLARE @body_resp VARCHAR(200), @subject_resp VARCHAR(200), @content VARCHAR(MAX);
DECLARE @ServerName VARCHAR(200);
SET @ServerName = (Select @@SERVERNAME);

-- Drop the temporary table if it exists
IF OBJECT_ID(''tempdb.dbo.#cpu_util'', ''U'') IS NOT NULL
    DROP TABLE #cpu_util;

-- Create a temporary table to store CPU utilization data
CREATE TABLE #cpu_util (idle INT, sql INT, other INT);

-- Insert the last 5 records of CPU utilization where idle CPU is not null and other processes are not null
INSERT INTO #cpu_util
SELECT TOP 5 IdleCPU, SQLUtilisedCPU, OtherProsses
FROM [dbo].[CPUUtilisationdata]
WHERE IdleCPU IS NOT NULL AND OtherProsses IS NOT NULL
ORDER BY time DESC;

-- Get the count of records in the temporary table
SELECT @total_util_count = COUNT(*) FROM #cpu_util;

-- If there are at least 5 records, calculate the averages
IF @total_util_count = 5
BEGIN
    -- Calculate the total average CPU utilization, SQL utilization, and other processes utilization
    SELECT @total_avg = 100 - ROUND(AVG(CAST(idle AS FLOAT(2))), 2), 
           @sql_avg = ROUND(AVG(CAST(sql AS FLOAT(2))), 2), 
           @other_avg = ROUND(AVG(CAST(other AS FLOAT(2))), 2)
    FROM #cpu_util;
    
    -- If the average CPU utilization exceeds the threshold of 90%, send an email alert
    IF @total_avg > @cpu_threshold
    BEGIN
        -- Construct the email body with the CPU utilization details
		SET @Content= ''<p>Hello Team,</p>'' +
		''<p>Our DBAs have detected High CPU Utilization on <b>''+ @ServerName+ ''</b> Server , which may impact overall system performance.</p>''
        SET @body_resp = ''CPU Utilization is <span style="color:red;"> '' + CAST(@total_avg AS VARCHAR(8)) + ''</span>''+ ''% for the last 5 occurrences''
                 + ''<br/>'' + ''SQL Utilization: '' + CAST(@sql_avg AS VARCHAR(8)) + ''%''
                 + ''<br/>'' + ''Other Process Utilization: '' + CAST(@other_avg AS VARCHAR(8)) + ''%'';

        -- Construct the email subject
        SET @subject_resp = ''Thyrocare HIGH CPU Alert! CPU Utilization has reached '' + CAST(@total_avg AS VARCHAR(8)) + ''%'' + '' (''+@ServerName+'')''; --change1
        IF OBJECT_ID(''tempdb..#BlockingInfo'') IS NOT NULL DROP TABLE #BlockingInfo;
IF OBJECT_ID(''tempdb..#RequestInfo'') IS NOT NULL DROP TABLE #RequestInfo;
IF OBJECT_ID(''tempdb..#ConnectionStats'') IS NOT NULL DROP TABLE #ConnectionStats;

-- Create the temporary tables
CREATE TABLE #BlockingInfo (
    head_blocker_session_id INT,
    blocking_queries_count INT,
    head_blocker_query NVARCHAR(200)
);

CREATE TABLE #RequestInfo (
    session_id INT,
    duration_mm_ss VARCHAR(8),
    statement_text NVARCHAR(200),
    cpu_time_ms INT,
    logical_reads BIGINT,
    request_start_time DATETIME
);

CREATE TABLE #ConnectionStats (
    DBName NVARCHAR(128),
    NumberOfConnections INT
    
);

	-- Generate combined HTML for the email
	DECLARE @html NVARCHAR(MAX);
	DECLARE @full_body NVARCHAR(MAX);

	
-- Insert data into #BlockingInfo
WITH cteHead AS (
    SELECT 
        sess.session_id, 
        req.request_id, 
        LEFT(ISNULL(req.wait_type, ''''), 50) AS wait_type,
        LEFT(ISNULL(req.wait_resource, ''''), 40) AS wait_resource, 
        LEFT(req.last_wait_type, 50) AS last_wait_type,
        sess.is_user_process, 
        req.cpu_time AS request_cpu_time, 
        req.logical_reads AS request_logical_reads,
        req.reads AS request_reads, 
        req.writes AS request_writes, 
        req.wait_time, 
        req.blocking_session_id,
        sess.memory_usage,
        sess.cpu_time AS session_cpu_time, 
        sess.reads AS session_reads, 
        sess.writes AS session_writes, 
        sess.logical_reads AS session_logical_reads,
        CONVERT(decimal(5,2), req.percent_complete) AS percent_complete, 
        req.estimated_completion_time AS est_completion_time,
        req.start_time AS request_start_time, 
        LEFT(req.status, 15) AS request_status, 
        req.command,
        req.plan_handle, 
        req.sql_handle, 
        req.statement_start_offset, 
        req.statement_end_offset, 
        conn.most_recent_sql_handle,
        LEFT(sess.status, 15) AS session_status, 
        sess.group_id, 
        req.query_hash, 
        req.query_plan_hash
    FROM sys.dm_exec_sessions AS sess
    LEFT OUTER JOIN sys.dm_exec_requests AS req 
        ON sess.session_id = req.session_id
    LEFT OUTER JOIN sys.dm_exec_connections AS conn 
        ON conn.session_id = sess.session_id 
),
cteBlockingHierarchy AS (
    SELECT 
        head.session_id AS head_blocker_session_id, 
        head.session_id AS session_id, 
        head.blocking_session_id,
        head.wait_type, 
        head.wait_time, 
        head.wait_resource, 
        head.statement_start_offset, 
        head.statement_end_offset,
        head.plan_handle, 
        head.sql_handle, 
        head.most_recent_sql_handle, 
        0 AS Level
    FROM cteHead AS head
    WHERE (head.blocking_session_id IS NULL OR head.blocking_session_id = 0)
    AND head.session_id IN (SELECT DISTINCT blocking_session_id FROM cteHead WHERE blocking_session_id != 0)
    UNION ALL
    SELECT 
        h.head_blocker_session_id, 
        blocked.session_id, 
        blocked.blocking_session_id, 
        blocked.wait_type,
        blocked.wait_time, 
        blocked.wait_resource, 
        h.statement_start_offset, 
        h.statement_end_offset,
        h.plan_handle, 
        h.sql_handle, 
        h.most_recent_sql_handle, 
        [Level] + 1
    FROM cteHead AS blocked
    INNER JOIN cteBlockingHierarchy AS h 
        ON h.session_id = blocked.blocking_session_id 
        AND h.session_id != blocked.session_id -- Avoid infinite recursion for latch type of blocking
    WHERE h.wait_type COLLATE Latin1_General_BIN NOT IN (''EXCHANGE'', ''CXPACKET'') 
        OR h.wait_type IS NULL
)
INSERT INTO #BlockingInfo (head_blocker_session_id, blocking_queries_count, head_blocker_query)
SELECT 
    bh.head_blocker_session_id,
    COUNT(bh.session_id) - 1 AS blocking_queries_count,
    LEFT(txt.text, 200) AS head_blocker_query
FROM cteBlockingHierarchy AS bh
OUTER APPLY sys.dm_exec_sql_text(ISNULL(bh.sql_handle, bh.most_recent_sql_handle)) AS txt
GROUP BY bh.head_blocker_session_id, txt.text;

-- Insert data into #RequestInfo
INSERT INTO #RequestInfo (session_id, duration_mm_ss, statement_text, cpu_time_ms, logical_reads, request_start_time)
SELECT TOP 5
    req.session_id,
    -- Convert total_elapsed_time to hh:mm:ss format
    RIGHT(''0'' + CAST((req.total_elapsed_time / 3600000) AS VARCHAR(2)), 2) + '':'' +
    RIGHT(''0'' + CAST(((req.total_elapsed_time % 3600000) / 60000) AS VARCHAR(2)), 2) + '':'' +
    RIGHT(''0'' + CAST((((req.total_elapsed_time % 3600000) % 60000) / 1000) AS VARCHAR(2)), 2) AS duration_mm_ss,
    LEFT(
        REPLACE(
            REPLACE(
                SUBSTRING(
                    ST.text, 
                    (req.statement_start_offset / 2) + 1, 
                    ((CASE req.statement_end_offset
                        WHEN -1 THEN DATALENGTH(ST.text)
                        ELSE req.statement_end_offset
                     END - req.statement_start_offset) / 2) + 1
                ),
                CHAR(10), '' ''
            ), 
            CHAR(13), '' ''
        ),
        200
    ) AS statement_text,
    req.cpu_time AS cpu_time_ms,
    req.logical_reads,
    -- Get the start time formatted as yyyy-MM-dd HH:mm:ss
    req.start_time AS request_start_time
FROM sys.dm_exec_requests AS req
CROSS APPLY sys.dm_exec_sql_text(req.sql_handle) AS ST
WHERE req.total_elapsed_time / 60000 > 5
and LEFT(
        REPLACE(
            REPLACE(
                SUBSTRING(
                    ST.text, 
                    (req.statement_start_offset / 2) + 1, 
                    ((CASE req.statement_end_offset
                        WHEN -1 THEN DATALENGTH(ST.text)
                        ELSE req.statement_end_offset
                     END - req.statement_start_offset) / 2) + 1
                ),
                CHAR(10), '' ''
            ), 
            CHAR(13), '' ''
        ),
        200
    )not like  ''sp_server_diagnostics%'' 
	and    LEFT(
        REPLACE(
            REPLACE(
                SUBSTRING(
                    ST.text, 
                    (req.statement_start_offset / 2) + 1, 
                    ((CASE req.statement_end_offset
                        WHEN -1 THEN DATALENGTH(ST.text)
                        ELSE req.statement_end_offset
                     END - req.statement_start_offset) / 2) + 1
                ),
                CHAR(10), '' ''
            ), 
            CHAR(13), '' ''
        ),
        200
    )not like  ''%WAITFOR(RECEIVE conversation_handle%'' and    LEFT(
        REPLACE(
            REPLACE(
                SUBSTRING(
                    ST.text, 
                    (req.statement_start_offset / 2) + 1, 
                    ((CASE req.statement_end_offset
                        WHEN -1 THEN DATALENGTH(ST.text)
                        ELSE req.statement_end_offset
                     END - req.statement_start_offset) / 2) + 1
                ),
                CHAR(10), '' ''
            ), 
            CHAR(13), '' ''
        ),
        200
    )not like  ''BACKUP DATABASE%''
	
ORDER BY req.total_elapsed_time DESC;

-- Insert data into #ConnectionStats
INSERT INTO #ConnectionStats (DBName, NumberOfConnections)
SELECT 
    DB_NAME(dbid) AS DBName,
    COUNT(dbid) AS NumberOfConnections
    
FROM sys.sysprocesses
WHERE dbid > 5 and status <> ''sleeping'' and DB_NAME(dbid) not in (''DBADB'')
GROUP BY dbid
ORDER BY DB_NAME(dbid);


	-- Append rows for long running queries

SET @html = N''
		<html>''+
		''<head>'' +
		''<style>'' +
		''body { font-family: Arial, sans-serif; color: #333; line-height: 1.6; }'' +
		''table { width: 100%; border-collapse: collapse; margin-top: 20px; }'' +
		''table, th, td { border: 1px solid #ddd; }'' +
		''th, td { padding: 12px; text-align: centre; }'' +
		''th { background-color: #008bff; color: white; }'' +
		''tr:nth-child(even) { background-color: #f2f2f2; }'' +
		''p { margin: 0 0 10px; }'' +
		''h2 { color: #007bff; }'' +
		''</style>'' +
		''</head>''

IF EXISTS (SELECT 1 FROM #RequestInfo)
BEGIN

     set @html=@html+'' 
                  <h2>Long Running Queries</h2>
           <table>
               <tr>
                   <th>Session ID</th>
                   <th>Duration (hh:mm:ss)</th>
                   <th>Statement Text</th>
                   <th>CPU Time (ms)</th>
                   <th>Logical Reads</th>
                   <th>Request Start Time</th>
               </tr>'';

    SELECT @html = @html + 
    N''<tr>
	
        <td>'' + CAST(session_id AS NVARCHAR) + ''</td>
        <td>'' + duration_mm_ss + ''</td>
        <td>'' + statement_text + ''</td>
        <td>'' + CAST(cpu_time_ms AS NVARCHAR) + ''</td>
        <td>'' + CAST(logical_reads AS NVARCHAR) + ''</td>
        <td>'' + FORMAT(request_start_time, ''yyyy-MM-dd HH:mm:ss'') + ''</td>
    </tr>''
FROM #RequestInfo;

       -- Close the long Queries table
    SET @html = @html + 
        N''</table>'';
END
ELSE
BEGIN
    SET @html = @html + N''
    <h2>Long Running Queries</h2>
        <p>No long Running Queries more then 5 Minutes .</p>'';
		
END



-- Add Blocking Queries section if any blocking is detected
IF EXISTS (SELECT 1 FROM #BlockingInfo)
BEGIN
    SET @html = @html + N''
    <h2>Blocking Queries </h2>
    <table>
        <tr>
            <th>Head Blocker Session ID</th>
            <th>Blocking Queries Count</th>
            <th>Head Blocker Query</th>
        </tr>'';

    -- Append rows for blocking queries
    SELECT @html = @html + 
        N''<tr>
            <td>'' + CAST(head_blocker_session_id AS NVARCHAR) + ''</td>
            <td>'' + CAST(blocking_queries_count AS NVARCHAR) + ''</td>
            <td>'' + head_blocker_query + ''</td>
        </tr>''
    FROM #BlockingInfo;

    -- Close the Blocking Queries table
    SET @html = @html + 
        N''</table>'';
END
ELSE
BEGIN
    SET @html = @html + N''
    <h2>Blocking Queries </h2>
        <p>No blocking currently occurred.</p>'';
END

-- Add Connection Stats section
IF EXISTS (SELECT 1 FROM #ConnectionStats)
BEGIN
SET @html = @html + N''
    <h2>Connection Statistics</h2>
    <table border="1" cellpadding="5" cellspacing="0">
        <thead>
            <tr>
                <th>Database Name</th>
                <th>Number of Connections</th>
            </tr>
        </thead>
        <tbody>'';

-- Loop through the connection statistics and append each row
SELECT @html = @html + 
    N''<tr>
        <td>'' + DBName + ''</td>
        <td>'' + CAST(NumberOfConnections AS NVARCHAR) + ''</td>
    </tr>''
FROM #ConnectionStats;

-- Closing the table after appending the rows
SET @html = @html + N''</tbody></table>'';
END
ELSE
BEGIN
    SET @html = @html + N''
     <h2>Connection Statistics</h2>
        <p>No Active connection occurred.</p>'';
END
DECLARE @Signature VARCHAR(MAX);

SET @Signature = ''<br>'' + 
    '' <p>Thanks for your attention.</p>'' +
    ''<p>Best Regards,<br>MSSQL DBA<br>GeoPITS</p>'' -- change 2
        -- Send the email using sp_send_dbmail
SET @full_body= @content+ @body_resp + @html + @Signature
        EXEC msdb.dbo.sp_send_dbmail
            @profile_name = ''DBA'', --change 3 client profiler
            @body = @full_body,
            @body_format=''HTML'',
            @recipients = ''mssqlalerts@geopits.com'', --  change 4 client mail , our mail
            @subject = @subject_resp;
    END
END

-- Drop the temporary table after use
IF OBJECT_ID(''tempdb.dbo.#cpu_util'', ''U'') IS NOT NULL
    DROP TABLE #cpu_util;

SET NOCOUNT OFF;
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=5, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20230209, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'280edbc6-08a6-45e3-b978-76621f0ff3e8'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Host Hit Data]    Script Date: 2/9/2026 8:03:27 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]    Script Date: 2/9/2026 8:03:27 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Host Hit Data', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=2, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'''Retrieves the list of hostnames hitting the server every 30 minutes.'';
', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'geopits1', 
		@notify_email_operator_name=N'geopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:27 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'insert into DBADB.dbo.Host_Hits_Data
select distinct host_name, CONVERT(DATE, login_time) AS login_date, 
login_name, program_name, client_interface_name
FROM sys.dm_exec_sessions
WHERE 
    is_user_process = 1
ORDER BY 
    host_name;', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=30, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20230320, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'bc530142-5421-4f01-8f32-ca295b1d92d3'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Index Rebuild - CarbiLTCData]    Script Date: 2/9/2026 8:03:27 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:27 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Index Rebuild - CarbiLTCData', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:27 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXECUTE dbo.IndexOptimize
@Databases = ''CharbiLTCData'',
@FragmentationLow = NULL,
@FragmentationMedium = ''INDEX_REBUILD_ONLINE,INDEX_REBUILD_OFFLINE'',
@FragmentationHigh = ''INDEX_REBUILD_ONLINE,INDEX_REBUILD_OFFLINE'',
@FragmentationLevel1 = 10,
@FragmentationLevel2 = 30,
@LogToTable = ''Y'',
@SortInTempdb = ''Y''

----------Last modified by kalaimani 11_04_2024 added sortin temp db option', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Updatestats_with fullscan]    Script Date: 2/9/2026 8:03:27 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Updatestats_with fullscan', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXEC sp_MSForEachTable ''UPDATE STATISTICS ? WITH FULLSCAN;''', 
		@database_name=N'CharbiLTCData', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Index Rebuild - Charbi DB]    Script Date: 2/9/2026 8:03:27 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:27 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Index Rebuild - Charbi DB', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This Job will rebuild all the indexes in the databses whose fragmentation level is >30%.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:27 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=2, 
		@on_fail_action=2, 
		@on_fail_step_id=2, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXECUTE dbo.IndexOptimize

@Databases = ''charbi'',

@FragmentationLow = NULL,

@FragmentationMedium = NULL,
@FragmentationHigh = ''INDEX_REBUILD_ONLINE,INDEX_REBUILD_OFFLINE'',
@FragmentationLevel1 = 10,
@FragmentationLevel2 = 30,
@LogToTable = ''Y'',
@SortInTempdb = ''Y''

----------Last modified by kalaimani 11_04_2024 added sortin temp db option', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [charbi statistics update with fullscan]    Script Date: 2/9/2026 8:03:27 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'charbi statistics update with fullscan', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SET NOCOUNT ON
    GO

    --Determine if you want to execute the script with FULLSCAN
    DECLARE @WithFullscan BIT
    SELECT  @WithFullscan = 0

    -------------------
    --Begin script
    -------------------

    DECLARE @StartTime DATETIME

    SELECT  @StartTime = GETDATE()

    IF OBJECT_ID(''tempdb..#TablesToUpdateStats'') IS NOT NULL 
        BEGIN
            DROP TABLE #TablesToUpdateStats
        END

    DECLARE @NumTables VARCHAR(20)

    SELECT  s.[Name] AS SchemaName
          , t.[name] AS TableName
          , SUM(p.rows) AS RowsInTable
    INTO    #TablesToUpdateStats
    FROM    sys.schemas s
            LEFT JOIN sys.tables t
                ON s.schema_id = t.schema_id
            LEFT JOIN sys.partitions p
                ON t.object_id = p.object_id
            LEFT JOIN sys.allocation_units a
                ON p.partition_id = a.container_id
    WHERE   p.index_id IN ( 0, 1 ) -- 0 heap table , 1 table with clustered index
            AND p.rows IS NOT NULL
            AND a.type = 1  -- row-data only , not LOB
    GROUP BY s.[Name]
          , t.[name]
    SELECT  @NumTables = @@ROWCOUNT

    DECLARE updatestats CURSOR
    FOR
        SELECT  ROW_NUMBER() OVER ( ORDER BY ttus.RowsInTable )
              , ttus.SchemaName
              , ttus.TableName
              , ttus.RowsInTable
        FROM    #TablesToUpdateStats AS ttus
        ORDER BY ttus.RowsInTable
    OPEN updatestats

    DECLARE @TableNumber VARCHAR(20)
    DECLARE @SchemaName NVARCHAR(128)
    DECLARE @tableName NVARCHAR(128)
    DECLARE @RowsInTable VARCHAR(20)
    DECLARE @Statement NVARCHAR(300)
    DECLARE @Status NVARCHAR(300)
    DECLARE @FullScanSQL VARCHAR(20)

    IF @WithFullscan = 1 
        BEGIN
            SELECT  @FullScanSQL = '' WITH FULLSCAN''
        END
    ELSE 
        BEGIN --If @WithFullscan<>1 then set @FullScanSQL to empty string
            SELECT  @FullScanSQL = ''''
        END

    FETCH NEXT FROM updatestats INTO @TableNumber, @SchemaName, @tablename,
        @RowsInTable
    WHILE ( @@FETCH_STATUS = 0 ) 
        BEGIN

            SET @Statement = ''UPDATE STATISTICS ['' + @SchemaName + ''].[''
                + @tablename + '']'' + @FullScanSQL

            SET @Status = ''Table '' + @TableNumber + '' of '' + @NumTables
                + '': Running '''''' + @Statement + '''''' ('' + @RowsInTable
                + '' rows)''
            RAISERROR (@Status, 0, 1) WITH NOWAIT  --RAISERROR used to immediately output status

            EXEC sp_executesql @Statement

            FETCH NEXT FROM updatestats INTO @TableNumber, @SchemaName,
                @tablename, @RowsInTable
        END

    CLOSE updatestats
    DEALLOCATE updatestats

    DROP TABLE #TablesToUpdateStats

    PRINT ''Total Elapsed Time: '' + CONVERT(VARCHAR(100), DATEDIFF(minute,@StartTime,GETDATE())) + '' minutes''
                                                             
   GO', 
		@database_name=N'charbi', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Index Rebuild - Nueclear]    Script Date: 2/9/2026 8:03:27 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:27 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Index Rebuild - Nueclear', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:27 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXECUTE dbo.IndexOptimize
@Databases = ''Nueclear'',
@FragmentationLow = NULL,
@FragmentationMedium = ''INDEX_REBUILD_ONLINE,INDEX_REBUILD_OFFLINE'',
@FragmentationHigh = ''INDEX_REBUILD_ONLINE,INDEX_REBUILD_OFFLINE'',
@FragmentationLevel1 = 10,
@FragmentationLevel2 = 30,
@LogToTable = ''Y'',
@SortInTempdb = ''Y''

----------Last modified by kalaimani 11_04_2024 added sortin temp db option', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Updatestats with fullscan]    Script Date: 2/9/2026 8:03:27 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Updatestats with fullscan', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXEC sp_MSForEachTable ''UPDATE STATISTICS ? WITH FULLSCAN;''', 
		@database_name=N'Nueclear', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Index Rebuild - SyncDB]    Script Date: 2/9/2026 8:03:28 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:28 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Index Rebuild - SyncDB', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s1]    Script Date: 2/9/2026 8:03:28 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXECUTE dbo.IndexOptimize

@Databases = ''SyncDB'',

@FragmentationLow = NULL,

@FragmentationMedium = ''INDEX_REORGANIZE,INDEX_REBUILD_ONLINE,INDEX_REBUILD_OFFLINE'',
@FragmentationHigh = ''INDEX_REBUILD_ONLINE,INDEX_REBUILD_OFFLINE'',
@FragmentationLevel1 = 10,
@FragmentationLevel2 = 30,
@LogToTable = ''Y'',
@SortInTempdb = ''Y''

----------Last modified by kalaimani 11_04_2024 added sortin temp db option', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [SyncDB]    Script Date: 2/9/2026 8:03:28 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'SyncDB', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'sp_updatestats;', 
		@database_name=N'SyncDB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Index Rebuild - Thyrocare DB]    Script Date: 2/9/2026 8:03:28 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:28 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Index Rebuild - Thyrocare DB', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This Job will rebuild the indexes for Thyrocare database whose fragmentation percentage is >30%, except WO_DTL & WO_HDR tables.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:28 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=4, 
		@on_success_step_id=2, 
		@on_fail_action=4, 
		@on_fail_step_id=2, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXECUTE dbo.IndexOptimize

@Databases = ''Thyrocare'',

@FragmentationLow = NULL,

@FragmentationMedium = NULL,
@FragmentationHigh = ''INDEX_REBUILD_ONLINE,INDEX_REBUILD_OFFLINE'',
@FragmentationLevel1 = 10,
@FragmentationLevel2 = 30,
@Indexes = ''ALL_INDEXES, -Thyrocare.dbo.WO_DTL, -Thyrocare.dbo.WO_HDR, -Thyrocare.dbo.NEW_TESTS_MASTER'',
@LogToTable = ''Y'',
@SortInTempdb = ''Y''

----------Last modified by kalaimani 11_04_2024 added sortin temp db option', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [thyrocare statistics update]    Script Date: 2/9/2026 8:03:28 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'thyrocare statistics update', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SET NOCOUNT ON
    GO

    --Determine if you want to execute the script with FULLSCAN
    DECLARE @WithFullscan BIT
    SELECT  @WithFullscan = 0

    -------------------
    --Begin script
    -------------------

    DECLARE @StartTime DATETIME

    SELECT  @StartTime = GETDATE()

    IF OBJECT_ID(''tempdb..#TablesToUpdateStats'') IS NOT NULL 
        BEGIN
            DROP TABLE #TablesToUpdateStats
        END

    DECLARE @NumTables VARCHAR(20)

    SELECT  s.[Name] AS SchemaName
          , t.[name] AS TableName
          , SUM(p.rows) AS RowsInTable
    INTO    #TablesToUpdateStats
    FROM    sys.schemas s
            LEFT JOIN sys.tables t
                ON s.schema_id = t.schema_id
            LEFT JOIN sys.partitions p
                ON t.object_id = p.object_id
            LEFT JOIN sys.allocation_units a
                ON p.partition_id = a.container_id
    WHERE   p.index_id IN ( 0, 1 ) -- 0 heap table , 1 table with clustered index
            AND p.rows IS NOT NULL
            AND a.type = 1  -- row-data only , not LOB
    GROUP BY s.[Name]
          , t.[name]
    SELECT  @NumTables = @@ROWCOUNT

    DECLARE updatestats CURSOR
    FOR
        SELECT  ROW_NUMBER() OVER ( ORDER BY ttus.RowsInTable )
              , ttus.SchemaName
              , ttus.TableName
              , ttus.RowsInTable
        FROM    #TablesToUpdateStats AS ttus
        ORDER BY ttus.RowsInTable
    OPEN updatestats

    DECLARE @TableNumber VARCHAR(20)
    DECLARE @SchemaName NVARCHAR(128)
    DECLARE @tableName NVARCHAR(128)
    DECLARE @RowsInTable VARCHAR(20)
    DECLARE @Statement NVARCHAR(300)
    DECLARE @Status NVARCHAR(300)
    DECLARE @FullScanSQL VARCHAR(20)

    IF @WithFullscan = 1 
        BEGIN
            SELECT  @FullScanSQL = '' WITH FULLSCAN''
        END
    ELSE 
        BEGIN --If @WithFullscan<>1 then set @FullScanSQL to empty string
            SELECT  @FullScanSQL = ''''
        END

    FETCH NEXT FROM updatestats INTO @TableNumber, @SchemaName, @tablename,
        @RowsInTable
    WHILE ( @@FETCH_STATUS = 0 ) 
        BEGIN

            SET @Statement = ''UPDATE STATISTICS ['' + @SchemaName + ''].[''
                + @tablename + '']'' + @FullScanSQL

            SET @Status = ''Table '' + @TableNumber + '' of '' + @NumTables
                + '': Running '''''' + @Statement + '''''' ('' + @RowsInTable
                + '' rows)''
            RAISERROR (@Status, 0, 1) WITH NOWAIT  --RAISERROR used to immediately output status

            EXEC sp_executesql @Statement

            FETCH NEXT FROM updatestats INTO @TableNumber, @SchemaName,
                @tablename, @RowsInTable
        END

    CLOSE updatestats
    DEALLOCATE updatestats

    DROP TABLE #TablesToUpdateStats

    PRINT ''Total Elapsed Time: '' + CONVERT(VARCHAR(100), DATEDIFF(minute,@StartTime,GETDATE())) + '' minutes''
                                                             
   GO', 
		@database_name=N'Thyrocare', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Index Rebuild - Thyrocare DB - WO_DTL]    Script Date: 2/9/2026 8:03:28 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:28 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Index Rebuild - Thyrocare DB - WO_DTL', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This job will rebuild all the indexes in the Thyrocare database of  table WO_DTL if fragmentation level is >30%.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Thyrocare.dbo.WO_DTL]    Script Date: 2/9/2026 8:03:28 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Thyrocare.dbo.WO_DTL', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXECUTE dbo.IndexOptimize

@Databases = ''Thyrocare'',

@FragmentationLow = NULL,

@FragmentationMedium = NULL,

@FragmentationHigh = ''INDEX_REBUILD_OFFLINE'',

@FragmentationLevel1 = 5,

@FragmentationLevel2 = 30,

@Indexes = ''Thyrocare.dbo.WO_DTL'',
@LogToTable = ''Y'',
@SortInTempdb = ''Y''

----------Last modified by kalaimani 11_04_2024 added sortin temp db option', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [DBA Index Rebuild - Thyrocare DB - WO_HDR]    Script Date: 2/9/2026 8:03:28 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'DBA Index Rebuild - Thyrocare DB - WO_HDR', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'exec msdb.dbo.sp_start_job @job_name = ''DBA Index Rebuild - Thyrocare DB - WO_HDR''
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Index Rebuild - Thyrocare DB - WO_HDR]    Script Date: 2/9/2026 8:03:28 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:28 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Index Rebuild - Thyrocare DB - WO_HDR', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This Job will rebuild the indexes in Thyrocare database of WO_HDR table whose fragmenation level is >30%.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Thyrocare.dbo.WO_HDR]    Script Date: 2/9/2026 8:03:28 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Thyrocare.dbo.WO_HDR', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--EXECUTE dbo.IndexOptimize

--@Databases = ''Thyrocare'',

--@FragmentationLow = NULL,

--@FragmentationMedium = NULL,

--@FragmentationHigh = ''INDEX_REBUILD_OFFLINE'',

--@FragmentationLevel1 = 5,

--@FragmentationLevel2 = 30,

--@Indexes = ''Thyrocare.dbo.WO_HDR'',
--@LogToTable = ''Y'',
--@SortInTempdb = ''Y''

----------Last modified by kalaimani 11_04_2024 added sortin temp db option', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Index_Reorganize_NEW_TESTS_MASTER and WO_HDR]    Script Date: 2/9/2026 8:03:28 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Index_Reorganize_NEW_TESTS_MASTER and WO_HDR', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXECUTE dbo.IndexOptimize
@Databases = ''Thyrocare'',
@Indexes = ''Thyrocare.dbo.WO_HDR, Thyrocare.dbo.NEW_TESTS_MASTER'',
@FragmentationLow = ''INDEX_REORGANIZE'',
@FragmentationMedium = ''INDEX_REORGANIZE'',
@FragmentationHigh = ''INDEX_REBUILD_OFFLINE'',
@FragmentationLevel1 = 5,
@FragmentationLevel2 = 30,
@LogToTable = ''Y'',
@SortInTempdb = ''Y'';', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [DBA Index Rebuild - Thyrocare DB]    Script Date: 2/9/2026 8:03:28 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'DBA Index Rebuild - Thyrocare DB', 
		@step_id=3, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'exec msdb.dbo.sp_start_job @job_name = ''DBA Index Rebuild - Thyrocare DB''
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA JOB to find client ipaddress]    Script Date: 2/9/2026 8:03:28 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:28 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA JOB to find client ipaddress', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [collect logs]    Script Date: 2/9/2026 8:03:28 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'collect logs', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--CREATE TABLE SessionLogs (
--    LogID INT IDENTITY(1,1) PRIMARY KEY, -- Unique identifier for each log entry
--    SessionID INT,
--    HostName NVARCHAR(128),
--    ProgramName NVARCHAR(256),
--    LoginName NVARCHAR(128),
--    ClientIPAddress NVARCHAR(45), -- Supports IPv6
--    ServerIPAddress NVARCHAR(45), -- Supports IPv6
--    ConnectionStartTime DATETIME,
--    SessionStatus NVARCHAR(50),
--    CPUTime INT,
--    MemoryUsage INT,
--    LogTimestamp DATETIME DEFAULT GETDATE() -- Timestamp when the entry is logged
--);


INSERT INTO DBADB..SessionLogs (
    SessionID,
    HostName,
    ProgramName,
    LoginName,
    ClientIPAddress,
    ServerIPAddress,
    ConnectionStartTime,
    SessionStatus,
    CPUTime,
    MemoryUsage
)
SELECT 
    s.session_id AS SessionID,
    s.host_name AS HostName,
    s.program_name AS ProgramName,
    s.login_name AS LoginName,
    c.client_net_address AS ClientIPAddress,
    c.local_net_address AS ServerIPAddress,
    c.connect_time AS ConnectionStartTime,
    s.status AS SessionStatus,
    s.cpu_time AS CPUTime,
    s.memory_usage AS MemoryUsage
FROM sys.dm_exec_sessions s
JOIN sys.dm_exec_connections c
    ON s.session_id = c.session_id
WHERE s.is_user_process = 1 -- Exclude system sessions;', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'every 2 mins', 
		@enabled=0, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=2, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250114, 
		@active_end_date=20250116, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'83ed1e1f-531d-4a10-9d53-bd90fa39597a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Longruning Query alert]    Script Date: 2/9/2026 8:03:28 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]    Script Date: 2/9/2026 8:03:28 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Longruning Query alert', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:28 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @TABLE TABLE (
	[Instance_Name] [varchar](100) NULL,
	[Start_Time] [datetime] NULL,
	[SPID] [int] NULL,
	[User_Names] [varchar](300) NULL,
	[ServerName] [varchar](100) NULL,
	[Database_Names] [varchar](300) NULL,
	[Executing_Sql] [nvarchar](max) NULL,
	[wait_type] [varchar](300) NULL,
	[wait_time_Minutes] [decimal](10, 2) NULL
)
insert into  @TABLE
SELECT (select @@servicename)as Instance_Name,r.start_time [Start Time],
r.session_ID [SPID], c.login_name as User_Name,c.host_name as Server,
DB_NAME(r.database_id) [Database],
t.text as [Executing SQL],wait_type,cast(cast (wait_time/1000 as decimal(10,2))/60 as decimal(10,2))as wait_time
FROM sys.dm_exec_requests r OUTER APPLY sys.dm_exec_sql_text(sql_handle) t inner join sys.dm_exec_sessions c on 
r.session_id =c.session_id
WHERE r.session_id != @@SPID and r.session_id > 50 and wait_time>180000

--insert into  DBADB.dbo.LongRunningQueries
--SELECT Instance_Name,Start_Time,SPID,User_Names,ServerName,Database_Names,Executing_Sql,wait_type,wait_time_Minutes from @TABLE

SET NOCOUNT ON
DECLARE  @xml nvarchar(max)
SELECT @xml = Cast((SELECT Instance_Name AS ''td'',
'''',
Start_Time AS ''td'',
'''',
SPID AS ''td'',
'''',
User_Names AS ''td'',
'''',
ServerName AS ''td'',
'''',
Database_Names AS ''td'',
'''',
SUBSTRING(Executing_Sql,1,100) AS ''td'',
'''',
wait_type AS ''td'',
'''',
wait_time_Minutes AS ''td''
FROM @TABLE
FOR xml path(''tr''), elements) AS NVARCHAR(max))
Declare @body nvarchar(max)
SET @body =
''<html>
	<head>
		<style>
			table, th, td 
			{
				border: 1px solid black;
				border-collapse: collapse;
				text-align: center;
			}
		</style>
	</head>
	<body>
		<H2>
		Long Running Quries: 192.168.0.30
		</H2>
		<table> 
			<tr>
				<th> Instance Name </th> <th> Start_Time </th> <th> SPID</th> <th> User_Names </th>
				<th> Host Name </th> <th> Database_Names </th> <th> Executing_Sql</th> <th> wait_type </th><th> wait_time_Minutes </th>
			</tr>''
			SET @body = @body + @xml + ''
		</table>
	</body>
</html>''
if(@xml is not null)
BEGIN
EXEC msdb.dbo.Sp_send_dbmail
@profile_name = ''DBA'',
@body = @body,
@body_format =''html'',
@recipients = ''mssqlsupport@geopits.com'',
--@copy_recipients ='''',
@blind_copy_recipients='''',
@subject = ''Long Running Quries:192.168.0.30'';
END
SET NOCOUNT OFF
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=10, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20230209, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'0c0854fa-e62e-40a9-839a-249ce63f2ed6'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Send Block report]    Script Date: 2/9/2026 8:03:28 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:28 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Send Block report', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'to send blocking report more than 2 min', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'Aswin-4248E', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [execute the sp]    Script Date: 2/9/2026 8:03:28 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'execute the sp', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'exec sp_BlockingDetectionAlert', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'every one minitue execute', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250714, 
		@active_end_date=99991231, 
		@active_start_time=300, 
		@active_end_time=235959, 
		@schedule_uid=N'aee7d758-87ed-4a8b-9125-9a8c1a34d74b'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA SQL LOGIN EXPIRY]    Script Date: 2/9/2026 8:03:28 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:28 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA SQL LOGIN EXPIRY', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'SQL Logins  Password Expiration Enabled List', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [SQL Logins  Password Expiration Enabled]    Script Date: 2/9/2026 8:03:28 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'SQL Logins  Password Expiration Enabled', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SET NOCOUNT ON;

SET QUOTED_IDENTIFIER ON;

DECLARE @Count INT;

-- Check data availability
SELECT @Count = COUNT(*)
FROM sys.sql_logins
WHERE is_expiration_checked = 1;

IF @Count = 0
BEGIN
    PRINT ''No logins found. Email not triggered.'';
    RETURN;
END;

---------------------------------------------
-- If rows exist, generate stylish HTML mail
---------------------------------------------

DECLARE @HTML NVARCHAR(MAX);

SET @HTML = 
N'' <div style="font-family: Segoe UI, Arial; padding:20px;">
      <h2 style="color:#0d47a1; margin-bottom:10px;"> SQL Logins  Password Expiration Enabled</h2>
      <div style="background:#ffffff; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1);">

      <table style="border-collapse: collapse; width:100%; font-size:14px; border-radius:12px; overflow:hidden;">
          <thead>
              <tr style="background: linear-gradient(90deg, #1565c0, #1e88e5); color:white;">
                  <th style="padding:12px; text-align:left;">Login Name</th>
                  <th style="padding:12px; text-align:left;">Create Date</th>
                  <th style="padding:12px; text-align:left;">Modify Date</th>
                  <th style="padding:12px; text-align:left;">Policy Checked</th>
                  <th style="padding:12px; text-align:left;">Expiration Checked</th>
              </tr>
          </thead>
          <tbody>'' +

(
    SELECT 
        N''<tr style="background:'' +
        CASE WHEN ROW_NUMBER() OVER (ORDER BY name) % 2 = 0 
             THEN ''#f1f5f9'' 
             ELSE ''#ffffff'' END + 
        ''; border-bottom:1px solid #e2e8f0;">'' +

        N''<td style="padding:10px;">'' + name + N''</td>'' +
        N''<td style="padding:10px;">'' + CONVERT(NVARCHAR(20), create_date, 120) + N''</td>'' +
        N''<td style="padding:10px;">'' + CONVERT(NVARCHAR(20), modify_date, 120) + N''</td>'' +
        N''<td style="padding:10px;">'' + CAST(is_policy_checked AS NVARCHAR(5)) + N''</td>'' +
        N''<td style="padding:10px;">'' + CAST(is_expiration_checked AS NVARCHAR(5)) + N''</td>'' +
        N''</tr>''
    FROM sys.sql_logins
    WHERE is_expiration_checked = 1
    FOR XML PATH(''''), TYPE
).value(''.'', ''NVARCHAR(MAX)'') +

N''</tbody>
      </table>
      </div>
  </div>'';

EXEC msdb.dbo.sp_send_dbmail
    @profile_name = ''DBA'',
    @recipients   = ''sivaramakrishnan.a@thyrocare.com;aswin.kumarvpkothuru@thyrocare.com'',
    @subject      = ''SQL Login Expiry For Charbi Server'',
    @body         = @HTML,
    @body_format  = ''HTML'';', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20251201, 
		@active_end_date=99991231, 
		@active_start_time=10000, 
		@active_end_time=235959, 
		@schedule_uid=N'705a6640-130b-4213-9ac6-04f1908d9382'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Table size details]    Script Date: 2/9/2026 8:03:28 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:28 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Table size details', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=2, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits', 
		@notify_email_operator_name=N'geopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SET DEADLOCK_PRIORITY HIGH;
GO


insert into DBADB.dbo.TableSizeData
exec sp_MSforeachdb ''USE [?]

SELECT
db_id(),
db_name(),
    t.NAME AS TableName,
    s.Name AS SchemaName,
    p.rows,
    SUM(a.total_pages) * 8 AS TotalSpaceKB, 
    CAST(ROUND(((SUM(a.total_pages) * 8) / 1024.00), 2) AS NUMERIC(36, 2)) AS TotalSpaceMB,
    SUM(a.used_pages) * 8 AS UsedSpaceKB, 
    CAST(ROUND(((SUM(a.used_pages) * 8) / 1024.00), 2) AS NUMERIC(36, 2)) AS UsedSpaceMB, 
    (SUM(a.total_pages) - SUM(a.used_pages)) * 8 AS UnusedSpaceKB,
    CAST(ROUND(((SUM(a.total_pages) - SUM(a.used_pages)) * 8) / 1024.00, 2) AS NUMERIC(36, 2)) AS UnusedSpaceMB,
	getdate()
FROM 
    sys.tables (Nolock) t
INNER JOIN      
    sys.indexes(nolock) i ON t.OBJECT_ID = i.object_id
INNER JOIN 
    sys.partitions(nolock) p ON i.object_id = p.OBJECT_ID AND i.index_id = p.index_id
INNER JOIN 
    sys.allocation_units(nolock) a ON p.partition_id = a.container_id
LEFT OUTER JOIN 
    sys.schemas(nolock) s ON t.schema_id = s.schema_id
WHERE 
    t.NAME NOT LIKE ''''dt%'''' 
    AND t.is_ms_shipped = 0
    AND i.OBJECT_ID > 255 
GROUP BY 
    t.Name, s.Name, p.Rows
ORDER BY 
    TotalSpaceMB DESC, t.Name''', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20230228, 
		@active_end_date=99991231, 
		@active_start_time=10000, 
		@active_end_time=235959, 
		@schedule_uid=N'10889eb5-adff-4a03-bc2e-660cec232b9e'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA UnusedIndex Report]    Script Date: 2/9/2026 8:03:29 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:29 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA UnusedIndex Report', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s1]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @subjectcontent NVARCHAR(512);
DECLARE @ServerName NVARCHAR(512);

SET @ServerName = @@servername;--Change if required
SET @subjectcontent = ''Thyrocare '' + @ServerName + '' Unused Index Report '' + FORMAT(GETDATE(), ''yyyy-MM-dd HH:mm'');--Change

EXEC dbadb.dbo.DBAUnusedIndexReport 
    @subjectcontent = @subjectcontent,
    @ServerName = @ServerName,
    @Recipient = ''mssqlsupport@geopits.com'', --Change
    @DBProfile = ''DBA'';', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'daily6pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250127, 
		@active_end_date=99991231, 
		@active_start_time=180000, 
		@active_end_time=235959, 
		@schedule_uid=N'ef1654c5-4823-4e11-b9c3-704ea20afc4a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Wait Stat Collection]    Script Date: 2/9/2026 8:03:29 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:29 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Wait Stat Collection', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Data_Collection]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Data_Collection', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE DBADB
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
GO

WITH [Waits] AS
(
	SELECT	[wait_type],
			[wait_time_ms] / 1000.0 AS [WaitS],
			([wait_time_ms] - [signal_wait_time_ms]) / 1000.0 AS [ResourceS],
			[signal_wait_time_ms] / 1000.0 AS [SignalS],
			[waiting_tasks_count] AS [WaitCount],
			100.0 * [wait_time_ms] / SUM ([wait_time_ms]) OVER() AS [Percentage],
			ROW_NUMBER() OVER(ORDER BY [wait_time_ms] DESC) AS [RowNum]
    FROM	sys.dm_os_wait_stats
    WHERE	[wait_type] NOT IN
	(
		N''BROKER_EVENTHANDLER'',         N''BROKER_RECEIVE_WAITFOR'',
		N''BROKER_TASK_STOP'',            N''BROKER_TO_FLUSH'',
		N''BROKER_TRANSMITTER'',          N''CHECKPOINT_QUEUE'',
		N''CHKPT'',                       N''CLR_AUTO_EVENT'',
		N''CLR_MANUAL_EVENT'',            N''CLR_SEMAPHORE'',
		N''DBMIRROR_DBM_EVENT'',          N''DBMIRROR_EVENTS_QUEUE'',
		N''DBMIRROR_WORKER_QUEUE'',       N''DBMIRRORING_CMD'',
		N''DIRTY_PAGE_POLL'',             N''DISPATCHER_QUEUE_SEMAPHORE'',
		N''EXECSYNC'',                    N''FSAGENT'',
		N''FT_IFTS_SCHEDULER_IDLE_WAIT'', N''FT_IFTSHC_MUTEX'',
		N''HADR_CLUSAPI_CALL'',           N''HADR_FILESTREAM_IOMGR_IOCOMPLETION'',
		N''HADR_LOGCAPTURE_WAIT'',        N''HADR_NOTIFICATION_DEQUEUE'',
		N''HADR_TIMER_TASK'',             N''HADR_WORK_QUEUE'',
		N''KSOURCE_WAKEUP'',              N''LAZYWRITER_SLEEP'',
		N''LOGMGR_QUEUE'',                N''ONDEMAND_TASK_QUEUE'',
		N''PWAIT_ALL_COMPONENTS_INITIALIZED'',
		N''QDS_PERSIST_TASK_MAIN_LOOP_SLEEP'',
		N''QDS_CLEANUP_STALE_QUERIES_TASK_MAIN_LOOP_SLEEP'',
		N''REQUEST_FOR_DEADLOCK_SEARCH'', N''RESOURCE_QUEUE'',
		N''SERVER_IDLE_CHECK'',           N''SLEEP_BPOOL_FLUSH'',
		N''SLEEP_DBSTARTUP'',             N''SLEEP_DCOMSTARTUP'',
		N''SLEEP_MASTERDBREADY'',         N''SLEEP_MASTERMDREADY'',
		N''SLEEP_MASTERUPGRADED'',        N''SLEEP_MSDBSTARTUP'',
		N''SLEEP_SYSTEMTASK'',            N''SLEEP_TASK'',
		N''SLEEP_TEMPDBSTARTUP'',         N''SNI_HTTP_ACCEPT'',
		N''SP_SERVER_DIAGNOSTICS_SLEEP'', N''SQLTRACE_BUFFER_FLUSH'',
		N''SQLTRACE_INCREMENTAL_FLUSH_SLEEP'',
		N''SQLTRACE_WAIT_ENTRIES'',       N''WAIT_FOR_RESULTS'',
		N''WAITFOR'',                     N''WAITFOR_TASKSHUTDOWN'',
		N''WAIT_XTP_HOST_WAIT'',          N''WAIT_XTP_OFFLINE_CKPT_NEW_LOG'',
		N''WAIT_XTP_CKPT_CLOSE'',         N''XE_DISPATCHER_JOIN'',
		N''XE_DISPATCHER_WAIT'',          N''XE_TIMER_EVENT'',
		N''QDS_SHUTDOWN_QUEUE'')
	AND	waiting_tasks_count > 0
	)
	INSERT into DBADB.[dbo].[WaitStatData] 
	SELECT MAX ([W1].[wait_type]) AS [WaitType],
		CAST (MAX ([W1].[WaitS]) AS DECIMAL (16,2)) AS [Wait_S],
		--CAST (MAX ([W1].[ResourceS]) AS DECIMAL (16,2)) AS [Resource_S],
		CAST (MAX ([W1].[SignalS]) AS DECIMAL (16,2)) AS [Signal_S],
		MAX ([W1].[WaitCount]) AS [WaitCount],
		CAST (MAX ([W1].[Percentage]) AS DECIMAL (5,2)) AS [Percentage],
		CAST ((MAX ([W1].[WaitS]) / MAX ([W1].[WaitCount])) AS DECIMAL (16,4)) AS [AvgWait_S],
		--CAST ((MAX ([W1].[ResourceS]) / MAX ([W1].[WaitCount])) AS DECIMAL (16,4)) AS [AvgRes_S],
		--CAST ((MAX ([W1].[SignalS]) / MAX ([W1].[WaitCount])) AS DECIMAL (16,4)) AS [AvgSig_S],
		--''http://documentation.red-gate.com/display/SM4/'' + W1.wait_type AS [DocumentLink],
		Getdate()
FROM	[Waits] AS [W1] INNER JOIN [Waits] AS [W2]
		ON ([W2].[RowNum] <= [W1].[RowNum])
GROUP BY
		[W1].[RowNum],
		W1.wait_type
HAVING	SUM ([W2].[Percentage]) - MAX ([W1].[Percentage]) < 99.9;
GO
DBCC SQLPERF("sys.dm_os_wait_stats",CLEAR);
go
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
GO
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Every_1Hour', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20251229, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'6dd0a346-db48-4cef-bec2-a5c2ebf1efb8'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_ Update statistics on charbi,thyrocare,syncDB,charbiLTCdata,Nueclear]    Script Date: 2/9/2026 8:03:29 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:29 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_ Update statistics on charbi,thyrocare,syncDB,charbiLTCdata,Nueclear', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Update statistics on charbi]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Update statistics on charbi', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXECUTE dbo.IndexOptimize
@Databases = ''Charbi'',
@FragmentationLow = NULL,
@FragmentationMedium = NULL,
@FragmentationHigh = NULL,
@UpdateStatistics = ''ALL''', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Update statistics on Thyrocare]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Update statistics on Thyrocare', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXECUTE dbo.IndexOptimize
@Databases = ''Thyrocare'',
@FragmentationLow = NULL,
@FragmentationMedium = NULL,
@FragmentationHigh = NULL,
@UpdateStatistics = ''ALL''', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Update statistics on syncDB]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Update statistics on syncDB', 
		@step_id=3, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXECUTE dbo.IndexOptimize
@Databases = ''SyncDB'',
@FragmentationLow = NULL,
@FragmentationMedium = NULL,
@FragmentationHigh = NULL,
@UpdateStatistics = ''ALL''', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Update statistics on CharbiLTCData]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Update statistics on CharbiLTCData', 
		@step_id=4, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXECUTE dbo.IndexOptimize
@Databases = ''CharbiLTCData'',
@FragmentationLow = NULL,
@FragmentationMedium = NULL,
@FragmentationHigh = NULL,
@UpdateStatistics = ''ALL''', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Update statistics on Nueclear]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Update statistics on Nueclear', 
		@step_id=5, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXECUTE dbo.IndexOptimize
@Databases = ''Nueclear'',
@FragmentationLow = NULL,
@FragmentationMedium = NULL,
@FragmentationHigh = NULL,
@UpdateStatistics = ''ALL''', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=95, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20231102, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'f7a4ed19-698f-40cb-90a1-98719aa92b0f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Auto_Kill_Long_Running_iisuser_90_Minutes]    Script Date: 2/9/2026 8:03:29 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:29 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Auto_Kill_Long_Running_iisuser_90_Minutes', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Auto_Kill]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Auto_Kill', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @session_id INT;
DECLARE @kill_cmd NVARCHAR(100);

DECLARE cur CURSOR FAST_FORWARD FOR
SELECT 
    DISTINCT s.session_id
        		
    FROM sys.dm_exec_sessions s
    LEFT JOIN sys.dm_exec_requests r ON s.session_id = r.session_id
    LEFT JOIN sys.dm_exec_connections c ON s.session_id = c.session_id
	left join sys.dm_exec_cached_plans cp on r.plan_handle=cp.plan_handle
    OUTER APPLY sys.dm_exec_sql_text(
        CASE 
            WHEN r.sql_handle IS NOT NULL THEN r.sql_handle
            ELSE c.most_recent_sql_handle
        END
    ) AS st
    WHERE s.session_id>50
	and cp.objtype=''Adhoc''  
	AND st.objectid is null
    AND s.is_user_process = 1
    AND s.session_id <> @@SPID
    AND r.command=''SELECT''
    AND s.login_name =''iisuser''  -- Change the username on the based on server login name
    AND (
        -- Running or sleeping more than 90 mins 
        DATEDIFF(MINUTE, s.last_request_end_time, GETDATE()) >= 90
        
    );

OPEN cur;
FETCH NEXT FROM cur INTO @session_id;

WHILE @@FETCH_STATUS = 0
BEGIN
    INSERT INTO dbadb.dbo.KilledSessionsLog (
        SessionID, LoginName, HostName, ProgramName, Status, LastRequestEndTime, LoginTime, SqlText, ObjectName, WaitType, DatabaseName, OpenTranCount
    )
    SELECT 
        s.session_id,
        s.login_name,
        s.host_name,
        s.program_name,
        s.status,
        s.last_request_end_time,
        s.login_time,
        st.text AS SqlText,
        COALESCE(
            QUOTENAME(DB_NAME(st.dbid)) + N''.'' + 
            QUOTENAME(OBJECT_SCHEMA_NAME(st.objectid, st.dbid)) + N''.'' + 
            QUOTENAME(OBJECT_NAME(st.objectid, st.dbid)), 
            ''Query''
        ) AS ObjectName,
        r.wait_type,
        DB_NAME(s.database_id) AS DatabaseName,
        s.open_transaction_count
    FROM sys.dm_exec_sessions s
    LEFT JOIN sys.dm_exec_requests r ON s.session_id = r.session_id
    LEFT JOIN sys.dm_exec_connections c ON s.session_id = c.session_id
    OUTER APPLY sys.dm_exec_sql_text(
        CASE 
            WHEN r.sql_handle IS NOT NULL THEN r.sql_handle
            ELSE c.most_recent_sql_handle
        END
    ) AS st
    WHERE s.session_id = @session_id;

    PRINT ''Killing session: '' + CAST(@session_id AS VARCHAR(10));

    SET @kill_cmd = ''KILL '' + CAST(@session_id AS VARCHAR(10));
    EXEC sp_executesql @kill_cmd;

    FETCH NEXT FROM cur INTO @session_id;
END

CLOSE cur;
DEALLOCATE cur;
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Every_5_Minutes', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=5, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250805, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'598a149d-362f-4fdc-9c46-271b4cf55ce6'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Auto_Killed_SELECT_Queries_Report]    Script Date: 2/9/2026 8:03:29 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:29 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Auto_Killed_SELECT_Queries_Report', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Report]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Report', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @sql TABLE(
    SessionID INT,
    LoginName NVARCHAR(128),
    HostName NVARCHAR(128),
    ProgramName NVARCHAR(128),
    Status NVARCHAR(30),
    LastRequestEndTime DATETIME,
    LoginTime DATETIME,
    SqlText NVARCHAR(MAX),
    ObjectName NVARCHAR(512),
    WaitType NVARCHAR(60),
    DatabaseName NVARCHAR(128),
    OpenTranCount INT NULL
);

-- Insert yesterday''s killed session details
INSERT INTO @sql
SELECT  [SessionID],
        [LoginName],
        [HostName],
        [ProgramName],
        [Status],
        [LastRequestEndTime],
        [LoginTime],
        [SqlText],
        [ObjectName],
        [WaitType],
        [DatabaseName],
        [OpenTranCount]
FROM [DBADB].[dbo].[KilledSessionsLog]
WHERE CAST(LastRequestEndTime AS date) = CAST(GETDATE() - 1 AS date);

-- Variables for email
SET NOCOUNT ON;
DECLARE @xml NVARCHAR(MAX),
        @body NVARCHAR(MAX),
        @ServerName NVARCHAR(128) = @@SERVERNAME,
        @ReportDate NVARCHAR(20) = CONVERT(VARCHAR(10), GETDATE()-1, 105), -- dd-mm-yyyy
        @subject NVARCHAR(200);

IF EXISTS (SELECT 1 FROM @sql)
BEGIN
    -- Convert result to HTML rows
    SELECT @xml = CAST(( 
        SELECT  SessionID AS ''td'','''',
                LoginName AS ''td'','''',
                HostName AS ''td'','''',
                ProgramName AS ''td'','''',
                Status AS ''td'','''',
                LastRequestEndTime AS ''td'','''',
                LoginTime AS ''td'','''',
                SqlText AS ''td'','''',
                ObjectName AS ''td'','''',
                WaitType AS ''td'','''',
                DatabaseName AS ''td'','''',
                OpenTranCount AS ''td'',''''
        FROM @sql
        FOR XML PATH(''tr''), ELEMENTS
    ) AS NVARCHAR(MAX));

    SET @body = 
    ''<html>
        <head>
            <style>
                table, th, td { border: 1px solid #ddd; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th { background-color: #008bff; color: white; }
                th, td { padding: 12px; text-align: center; }
                tr:nth-child(even) { background-color: #f2f2f2; }
                h2 { color: #007bff; }
            </style>
        </head>
        <body>
            <H2>Automatic Killed SELECT Queries (Login: iisuser, Duration > 90 Minutes)</H2>
            <p>Report Date: ''+@ReportDate+'' | Server: ''+@ServerName+''</p>
            <table>
                <tr>
                    <th>SessionID</th><th>LoginName</th><th>HostName</th><th>ProgramName</th>
                    <th>Status</th><th>LastRequestEndTime</th><th>LoginTime</th>
                    <th>SqlText</th><th>ObjectName</th><th>WaitType</th>
                    <th>DatabaseName</th><th>OpenTranCount</th>
                </tr>'' 
                + @xml +
            ''</table>
        </body>
    </html>'';

    SET @subject = ''Killed SELECT Queries (Login: iisuser >90 Min) - '' 
                    + @ServerName + '' - '' + @ReportDate;

    -- Send email only if data exists
    EXEC msdb.dbo.sp_send_dbmail
        @profile_name = ''DBA'',
        @body = @body,
        @body_format =''HTML'',
		@recipients = ''aswin.kumarvpkothuru@thyrocare.com;nikhil@pharmeasy.in;ankit.g@pharmeasy.in;rajesh.n@pharmeasy.in;pushparaj.j@pharmeasy.in'',
        @subject = @subject;
END
ELSE 
PRINT(''Skipping the Mail'')', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'EveryDay_12_AM', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250806, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'd4cfeab2-b20a-4cd6-8cd4-a081fcd8b496'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_BWR_Extraction]    Script Date: 2/9/2026 8:03:29 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]    Script Date: 2/9/2026 8:03:29 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_BWR_Extraction', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE [DBADB];

 
DECLARE @data_extract_query Report_Data_Query;
 
INSERT INTO @data_extract_query
VALUES
(''cpu_usage'', ''
            SELECT
                [Time],
                [IdleCPU] AS [Idle_CPU],
                [SQLUtilisedCPU] AS [SQL Utilised CPU],
                [Otherprosses] AS [Other Processes]
            FROM [DBADB].[dbo].[CPUUtilisationdata]
            WHERE [Time] >= DATEADD(DAY, -15, GETDATE())''),
(''peak_cpu_usage'', ''
            SELECT TOP 10
                [Time],
                [IdleCPU] AS [Idle_CPU],
                [SQLUtilisedCPU] AS [SQL Utilised CPU],
                [Otherprosses] AS [Other Processes]
            FROM [DBADB].[dbo].[CPUUtilisationdata]
            WHERE [Time] >= DATEADD(DAY, -15, GETDATE())
            ORDER BY SQLUtilisedCPU DESC''),
(''user_connection_insights'', ''
            SELECT
                [CaptureDate] AS [Time],
                [Value] AS [Transactions]
            FROM [DBADB].[dbo].[PerfMonData]
            WHERE CaptureDate >= DATEADD(DAY, -15, GETDATE())
                AND Counter = ''''SQLServer:General Statistics:User Connections:''''''),
(''peak_user_connection_insights'', ''SELECT TOP 10
                [CaptureDate] AS [Time],
                [Value] AS [Transactions]
            FROM [DBADB].[dbo].[PerfMonData]
            WHERE CaptureDate >= DATEADD(DAY, -15, GETDATE())
                AND Counter = ''''SQLServer:General Statistics:User Connections:''''
            ORDER BY Value DESC''),
(''row_count'', ''
SELECT 
DBNAME, 
TableName, 
(SELECT TOP 1 rows FROM [DBADB].[dbo].[TableSizeData] 
	WHERE TableName = TSD.TableName 
	-- AND DBNAME NOT IN ()
	AND DBNAME = TSD.DBNAME 
	AND Date = DATEADD(day, -15, TSD.Date)) AS [15 Days before Row Count],
TSD.rows AS [Current RowCount],
TotalSpaceMB
FROM [DBADB].[dbo].[TableSizeData] TSD
WHERE Date = (SELECT MAX(Date) FROM [DBADB].[dbo].[TableSizeData])
AND DBNAME NOT LIKE ''''CHARBI2%''''  
ORDER BY TotalSpaceMB DESC
OFFSET 0 ROWS FETCH NEXT 10 ROWS ONLY'' ),
(''db_sizes'', ''
            SELECT
                a.Instance_Name AS [Instance Name],
                a.Database_Names AS [Database Name],
                b.size2 AS [15 Days before DB size (MB)],
                a.size1 AS [Current size (MB)],
                CAST(CAST(((a.size1 - b.size2)/b.size2 * 100) AS DECIMAL(6,2)) AS VARCHAR(100)) AS [Difference]
            FROM (
                SELECT
                    Database_Names,
                    Instance_Name,
                    [Size MB] AS size1
                FROM DBADB.dbo.DB_Meta
                WHERE Dates = CAST(GETDATE()-1 AS DATE)) AS a INNER JOIN (
                    SELECT
                        Database_Names,
                        Instance_Name,
                        [Size MB] AS size2
                    FROM DBADB.dbo.DB_Meta
                    WHERE Dates = CAST(GETDATE()-15 AS DATE)) AS b
                ON a.Database_Names = b.Database_Names
                    AND a.Instance_Name = b.Instance_Name
            WHERE a.Database_Names NOT IN (''''master'''',''''model'''',''''msdb'''',''''DBADB'''',''''ReportServer'''',''''ReportServerTempDB'''') and a.Database_Names NOT LIKE ''''CHARBI2%''''
            ORDER BY a.Instance_Name''),
(''peak_table_usage'', ''SELECT top 10 @@SERVERNAME as [Instance Name],
a.DBNAME AS [Database Name],
a.Tablename [Table Name] ,
b.size2 AS [15 days before size (MB)] ,
a.size1 AS [Current size (MB)] ,
cast(cast(((a.size1 - b.size2)/b.size2 * 100) as decimal(18,2)) as varchar(100)) AS [Difference in %]
FROM (SELECT top 20 DBName,tablename,sum(TotalSpaceMB) as size1  from [DBADB].[dbo].[TableSizeData]
where  Date=cast(GETDATE()-1 as date) group by DBName,tablename order by sum(TotalSpaceMB) desc ) as a
inner join
(SELECT top 20 DBName ,tableName ,sum(TotalSpaceMB) as size2 from [DBADB].[dbo].[TableSizeData]  where Date=cast(GETDATE()-14 as date)
group by DBName,tablename order by sum(TotalSpaceMB) desc  ) as b
on  a.DBName=b.DBName
where a.DBName not in (''''master'''',''''model'''',''''distribution'''',''''DBADB'''',''''ReportServer'''',''''ReportServerTempDB'''') and a.DBName not like ''''CHARBI2%'''' and a.TableName=b.TableName
order by size2 desc''),
(''maintenance_plan_status'', ''
        
SELECT 
    @@SERVERNAME AS [Instance Name],
    JobName AS [Job Name],
    CASE 
        WHEN run_status = 1 THEN ''''Succeeded''''
        WHEN run_status = 0 THEN ''''Failed''''
        WHEN run_status = 3 THEN ''''Cancelled''''
        WHEN run_status = 2 THEN ''''Running''''
        ELSE ''''Unknown''''
    END AS [Job Status],
    CONVERT(CHAR(10), 
        CONVERT(DATETIME, 
            STUFF(STUFF(CAST(run_date AS CHAR(8)), 5, 0, ''''-''''), 8, 0, ''''-'''') + '''' '''' +
            STUFF(STUFF(RIGHT(''''000000'''' + CAST(run_time AS VARCHAR(6)), 6), 3, 0, '''':''''), 6, 0, '''':'''')
        ), 120
    ) AS [Last Completion Date]
FROM 
(
    SELECT 
        jobs.name AS JobName,
        jobhistory.run_status,
        jobhistory.run_date,
        jobhistory.run_time,
        jobhistory.run_duration,
        ROW_NUMBER() OVER (PARTITION BY jobs.name ORDER BY jobhistory.run_date DESC, jobhistory.run_time DESC) AS RowNum
    FROM msdb.dbo.sysjobs jobs
    JOIN msdb.dbo.sysjobhistory jobhistory 
        ON jobs.job_id = jobhistory.job_id
    WHERE jobs.name IN (
        ''''DBA Index Rebuild - CarbiLTCData'''',
        ''''DBA Index Rebuild - Charbi DB'''',
        ''''DBA Index Rebuild - Nueclear'''',
        ''''DBA Index Rebuild - SyncDB'''',
        ''''DBA Index Rebuild - Thyrocare DB'''',
        ''''DBA Index Rebuild - Thyrocare DB - WO_DTL'''',
        ''''DBA Index Rebuild - Thyrocare DB - WO_HDR'''',
		''''DBA_ Update statistics on charbi,thyrocare,syncDB,charbiLTCdata,Nueclear''''
    )
    AND jobhistory.step_id = 0 
) AS LastJobRun
WHERE RowNum = 1
        '');
 
 

 
EXEC [dbadb].[dbo].[report_aut_send_extracted_data]
    @company_name = ''thyrocare'',
    @extraction_queries = @data_extract_query,
    @profile_name=''DBA'',
    @recipients=''dccagent@geopits.com''
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Tuesday7AM', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=5, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20250506, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'0ac5aa3b-c804-46e3-8369-47698e64bf88'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Disk_Space_Alert_GEOPITS]    Script Date: 2/9/2026 8:03:29 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:29 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Disk_Space_Alert_GEOPITS', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'IF OBJECT_ID(''tempdb..#output'') IS NOT NULL 
    DROP TABLE #output;

DECLARE @profile VARCHAR(100) = ''DBA'';
DECLARE @recipient VARCHAR(MAX) = ''mssqlalerts@geopits.com'';
DECLARE @cc VARCHAR(MAX) = '''';
DECLARE @bcc VARCHAR(MAX) = '''';
DECLARE @body NVARCHAR(MAX);
DECLARE @sub VARCHAR(100) = ''Disk Space Alert '' + (SELECT @@SERVERNAME) + '': '' + (SELECT CONVERT(VARCHAR, GETDATE(), 107)) + '''';
DECLARE @new TABLE (
    drivename VARCHAR(10),
    [capacity(GB)] VARCHAR(100),
    [freespace(GB)] VARCHAR(100),
    [Used %] VARCHAR(100)
);
declare @new1 TABLE(
	DatabaseName varchar(100), 
	[Filename] varchar(500), 
	[File Size(GB)] decimal(12,2), 
	[Used Size(GB)] decimal(12,2), 
	[Free Size(GB)] decimal(12,2)
);

INSERT INTO @new
SELECT DISTINCT 
    vs.volume_mount_point AS drivename,
    CONVERT(DECIMAL(18, 2), vs.total_bytes / 1073741824.0) AS [capacity(GB)],
    CONVERT(DECIMAL(18, 2), vs.available_bytes / 1073741824.0) AS [freespace(GB)],
    CONVERT(DECIMAL(18, 2), (vs.total_bytes - vs.available_bytes) * 1.0 / vs.total_bytes * 100) AS [Used %]
FROM sys.master_files AS f WITH (NOLOCK)
CROSS APPLY sys.dm_os_volume_stats(f.database_id, f.[file_id]) AS vs
ORDER BY vs.volume_mount_point
OPTION (RECOMPILE);

insert into @new1 exec sp_MsForeachdb ''use ?
select name, filename,
convert(decimal(12,2),round(a.size/128.000/1024,2)) as filesizeGB,
convert(decimal(12,2),round(fileproperty(a.name,''''SpaceUsed'''')/128.000/1024,2)) as SpaceUsedGB,
convert(decimal(12,2),round((a.size - fileproperty(a.name,''''SpaceUsed''''))/128.000/1024,2)) as FreeSpaceGB
from dbo.sysfiles a''

SET NOCOUNT ON;
DECLARE @xml NVARCHAR(MAX);
DECLARE @xml1 NVARCHAR(MAX);
SELECT @xml = CAST((SELECT 
    drivename AS ''td'', '''',
    [capacity(GB)] AS ''td'', '''',
    [freespace(GB)] AS ''td'', '''',
    [Used %] AS ''td''
FROM @new 
WHERE ([Used %] > 90.00 AND drivename <> ''D:\'') -- Alert for all drives above 90%
   OR ([Used %] > 95.00 AND drivename = ''D:\'')  -- Alert only if D:\ exceeds 95%
FOR XML PATH(''tr''), ELEMENTS) AS NVARCHAR(MAX));

SELECT @xml1 = CAST((SELECT 
	DatabaseName AS ''td'', '''',
	Filename AS ''td'', '''',
	[File Size(GB)] AS ''td'', '''',
	[Used Size(GB)] AS ''td'', '''',
	[Free Size(GB)] AS ''td''
FROM @new1 WHERE SUBSTRING(filename,1,3) in
(SELECT DISTINCT vs.volume_mount_point AS drivename
FROM sys.master_files AS f WITH (NOLOCK)
CROSS APPLY sys.dm_os_volume_stats(f.database_id, f.[file_id]) AS vs
WHERE CONVERT(DECIMAL(18, 2), (vs.total_bytes - vs.available_bytes) * 1.0 / vs.total_bytes * 100) > 90)
AND [Free Size(GB)] > 5 ORDER BY [Free Size(GB)] desc
FOR XML PATH(''tr''), ELEMENTS) AS NVARCHAR(MAX));

SET @body = 
''<html>
    <head>
        <style>
            table, th, td {
                border: 1px solid black;
                border-collapse: collapse;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <H2>Low Disk Space Alert: '' + @@SERVERNAME + ''</H2>
        <table>
            <tr>
                <th>Drive Name</th>
                <th>Total Size (GB)</th>
                <th>Free Space (GB)</th>
                <th>Used %</th>
            </tr>'' + @xml + ''
        </table>
		<br\>
		<H2> Database files to be shrinked </H2>
        <table>
            <tr>
                <th>Database name</th>
				<th>File name</th>
                <th>File Size (GB)</th>
                <th>Used Space (GB)</th>
                <th>Free Space (GB)</th>
            </tr>'' + @xml1 + ''
        </table>
    </body>
</html>'';

IF (@xml IS NOT NULL)
BEGIN
    EXEC msdb.dbo.Sp_send_dbmail
        @profile_name = @profile,
        @body = @body,
        @body_format = ''html'',
        @recipients = @recipient,
        @copy_recipients = @cc,
        @blind_copy_recipients = @bcc,
        @subject = @sub;
END;

SET NOCOUNT OFF;', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=3, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250111, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'6987d69b-07a6-48df-bc2b-ae470af3c219'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_GeoPITS_Blocking_Alerts]    Script Date: 2/9/2026 8:03:29 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:29 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_GeoPITS_Blocking_Alerts', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s1]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SET ANSI_NULLS, QUOTED_IDENTIFIER ON;

IF OBJECT_ID(''tempdb..#BlockingInfo'') IS NOT NULL DROP TABLE #BlockingInfo;
IF OBJECT_ID(''tempdb..#BlockingInfo1'') IS NOT NULL DROP TABLE #BlockingInfo1;

-- Create the temporary tables
CREATE TABLE #BlockingInfo (
    head_blocker_session_id INT,
    blocking_queries_count INT,
    head_blocker_query NVARCHAR(max));

IF OBJECT_ID(''dbadb..BlockedQueriesInfo'') IS NULL

CREATE TABLE dbadb..BlockedQueriesInfo (
    ServerName NVARCHAR(100),
    BlockedSessionID INT,
    StartTime DATETIME,
    WaitingInMinutes FLOAT,
    WaitType NVARCHAR(50),
    BlockingSessionID INT,
    QueryWaiting NVARCHAR(max),
	logdate datetime default getdate()
);

IF OBJECT_ID(''dbadb..HeadBlockingInfo'') IS NULL
CREATE TABLE dbadb..HeadBlockingInfo (
     host_name NVARCHAR(100),
	login_name NVARCHAR(100),
	duration NVARCHAR(100),
	head_blocker_session_id INT,
    blocking_queries_count INT,
    head_blocker_query NVARCHAR(max),
	logdate datetime default getdate()
,is_closed tinyint DEFAULT 0);

INSERT INTO dbadb..BlockedQueriesInfo (ServerName, BlockedSessionID, StartTime, WaitingInMinutes, WaitType, BlockingSessionID, QueryWaiting)
SELECT 
    DISTINCT @@SERVERNAME AS [Server Name], 
    b.session_id AS [Blocked Session ID], 
    r.start_time, 
    (b.wait_duration_ms / 1000) / 60 AS [Waiting in Minutes],
    b.wait_type AS [Wait Type], 
    b.blocking_session_id AS [Blocking Session ID], 
    t.[text] AS [Query Waiting to Execute]
FROM 
    sys.dm_os_waiting_tasks b 
INNER JOIN 
    sys.dm_exec_requests r ON r.session_id = b.session_id and r.session_id>50
OUTER APPLY 
    sys.dm_exec_sql_text(r.sql_handle) t 
WHERE 
    b.blocking_session_id <> 0 and b.blocking_session_id <>b.session_id ;

-- Insert data into #BlockingInfo
WITH cteHead AS (
    SELECT 
        sess.session_id, 
        req.request_id, 
        LEFT(ISNULL(req.wait_type, ''''), 50) AS wait_type,
        LEFT(ISNULL(req.wait_resource, ''''), 40) AS wait_resource, 
        LEFT(req.last_wait_type, 50) AS last_wait_type,
        sess.is_user_process, 
        req.cpu_time AS request_cpu_time, 
        req.logical_reads AS request_logical_reads,
        req.reads AS request_reads, 
        req.writes AS request_writes, 
        req.wait_time, 
        req.blocking_session_id,
        sess.memory_usage,
        sess.cpu_time AS session_cpu_time, 
        sess.reads AS session_reads, 
        sess.writes AS session_writes, 
        sess.logical_reads AS session_logical_reads,
        CONVERT(decimal(5,2), req.percent_complete) AS percent_complete, 
        req.estimated_completion_time AS est_completion_time,
        req.start_time AS request_start_time, 
        LEFT(req.status, 15) AS request_status, 
        req.command,
        req.plan_handle, 
        req.sql_handle, 
        req.statement_start_offset, 
        req.statement_end_offset, 
        conn.most_recent_sql_handle,
        LEFT(sess.status, 15) AS session_status, 
        sess.group_id, 
        req.query_hash, 
        req.query_plan_hash
    FROM sys.dm_exec_sessions AS sess
    LEFT OUTER JOIN sys.dm_exec_requests AS req 
        ON sess.session_id = req.session_id and req.session_id>50
    LEFT OUTER JOIN sys.dm_exec_connections AS conn 
        ON conn.session_id = sess.session_id and conn.session_id>50
		   

),
cteBlockingHierarchy AS (
    SELECT 
        head.session_id AS head_blocker_session_id, 
        head.session_id AS session_id, 
        head.blocking_session_id,
        head.wait_type, 
        head.wait_time, 
        head.wait_resource, 
        head.statement_start_offset, 
        head.statement_end_offset,
        head.plan_handle, 
        head.sql_handle, 
        head.most_recent_sql_handle, 
        0 AS Level
    FROM cteHead AS head
    WHERE (head.blocking_session_id IS NULL OR head.blocking_session_id = 0)
    AND head.session_id IN (SELECT DISTINCT blocking_session_id FROM cteHead WHERE blocking_session_id != 0)
    UNION ALL
    SELECT 
        h.head_blocker_session_id, 
        blocked.session_id, 
        blocked.blocking_session_id, 
        blocked.wait_type,
        blocked.wait_time, 
        blocked.wait_resource, 
        h.statement_start_offset, 
        h.statement_end_offset,                                                                                                                                                                                                                                                                               
        h.plan_handle, 
        h.sql_handle, 
        h.most_recent_sql_handle, 
        [Level] + 1
    FROM cteHead AS blocked
    INNER JOIN cteBlockingHierarchy AS h 
        ON h.session_id = blocked.blocking_session_id 
        AND h.session_id != blocked.session_id -- Avoid infinite recursion for latch type of blocking
    WHERE h.wait_type COLLATE Latin1_General_BIN NOT IN (''EXCHANGE'', ''CXPACKET'') 
        OR h.wait_type IS NULL and blocked.wait_time/60000>5 and h.head_blocker_session_id>50
)
INSERT INTO #BlockingInfo (head_blocker_session_id, blocking_queries_count, head_blocker_query)
SELECT 
    bh.head_blocker_session_id,
    COUNT(bh.session_id)  AS blocking_queries_count,
    txt.text AS head_blocker_query
	

FROM cteBlockingHierarchy AS bh
OUTER APPLY sys.dm_exec_sql_text(ISNULL(bh.sql_handle, bh.most_recent_sql_handle)) AS txt
where bh.head_blocker_session_id<>bh.session_id
GROUP BY bh.head_blocker_session_id, txt.text;

 -- select * from #BlockingInfo

CREATE TABLE #BlockingInfo1 (
    session_id INT,
    host_name NVARCHAR(100),
	login_name NVARCHAR(100),
	);

insert into #BlockingInfo1(session_id,host_name,login_name)
SELECT s.session_id, s.host_name,s.login_name
FROM sys.dm_exec_sessions s 
LEFT OUTER JOIN sys.dm_exec_requests r on r.session_id = s.session_id
OUTER APPLY sys.dm_exec_sql_text (r.sql_handle) t
OUTER APPLY sys.dm_exec_input_buffer(s.session_id, NULL) AS ib
WHERE s.session_id in   (select head_blocker_session_id from #BlockingInfo) 
ORDER BY   r.blocking_session_id desc, r.session_id

insert  into dbadb..HeadBlockingInfo(head_blocker_session_id ,blocking_queries_count , head_blocker_query,host_name ,login_name ,duration )
SELECT 
    s.head_blocker_session_id, 
    s.blocking_queries_count, 
    s.head_blocker_query,
    t.host_name, 
    t.login_name,    
    CONVERT(VARCHAR, DATEADD(SECOND, DATEDIFF(SECOND, MAX(ses.last_request_start_time), GETDATE()), 0), 108) AS duration
FROM 
    #BlockingInfo s 
INNER JOIN 
    #BlockingInfo1 t ON s.head_blocker_session_id = t.session_id and s.head_blocker_query is not null and s.head_blocker_session_id>50
INNER JOIN 
    sys.dm_exec_sessions ses ON t.session_id = ses.session_id
	
GROUP BY 
    s.head_blocker_session_id, 
    s.blocking_queries_count, 
    s.head_blocker_query, 
    t.host_name, 
    t.login_name
	HAVING 
    DATEDIFF(SECOND, MAX(ses.last_request_start_time), GETDATE()) > 300
	order by duration desc;

SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;
GO', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s2]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's2', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SET ANSI_NULLS, QUOTED_IDENTIFIER ON;

-- Step 3: Generate HTML content from the blocking table
DECLARE @HTML NVARCHAR(MAX);
DECLARE @ServerName NVARCHAR(128);
SET @ServerName = (Select @@SERVERNAME);

DECLARE @Subject NVARCHAR(256);
SET @subject = N''Thyrocare '' + @@ServerName + '' - Blocking Queries -> Open''; --Change 1


-- Initialize HTML
SET @HTML = ''<html>'' +
''<head>'' +
''<style>'' +
''body { font-family: Arial, sans-serif; color: #333; line-height: 1.6; background-color: white; padding: 20px; }'' +
''table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #ffffff; }'' +  
''table, th, td { border: 1px solid #ddd; }'' +
''th, td { padding: 12px; text-align: left; }'' +
''th { background-color: #008080; color: white; }'' +
''tr:nth-child(even) { background-color: #f2f2f2; }'' +
''tr:hover { background-color: #e9ecef; }'' +
''p { margin: 0 0 10px; }'' +
''</style>'' +
''</head>'' +
''<body>'' +
''<p>Hello Team,</p>'' +
''<p>We have detected blocking queries on the <b>'' + @ServerName + ''</b> server which are currently affecting system performance.</p>'' +
''<p><strong>Summary of Impact:</strong></p>'' +
''<ul>'';

-- Create the summary of blocking queries
DECLARE @Summary NVARCHAR(MAX);

SELECT @Summary = (
    SELECT 
        ''<li>SPID <b>'' + CAST(s.head_blocker_session_id AS NVARCHAR) + 
        ''</b> is blocking '' + CAST(s.blocking_queries_count AS NVARCHAR) + 
        '' queries and has been running for '' + 
        CONVERT(VARCHAR, DATEADD(SECOND, DATEDIFF(SECOND, MAX(ses.last_request_start_time), GETDATE()), 0), 108) + ''.</li>''
     FROM dbadb..HeadBlockingInfo s
    
    INNER JOIN sys.dm_exec_sessions ses ON s.head_blocker_session_id = ses.session_id
	 WHERE DATEDIFF(SECOND, logdate, GETDATE()) < 60
    GROUP BY s.head_blocker_session_id, s.blocking_queries_count
    HAVING DATEDIFF(SECOND, MAX(ses.last_request_start_time), GETDATE()) > 300
    FOR XML PATH(''''), TYPE).value(''.'', ''NVARCHAR(MAX)'');

SET @HTML = @HTML + @Summary + ''</ul>'' +
''<p><strong>Overview of Blocking Queries:</strong></p>'' +
''<p>Blocking occurs when one query holds a lock on a resource required by another query, leading to delays and performance degradation.</p>'' +
''<p>Below are the details of the blocking sessions identified:</p>'' +
''<table>'' +
''<thead>'' +
''<tr>'' +
''<th>Head Blocker SPID</th>'' +
''<th>No. Queries Waiting</th>'' +
''<th>Blocking Query Text</th>'' +
''<th>Host Name</th>'' +
''<th>Login Name</th>'' +
''<th>Duration</th>'' +
''</tr>'' +
''</thead>'' +
''<tbody>'' +
(SELECT 
        ''<tr>'' +
        ''<td>'' + CAST(s.head_blocker_session_id AS NVARCHAR) + ''</td>'' +
        ''<td>'' + CAST(s.blocking_queries_count AS NVARCHAR) + ''</td>'' +
        ''<td>'' + LEFT(s.head_blocker_query, 300) + ''</td>'' +
        ''<td>'' + s.host_name + ''</td>'' +
        ''<td>'' + s.login_name + ''</td>'' +
        ''<td>'' + s.duration + ''</td>'' +
        ''</tr>''
    FROM dbadb..HeadBlockingInfo s
    WHERE DATEDIFF(SECOND, logdate, GETDATE()) < 60
	order by s.duration desc
    FOR XML PATH(''''), TYPE).value(''.'', ''NVARCHAR(MAX)'') +
''</tbody>'' +
''</table>'' +
''<p>The query has been identified as causing significant blocking issues within the database. We recommend promptly reviewing the query to assess whether terminating it is necessary to maintain optimal performance.</p>'' +
''<p>Please let us know if you would like us to proceed with terminating these queries or if youd prefer to allow them to complete their execution.</p>'' +
''<p>We are here to assist in resolving this issue.</p>'' +
''<p>Best Regards,</p>'' +
''<p>MSSQL DBA<br>GeoPITS</p>'' +  -- change 2
''</body>'' +
''</html>'';

-- Output the final HTML
--SELECT @HTML AS HTML;




if(@HTML is not null)
BEGIN
EXEC msdb.dbo.Sp_send_dbmail
@profile_name = ''DBA'',     --Change 3
@body = @HTML,
@body_format =''html'',
@recipients = ''mssqlalerts@geopits.com'',  -- change 4
--@copy_recipients ='''',
@blind_copy_recipients='''',
@subject =@Subject ;
END

 

GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s3]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's3', 
		@step_id=3, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SET ANSI_NULLS, QUOTED_IDENTIFIER ON;

-- Step 5: Generate HTML content for closed blocking statuses
DECLARE @HTML_Closed NVARCHAR(MAX) ,@Summary NVARCHAR(MAX);

SET @HTML_Closed = ''<html>'' +
''<head>'' +
''<meta charset="UTF-8">'' +
''<meta name="viewport" content="width=device-width, initial-scale=1.0">'' +
''<style>'' +
''body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; color: #333; line-height: 1.6; background-color: white; padding: 20px; margin: 0; }'' +
''header { background: #008080; padding: 10px 0; color: white; text-align: center; }'' +
''ul { list-style-type: none; padding: 0; }'' +
''ul li { margin: 10px 0; }'' +
''table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #ffffff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }'' +
''table, th, td { border: 1px solid #ddd; }'' +
''th, td { padding: 12px; text-align: left; }'' +
''th { background-color: #008000; color: white; }'' +
''tr:nth-child(even) { background-color: #f2f2f2; }'' +
''tr:hover { background-color: #e0f7fa; }'' +
''p { margin: 10px 0; }'' +
''footer { margin-top: 20px; font-size: 0.9em; color: #777; text-align: center; }'' +
''</style>'' +
''</head>'' +
''<body>'' +
''<p>Hello Team,</p>'' +
''<p>This is a notification regarding previously detected blocking queries on the <b>'' + @@ServerName + ''</b> server that have now been resolved.</p>'' +
''<p><strong>Summary of Resolved Blocking Queries:</strong></p>'' +
''<ul>'';

-- Create the summary of closed blocking queries
SELECT @Summary = (
    SELECT 
        ''<li>SPID <b>'' + CAST(s.head_blocker_session_id AS NVARCHAR) + 
        ''</b> was blocking '' + CAST(s.blocking_queries_count AS NVARCHAR) + 
        '' queries and has resolved successfully.</li>''
    FROM (
        SELECT 
            head_blocker_session_id,
            blocking_queries_count,
            ROW_NUMBER() OVER (PARTITION BY head_blocker_session_id ORDER BY duration DESC) AS rn
        FROM dbadb..HeadBlockingInfo
        WHERE is_closed = 0 AND DATEDIFF(HOUR, logdate, GETDATE()) < 2 -- Focus on open blocking session_id
    ) s
    WHERE s.rn = 1 and head_blocker_session_id not in (	select distinct blocked  from sys.sysprocesses where spid>50) -- Only get the row with the maximum duration for each SPID
    FOR XML PATH(''''), TYPE).value(''.'', ''NVARCHAR(MAX)'');

    

SET @HTML_Closed = @HTML_Closed + @Summary + ''</ul>'' +
''<p>Below are the details of the resolved blocking sessions:</p>'' +
''<table>'' +
''<thead>'' +
''<tr>'' +
''<th>Head Blocker SPID</th>'' +
''<th>No. Queries Waiting</th>'' +
''<th>Blocking Query Text</th>'' +
''<th>Host Name</th>'' +
''<th>Login Name</th>'' +
''<th>Duration</th>'' +
''</tr>'' +
''</thead>'' +
''<tbody>'' +
(SELECT 
        ''<tr>'' +
        ''<td>'' + CAST(s.head_blocker_session_id AS NVARCHAR) + ''</td>'' +
        ''<td>'' + CAST(s.blocking_queries_count AS NVARCHAR) + ''</td>'' +
        ''<td>'' + LEFT(s.head_blocker_query, 300) + ''</td>'' +
        ''<td>'' + s.host_name + ''</td>'' +
        ''<td>'' + s.login_name + ''</td>'' +
        ''<td>'' + CAST(s.duration AS NVARCHAR) + ''</td>'' + -- Cast duration to NVARCHAR
        ''</tr>''
    FROM (
        SELECT 
            head_blocker_session_id,
            blocking_queries_count,
            host_name,
            login_name,
            head_blocker_query,
            duration,
            ROW_NUMBER() OVER (PARTITION BY head_blocker_session_id ORDER BY duration DESC) AS rn
        FROM dbadb..HeadBlockingInfo
        WHERE is_closed = 0 AND DATEDIFF(HOUR, logdate, GETDATE()) < 2 -- Focus on open blocking
    ) s
	WHERE s.rn = 1 and head_blocker_session_id not in (select distinct blocked  from sys.sysprocesses where spid>50)
    
    FOR XML PATH(''''), TYPE).value(''.'', ''NVARCHAR(MAX)'') +
''</tbody>'' +
''</table>'' +
''<p>We appreciate your attention to these matters and are glad to report that performance has returned to normal.</p>'' +
''<p>If you have any questions or require further details, please do not hesitate to reach out.</p>'' +
''<p>Best Regards,</p>'' +
''<p>MSSQL DBA<br>GeoPITS</p>'' +  --Change 2
''</body>'' +
''</html>'';



-- Output the final HTML for closed queries


 UPDATE dbadb..HeadBlockingInfo
 SET is_closed = 1
 
 WHERE DATEDIFF(HOUR, logdate, GETDATE()) < 2 AND is_closed = 0 and head_blocker_session_id not in (select distinct blocked  from sys.sysprocesses where spid>50); 

DECLARE @subject NVARCHAR(256);

 SET @subject = N''Thyrocare '' + @@ServerName + '' - Blocking Queries -> Closed''; --Change 1
IF (@HTML_Closed IS NOT NULL)
BEGIN
EXEC msdb.dbo.sp_send_dbmail
@profile_name = ''DBA'',     -- Change 3
@body = @HTML_Closed,
@body_format = ''html'',
@recipients = ''mssqlalerts@geopits.com'', -- change 4
 @subject =@subject
END

go
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Blockingalert', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=5, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20240921, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'73092bd6-858a-4015-ad48-b01a86da5b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_GeoPITS_Job_failure]    Script Date: 2/9/2026 8:03:29 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:29 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_GeoPITS_Job_failure', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Collect]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Collect', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE DBADB;
GO
SET NOCOUNT ON;
IF OBJECT_ID(''tempdb..#job_failure'', ''U'') IS NOT NULL
        DROP TABLE #job_failure;
IF OBJECT_ID(''tempdb..#job_step_failure'', ''U'') IS NOT NULL
  DROP TABLE #job_step_failure;
IF OBJECT_ID(''tempdb..#error_messages'', ''U'') IS NOT NULL
  DROP TABLE #error_messages;


	DECLARE  @minutes_to_monitor SMALLINT = 14400;
-- NEW CTE: Extract error messages from run_status = 4 (Log Shipping detailed errors)
-- These contain the full error messages that correspond to run_status = 0 failures
WITH CTE_ERROR_MESSAGES AS (
    SELECT
        sysjobhistory.job_id AS sql_server_agent_job_id_guid,
        sysjobhistory.instance_id,
        CAST(sysjobhistory.run_date AS VARCHAR(MAX)) AS run_date_string,
        REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_time AS VARCHAR(MAX)))) + 
            CAST(sysjobhistory.run_time AS VARCHAR(MAX)) AS run_time_string,
        sysjobhistory.step_id,
        sysjobhistory.message AS error_message,
        sysjobhistory.run_status
    FROM msdb.dbo.sysjobhistory WITH (NOLOCK)
 inner join [DBADB].[dbo].[sql_server_agent_job] on sysjobhistory.job_id=[sql_server_agent_job].sql_server_agent_job_id_guid

    WHERE sysjobhistory.run_status = 4  -- Detailed error messages
        AND sysjobhistory.step_id > 0  -- Only step-level messages
  AND [sql_server_agent_job].job_category_name=''Log Shipping''
        AND LEN(LTRIM(RTRIM(ISNULL(sysjobhistory.message, '''')))) > 0  -- Only non-empty messages
)
SELECT 
    sql_server_agent_job_id_guid,
    instance_id,
    run_date_string,
    run_time_string,
    step_id,
    error_message,
    run_status,
    CAST(SUBSTRING(run_date_string, 5, 2) + ''/'' + 
         SUBSTRING(run_date_string, 7, 2) + ''/'' + 
         SUBSTRING(run_date_string, 1, 4) AS DATETIME) +
    CAST(STUFF(STUFF(run_time_string, 5, 0, '':''), 3, 0, '':'') AS DATETIME) AS error_datetime
INTO #error_messages
FROM CTE_ERROR_MESSAGES
WHERE CAST(SUBSTRING(run_date_string, 5, 2) + ''/'' + 
           SUBSTRING(run_date_string, 7, 2) + ''/'' + 
           SUBSTRING(run_date_string, 1, 4) AS DATETIME) +
      CAST(STUFF(STUFF(run_time_string, 5, 0, '':''), 3, 0, '':'') AS DATETIME) 
      > DATEADD(MINUTE, -1 * @minutes_to_monitor, GETDATE())
   AND error_message like ''%error%'' ;
	

	WITH JobSchedules AS (
    SELECT
        ss.schedule_id,
        ss.enabled,
        CASE ss.freq_type
            WHEN 1 THEN ''One time only''
            WHEN 4 THEN ''Daily''
            WHEN 8 THEN ''Weekly''
            WHEN 16 THEN ''Monthly''
            WHEN 32 THEN ''Monthly, Relative''
            WHEN 64 THEN ''When SQL Server Agent starts''
            WHEN 128 THEN ''When computer is idle''
            ELSE ''Other''
        END AS Frequency,
        
        -- Day Interval logic
        IIF(ss.freq_type = 32 AND ss.freq_relative_interval <> 0,
            CASE ss.freq_relative_interval
                WHEN 1 THEN ''First ''
                WHEN 2 THEN ''Second ''
                WHEN 4 THEN ''Third ''
                WHEN 8 THEN ''Fourth ''
                WHEN 16 THEN ''Last ''
            END, '''') +
        CASE ss.freq_type
            WHEN 1 THEN ''''
            WHEN 4 THEN IIF(ss.freq_interval = 1, ''Every day'', ''Every '' + CAST(ss.freq_interval AS VARCHAR(3)) + '' day(s)'')
            WHEN 8 THEN
                IIF(ss.freq_interval & 2 = 2, ''Mon '', '''') +
                IIF(ss.freq_interval & 4 = 4, ''Tue '', '''') +
                IIF(ss.freq_interval & 8 = 8, ''Wed '', '''') +
                IIF(ss.freq_interval & 16 = 16, ''Thu '', '''') +
                IIF(ss.freq_interval & 32 = 32, ''Fri '', '''') +
                IIF(ss.freq_interval & 64 = 64, ''Sat '', '''') +
                IIF(ss.freq_interval & 1 = 1, ''Sun '', '''')
            WHEN 16 THEN ''On the '' + CAST(ss.freq_interval AS VARCHAR(3)) + '' day of the month.''
            WHEN 32 THEN
                CASE ss.freq_interval
                    WHEN 1 THEN ''Sunday''
                    WHEN 2 THEN ''Monday''
                    WHEN 3 THEN ''Tuesday''
                    WHEN 4 THEN ''Wednesday''
                    WHEN 5 THEN ''Thursday''
                    WHEN 6 THEN ''Friday''
                    WHEN 7 THEN ''Saturday''
                    WHEN 8 THEN ''Day''
                    WHEN 9 THEN ''Weekday''
                    WHEN 10 THEN ''Weekend day''
                END
            ELSE ''''
        END AS DayInterval,
        IIF(
            ss.freq_type = 4 AND ss.freq_interval = 1 AND ss.freq_subday_interval = 0, 
            ''Occurs Once at '' + STUFF(STUFF(RIGHT(''00000'' + CAST(ss.active_start_time AS VARCHAR(6)), 6), 3, 0, '':''), 6, 0, '':''),
            IIF(
                ss.freq_type = 8 AND ss.freq_subday_type = 1 AND ss.freq_subday_interval = 0, 
                ''Occurs Once at '' + STUFF(STUFF(RIGHT(''00000'' + CAST(ss.active_start_time AS VARCHAR(6)), 6), 3, 0, '':''), 6, 0, '':''),
                IIF(
                    ss.freq_subday_interval <> 0,
                    CASE ss.freq_subday_type
                        WHEN 1 THEN ''Occurs Once at '' + STUFF(STUFF(RIGHT(''00000'' + CAST(ss.active_start_time AS VARCHAR(6)), 6), 3,0,'':''), 6,0,'':'')
                        WHEN 2 THEN ''Repeat every '' + CAST(ss.freq_subday_interval AS VARCHAR(3)) + '' seconds''
                        WHEN 4 THEN ''Repeat every '' + CAST(ss.freq_subday_interval AS VARCHAR(3)) + '' minutes''
                        WHEN 8 THEN ''Repeat every '' + CAST(ss.freq_subday_interval AS VARCHAR(3)) + '' hours''
                    END,
                    ''''
                )
            )
        ) AS DailyFrequency,
        
        CASE
            WHEN ss.freq_type = 8 THEN ''Repeat every '' + CAST(ss.freq_recurrence_factor AS VARCHAR(3)) + '' week(s).''
            WHEN ss.freq_type IN (16, 32) THEN ''Repeat every '' + CAST(ss.freq_recurrence_factor AS VARCHAR(3)) + '' month(s).''
            ELSE ''''
        END AS Recurrence,
        
        -- Start and End time formatting
        STUFF(STUFF(RIGHT(''00000'' + CAST(ss.active_start_time AS VARCHAR(6)), 6), 3, 0, '':''), 6, 0, '':'') AS StartTime,
        STUFF(STUFF(RIGHT(''00000'' + CAST(ss.active_end_time AS VARCHAR(6)), 6), 3, 0, '':''), 6, 0, '':'') AS EndTime
    FROM msdb.dbo.sysschedules AS ss
), RankedJobSchedules AS (
    SELECT 
        ss.schedule_id,
        ss.Frequency,
        ss.DayInterval,
        ss.DailyFrequency,
        ss.StartTime,
        ss.EndTime,
        ss.enabled,
        JJS.job_id,
        ROW_NUMBER() OVER (PARTITION BY JJS.job_id ORDER BY ss.schedule_id) AS rn
    FROM JobSchedules ss
    JOIN msdb.dbo.sysjobschedules JJS ON ss.schedule_id = JJS.schedule_id
)
MERGE INTO [DBADB].[dbo].[sql_server_agent_job] AS TARGET
USING (
    SELECT
        J.job_id AS sql_server_agent_job_id_guid,
        J.name AS sql_server_agent_job_name,
        J.date_created AS job_create_datetime_utc,
        J.date_modified AS job_last_modified_datetime_utc,
        J.enabled AS is_enabled,
        0 AS is_deleted,
        LEFT(ISNULL(jc.name, ''Unknown''), 100) AS job_category_name,
        LEFT(ISNULL(SP.name, ''Unknown''), 256) AS owner_login_name,
        JS.schedule_id,
        ISNULL(JS.Frequency, '''') AS Frequency,
        ISNULL(JS.DayInterval, '''') AS DayInterval,
        ISNULL(JS.DailyFrequency, '''') AS DailyFrequency,
        ISNULL(JS.StartTime, '''') AS StartTime,
        ISNULL(JS.EndTime, '''') AS EndTime,
        ISNULL(JS.enabled, 0) AS ScheduleIsEnabled
    FROM msdb.dbo.sysjobs AS J
    LEFT JOIN sys.server_principals AS SP ON J.owner_sid = SP.sid
    LEFT JOIN msdb.dbo.sysjobschedules AS JJS ON J.job_id = JJS.job_id
    LEFT JOIN RankedJobSchedules AS JS ON JJS.schedule_id = JS.schedule_id AND JS.rn = 1  -- Ensure only one schedule per job
    LEFT JOIN msdb.dbo.syscategories AS jc ON jc.category_id = J.category_id
) AS SOURCE
ON (SOURCE.sql_server_agent_job_id_guid = TARGET.sql_server_agent_job_id_guid and SOURCE.sql_server_agent_job_name=TARGET.sql_server_agent_job_name)

-- When not matched, insert the job details
WHEN NOT MATCHED BY TARGET THEN
    INSERT (
        sql_server_agent_job_id_guid,
        sql_server_agent_job_name,
        job_create_datetime_utc,
        job_last_modified_datetime_utc,
        is_enabled,
        is_deleted,
        job_category_name,
        owner_login_name,
        Frequency,
        DayInterval,
        DailyFrequency,
        StartTime,
        EndTime,
        ScheduleIsEnabled
    )
    VALUES (
        SOURCE.sql_server_agent_job_id_guid,
        LEFT(SOURCE.sql_server_agent_job_name, 256),
        SOURCE.job_create_datetime_utc,
        SOURCE.job_last_modified_datetime_utc,
        SOURCE.is_enabled,
        SOURCE.is_deleted,
        LEFT(SOURCE.job_category_name, 100),
        LEFT(SOURCE.owner_login_name, 256),
        LEFT(SOURCE.Frequency, 4000),
        LEFT(SOURCE.DayInterval, 4000),
        LEFT(SOURCE.DailyFrequency, 4000),
        LEFT(SOURCE.StartTime, 16),
        LEFT(SOURCE.EndTime, 16),
        SOURCE.ScheduleIsEnabled
    )

-- When matched, update the existing job details if they are different
WHEN MATCHED AND (
    SOURCE.job_last_modified_datetime_utc > TARGET.job_last_modified_datetime_utc AND(
    SOURCE.Frequency <> TARGET.Frequency OR
    SOURCE.DayInterval <> TARGET.DayInterval OR
    SOURCE.DailyFrequency <> TARGET.DailyFrequency OR
    SOURCE.StartTime <> TARGET.StartTime OR
    SOURCE.EndTime <> TARGET.EndTime OR
    SOURCE.ScheduleIsEnabled <> TARGET.ScheduleIsEnabled)
) THEN
    UPDATE SET 
        sql_server_agent_job_name = LEFT(SOURCE.sql_server_agent_job_name, 256),
        job_create_datetime_utc = SOURCE.job_create_datetime_utc,
        job_last_modified_datetime_utc = SOURCE.job_last_modified_datetime_utc,
        is_enabled = SOURCE.is_enabled,
        is_deleted = SOURCE.is_deleted,
        job_category_name = LEFT(SOURCE.job_category_name, 100),
        owner_login_name = LEFT(SOURCE.owner_login_name, 256),
        Frequency = LEFT(SOURCE.Frequency, 4000),
        DayInterval = LEFT(SOURCE.DayInterval, 4000),
        DailyFrequency = LEFT(SOURCE.DailyFrequency, 4000),
        StartTime = LEFT(SOURCE.StartTime, 16),
        EndTime = LEFT(SOURCE.EndTime, 16),
        ScheduleIsEnabled = SOURCE.ScheduleIsEnabled;

	WITH CTE_NORMALIZE_DATETIME_DATA AS (
  SELECT
   sysjobhistory.job_id AS sql_server_agent_job_id_guid,
   CAST(sysjobhistory.run_date AS VARCHAR(MAX)) AS run_date_string, 
   REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_time AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_time AS VARCHAR(MAX)) AS run_time_string,
   REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_duration AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_duration AS VARCHAR(MAX)) AS run_duration_string,
   sysjobhistory.run_status,
   sysjobhistory.message,
   sysjobhistory.instance_id
  FROM msdb.dbo.sysjobhistory WITH (NOLOCK)
  WHERE sysjobhistory.run_status = 0
  AND sysjobhistory.step_id = 0),
 CTE_GENERATE_DATETIME_DATA AS (
  SELECT
   CTE_NORMALIZE_DATETIME_DATA.sql_server_agent_job_id_guid,
   CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 5, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 7, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 1, 4) AS DATETIME) +
   CAST(STUFF(STUFF(CTE_NORMALIZE_DATETIME_DATA.run_time_string, 5, 0, '':''), 3, 0, '':'') AS DATETIME) AS job_start_datetime,
   CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 1, 2) AS INT) * 3600 +
    CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 3, 2) AS INT) * 60 + 
    CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 5, 2) AS INT) AS job_duration_seconds,
   CASE CTE_NORMALIZE_DATETIME_DATA.run_status
    WHEN 0 THEN ''Failure''
    WHEN 1 THEN ''Success''
    WHEN 2 THEN ''Retry''
    WHEN 3 THEN ''Canceled''
    ELSE ''Unknown''
   END AS job_status,
   CTE_NORMALIZE_DATETIME_DATA.message,
   CTE_NORMALIZE_DATETIME_DATA.instance_id
  FROM CTE_NORMALIZE_DATETIME_DATA)
 SELECT
  CTE_GENERATE_DATETIME_DATA.sql_server_agent_job_id_guid,
  CTE_GENERATE_DATETIME_DATA.job_start_datetime AS job_start_time_utc,
  DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime) AS job_failure_time_utc,
  ISNULL(CTE_GENERATE_DATETIME_DATA.message, '''') AS job_failure_message,
  CTE_GENERATE_DATETIME_DATA.instance_id
 INTO #job_failure
 FROM CTE_GENERATE_DATETIME_DATA
 WHERE DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime) > DATEADD(MINUTE, -1 * @minutes_to_monitor, GETDATE());
 

 WITH CTE_NORMALIZE_DATETIME_DATA AS (
  SELECT
   sysjobhistory.job_id AS sql_server_agent_job_id_guid,
   CAST(sysjobhistory.run_date AS VARCHAR(MAX)) AS run_date_string, 
   REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_time AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_time AS VARCHAR(MAX)) AS run_time_string,
   REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_duration AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_duration AS VARCHAR(MAX)) AS run_duration_string,
   sysjobhistory.run_status,
   sysjobhistory.step_id,
   sysjobhistory.step_name,
   sysjobhistory.message,
   sysjobhistory.retries_attempted,
   sysjobhistory.sql_severity,
   sysjobhistory.sql_message_id,
   sysjobhistory.instance_id
  FROM msdb.dbo.sysjobhistory WITH (NOLOCK)
  WHERE sysjobhistory.run_status = 0
  AND sysjobhistory.step_id > 0 ),
 CTE_GENERATE_DATETIME_DATA AS (
  SELECT
   CTE_NORMALIZE_DATETIME_DATA.sql_server_agent_job_id_guid,
   CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 5, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 7, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 1, 4) AS DATETIME) +
   CAST(STUFF(STUFF(CTE_NORMALIZE_DATETIME_DATA.run_time_string, 5, 0, '':''), 3, 0, '':'') AS DATETIME) AS job_start_datetime,
   CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 1, 2) AS INT) * 3600 +
    CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 3, 2) AS INT) * 60 + 
    CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 5, 2) AS INT) AS job_duration_seconds,
   CASE CTE_NORMALIZE_DATETIME_DATA.run_status
    WHEN 0 THEN ''Failure''
    WHEN 1 THEN ''Success''
    WHEN 2 THEN ''Retry''
    WHEN 3 THEN ''Canceled''
    ELSE ''Unknown''
   END AS job_status,
   CTE_NORMALIZE_DATETIME_DATA.step_id,
   CTE_NORMALIZE_DATETIME_DATA.step_name,
   CTE_NORMALIZE_DATETIME_DATA.message AS job_step_failure_message,
   CTE_NORMALIZE_DATETIME_DATA.retries_attempted,
   CTE_NORMALIZE_DATETIME_DATA.sql_severity,
   CTE_NORMALIZE_DATETIME_DATA.sql_message_id,
   CTE_NORMALIZE_DATETIME_DATA.instance_id
  FROM CTE_NORMALIZE_DATETIME_DATA)
 SELECT
  CTE_GENERATE_DATETIME_DATA.sql_server_agent_job_id_guid,
  CTE_GENERATE_DATETIME_DATA.job_start_datetime AS job_start_time_utc,
  DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime) AS job_failure_time_utc,
  CTE_GENERATE_DATETIME_DATA.step_id AS job_failure_step_number,
  ISNULL(CTE_GENERATE_DATETIME_DATA.job_step_failure_message, '''') AS job_step_failure_message,
  CTE_GENERATE_DATETIME_DATA.sql_severity AS job_step_severity,
  CTE_GENERATE_DATETIME_DATA.retries_attempted,
  CTE_GENERATE_DATETIME_DATA.step_name,
  CTE_GENERATE_DATETIME_DATA.sql_message_id,
  CTE_GENERATE_DATETIME_DATA.instance_id
 INTO #job_step_failure
 FROM CTE_GENERATE_DATETIME_DATA
 WHERE CTE_GENERATE_DATETIME_DATA.sql_message_id >-1 
 AND DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime) > DATEADD(MINUTE, -1 * @minutes_to_monitor, GETDATE())
 AND CTE_GENERATE_DATETIME_DATA.instance_id NOT IN (SELECT sql_server_agent_job_failure.sql_server_agent_instance_id FROM dbo.sql_server_agent_job_failure);
 

WITH CTE_FAILURE_STEP AS (
    SELECT
        jsf.*,
        -- Get the error message that belongs to THIS specific failure run only
        (SELECT TOP 1 em.error_message
         FROM #error_messages em
         WHERE em.sql_server_agent_job_id_guid = jsf.sql_server_agent_job_id_guid
            AND em.step_id = jsf.job_failure_step_number
            AND em.instance_id < jsf.instance_id  -- Error logged BEFORE this failure
            AND em.run_date_string = CAST(YEAR(jsf.job_failure_time_utc) AS VARCHAR(4)) + 
                RIGHT(''0'' + CAST(MONTH(jsf.job_failure_time_utc) AS VARCHAR(2)), 2) + 
                RIGHT(''0'' + CAST(DAY(jsf.job_failure_time_utc) AS VARCHAR(2)), 2)
            -- CRITICAL: Ensure no other failure exists between this error and current failure
            -- This prevents picking up errors from previous job runs
            AND NOT EXISTS (
                SELECT 1 
                FROM #job_step_failure jsf2 inner join dbadb.dbo.sql_server_agent_job on sql_server_agent_job.sql_server_agent_job_id_guid=jsf2.sql_server_agent_job_id_guid
                WHERE jsf2.sql_server_agent_job_id_guid = em.sql_server_agent_job_id_guid 
                    AND jsf2.job_failure_step_number = em.step_id
                    AND jsf2.instance_id > em.instance_id  -- Another failure after the error
                    AND jsf2.instance_id < jsf.instance_id -- But before current failure
                    AND sql_server_agent_job.job_category_name=''Log Shipping''
            )
         ORDER BY em.instance_id Asc -- Get the closest error before this failure
        ) AS detailed_error_message,
        ROW_NUMBER() OVER (PARTITION BY jsf.sql_server_agent_job_id_guid, jsf.job_failure_time_utc 
                          ORDER BY jsf.job_failure_step_number DESC) AS recent_step_rank
    FROM #job_step_failure jsf
)
INSERT INTO [DBADB].dbo.sql_server_agent_job_failure
		(sql_server_agent_job_id, sql_server_agent_instance_id, job_start_time_utc, job_failure_time_utc, job_failure_step_number, job_failure_step_name,
		 job_failure_message, job_step_failure_message, job_step_severity, job_step_message_id, retries_attempted, has_email_been_sent_to_operator)
SELECT  
   
    sql_server_agent_job.sql_server_agent_job_id,
    CTE_FAILURE_STEP.instance_id,
    job_failure.job_start_time_utc,
    CTE_FAILURE_STEP.job_failure_time_utc,
    CTE_FAILURE_STEP.job_failure_step_number,
    CTE_FAILURE_STEP.step_name AS job_failure_step_name,
    job_failure.job_failure_message,
    ISNULL(CTE_FAILURE_STEP.detailed_error_message, CTE_FAILURE_STEP.job_step_failure_message) AS job_step_failure_message,
    CTE_FAILURE_STEP.job_step_severity,
    CTE_FAILURE_STEP.sql_message_id AS job_step_message_id,
    CTE_FAILURE_STEP.retries_attempted,
    0 AS has_email_been_sent_to_operator
FROM #job_failure job_failure
INNER JOIN [DBADB].dbo.sql_server_agent_job
    ON job_failure.sql_server_agent_job_id_guid = sql_server_agent_job.sql_server_agent_job_id_guid
INNER JOIN CTE_FAILURE_STEP
    ON job_failure.sql_server_agent_job_id_guid = CTE_FAILURE_STEP.sql_server_agent_job_id_guid
    AND job_failure.job_failure_time_utc = CTE_FAILURE_STEP.job_failure_time_utc
WHERE CTE_FAILURE_STEP.recent_step_rank = 1
AND CTE_FAILURE_STEP.instance_id NOT IN (SELECT sql_server_agent_job_failure.sql_server_agent_instance_id FROM dbo.sql_server_agent_job_failure)
    AND sql_server_agent_job.job_category_name <> ''Unmonitored'';


INSERT INTO [DBADB].dbo.sql_server_agent_job_failure
		(sql_server_agent_job_id, sql_server_agent_instance_id, job_start_time_utc, job_failure_time_utc, job_failure_step_number, job_failure_step_name,
		 job_failure_message, job_step_failure_message, job_step_severity, job_step_message_id, retries_attempted, has_email_been_sent_to_operator)
SELECT 
    
    sql_server_agent_job.sql_server_agent_job_id,
    job_failure.instance_id,
    job_failure.job_start_time_utc,
    job_failure.job_failure_time_utc,
    0 AS job_failure_step_number,
    '''' AS job_failure_step_name,
    job_failure.job_failure_message,
    '''' AS job_step_failure_message,
    -1 AS job_step_severity,
    -1 AS job_step_message_id,
    0 AS retries_attempted,
    0 AS has_email_been_sent_to_operator
FROM #job_failure job_failure
INNER JOIN dbo.sql_server_agent_job
    ON job_failure.sql_server_agent_job_id_guid = sql_server_agent_job.sql_server_agent_job_id_guid
WHERE sql_server_agent_job.job_category_name <> ''Unmonitored''
    AND NOT EXISTS (
        SELECT 1 
        FROM #job_step_failure job_step_failure 
        WHERE job_failure.sql_server_agent_job_id_guid = job_step_failure.sql_server_agent_job_id_guid 
            AND job_failure.job_failure_time_utc = job_step_failure.job_failure_time_utc
    )
	AND job_failure.instance_id NOT IN (SELECT sql_server_agent_job_failure.sql_server_agent_instance_id FROM dbo.sql_server_agent_job_failure);


-- INSERT 3: Step failures without job-level failure
WITH CTE_FAILURE_STEP AS (
    SELECT
        jsf.*,
        -- Get the error message that belongs to THIS specific failure run only
        (SELECT TOP 1 em.error_message
         FROM #error_messages em
         WHERE em.sql_server_agent_job_id_guid = jsf.sql_server_agent_job_id_guid
            AND em.step_id = jsf.job_failure_step_number
            AND em.instance_id < jsf.instance_id
            AND em.run_date_string = CAST(YEAR(jsf.job_failure_time_utc) AS VARCHAR(4)) + 
                RIGHT(''0'' + CAST(MONTH(jsf.job_failure_time_utc) AS VARCHAR(2)), 2) + 
                RIGHT(''0'' + CAST(DAY(jsf.job_failure_time_utc) AS VARCHAR(2)), 2)
            AND NOT EXISTS (
                SELECT 1 
                FROM #job_step_failure jsf2 
                WHERE jsf2.sql_server_agent_job_id_guid = em.sql_server_agent_job_id_guid
                    AND jsf2.job_failure_step_number = em.step_id
                    AND jsf2.instance_id > em.instance_id
                    AND jsf2.instance_id < jsf.instance_id
            )
         ORDER BY em.instance_id ASC
        ) AS detailed_error_message,
        ROW_NUMBER() OVER (PARTITION BY jsf.sql_server_agent_job_id_guid, jsf.job_failure_time_utc 
                          ORDER BY jsf.job_failure_step_number DESC) AS recent_step_rank
    FROM #job_step_failure jsf
)
INSERT INTO [DBADB].dbo.sql_server_agent_job_failure
		(sql_server_agent_job_id, sql_server_agent_instance_id, job_start_time_utc, job_failure_time_utc, job_failure_step_number, job_failure_step_name,
		 job_failure_message, job_step_failure_message, job_step_severity, job_step_message_id, retries_attempted, has_email_been_sent_to_operator)
SELECT  
     sql_server_agent_job.sql_server_agent_job_id,
    CTE_FAILURE_STEP.instance_id,
    CTE_FAILURE_STEP.job_start_time_utc,
    CTE_FAILURE_STEP.job_failure_time_utc,
    CTE_FAILURE_STEP.job_failure_step_number,
    CTE_FAILURE_STEP.step_name AS job_failure_step_name,
    '''' AS job_failure_message,
    ISNULL(CTE_FAILURE_STEP.detailed_error_message, CTE_FAILURE_STEP.job_step_failure_message) AS job_step_failure_message,
    CTE_FAILURE_STEP.job_step_severity,
    CTE_FAILURE_STEP.sql_message_id AS job_step_message_id,
    CTE_FAILURE_STEP.retries_attempted,
    0 AS has_email_been_sent_to_operator
FROM CTE_FAILURE_STEP
INNER JOIN dbo.sql_server_agent_job
    ON CTE_FAILURE_STEP.sql_server_agent_job_id_guid = sql_server_agent_job.sql_server_agent_job_id_guid
LEFT JOIN #job_failure job_failure
    ON job_failure.sql_server_agent_job_id_guid = CTE_FAILURE_STEP.sql_server_agent_job_id_guid
    AND job_failure.job_failure_time_utc = CTE_FAILURE_STEP.job_failure_time_utc
WHERE CTE_FAILURE_STEP.recent_step_rank = 1
    AND job_failure.sql_server_agent_job_id_guid IS NULL 
	AND job_failure.instance_id NOT IN (SELECT sql_server_agent_job_failure.sql_server_agent_instance_id FROM dbo.sql_server_agent_job_failure)
    AND sql_server_agent_job.job_category_name <> ''Unmonitored'';

	

	Drop table #job_failure,#job_step_failure;
	SET NOCOUNT OFF;
GO', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [open]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'open', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SET NOCOUNT ON;

DECLARE @server_name NVARCHAR(255) = @@SERVERNAME;

-- Temporary table to hold email data
DECLARE @EmailData TABLE (
    JobId NVARCHAR(255),
    JobName NVARCHAR(255),
    StepName NVARCHAR(255),
    Schedule NVARCHAR(255),
    FailureCount INT,
    FailureTimes NVARCHAR(MAX),
    FailureMessages NVARCHAR(MAX),
    FirstFailureTime DATETIME,
    LastFailureTime DATETIME,
    JobStartTime DATETIME -- Added Job Start Time column
);


	
WITH RankedFailures AS (
    SELECT 
        j.sql_server_agent_job_id,
        j.sql_server_agent_job_name,
        jf.job_failure_step_name,
        jf.job_step_failure_message,
        jf.job_failure_time_utc,
        j.Frequency,
        j.StartTime,
        j.EndTime,
        ROW_NUMBER() OVER (PARTITION BY j.sql_server_agent_job_id ORDER BY jf.job_failure_time_utc DESC) AS rn
    FROM 
        [DBADB].[dbo].[sql_server_agent_job] j
    JOIN 
        [DBADB].[dbo].[sql_server_agent_job_failure] jf ON j.sql_server_agent_job_id = jf.sql_server_agent_job_id
    WHERE 
        jf.has_email_been_sent_to_operator=0 and (ticket_status is null or ticket_status<>''Open'')  AND   jf.job_step_message_id<>-1 
)

, ScheduleCTE AS (
    SELECT 
        j.sql_server_agent_job_id,
        CASE 
            -- Handle Daily Frequency
            WHEN j.Frequency = ''Daily'' THEN 
                CASE 
                    WHEN j.DailyFrequency LIKE ''%Repeat%'' 
                    THEN ''Every day from '' + CAST(j.StartTime AS NVARCHAR(8)) + 
                         '' to '' + CAST(j.EndTime AS NVARCHAR(8)) + 
                         '', repeats every '' + 
                         NULLIF(CAST(SUBSTRING(j.DailyFrequency, CHARINDEX(''every '', j.DailyFrequency) + 6, LEN(j.DailyFrequency)) AS NVARCHAR), '''') + ''.''
                    ELSE ''Every day at '' + CAST(j.StartTime AS NVARCHAR(8)) + ''.''
                END

            -- Handle Weekly Frequency
            WHEN j.Frequency = ''Weekly'' THEN 
                ''Every '' + 
                -- Concatenate the days correctly
                REPLACE(j.DayInterval, '' '', '', '') + 
                '' starts at '' + CAST(j.StartTime AS NVARCHAR(8)) + 
                CASE 
                    WHEN j.DailyFrequency LIKE ''%Repeat%'' THEN 
                        '', repeats every '' + 
                        NULLIF(CAST(SUBSTRING(j.DailyFrequency, CHARINDEX(''every '', j.DailyFrequency) + 6, LEN(j.DailyFrequency)) AS NVARCHAR), '''') + ''.''
                    ELSE ''.'' 
                END

            -- Handle Monthly Frequency
            WHEN j.Frequency = ''Monthly'' THEN 
                ''On the '' + 
                CASE 
                    WHEN j.DayInterval LIKE ''%1%'' THEN ''1st ''
                    WHEN j.DayInterval LIKE ''%2%'' THEN ''2nd ''
                    WHEN j.DayInterval LIKE ''%3%'' THEN ''3rd ''
                    WHEN j.DayInterval LIKE ''%4%'' THEN ''4th ''
                    WHEN j.DayInterval LIKE ''%5%'' THEN ''5th ''
                    WHEN j.DayInterval LIKE ''%last%'' THEN ''Last ''
                    ELSE ''Unknown ''
                END + 
                ''day of the month at '' + CAST(j.StartTime AS NVARCHAR(8)) +
                CASE 
                    WHEN j.DailyFrequency LIKE ''%Repeat%'' THEN 
                        '', repeats every '' + 
                        NULLIF(CAST(SUBSTRING(j.DailyFrequency, CHARINDEX(''every '', j.DailyFrequency) + 6, LEN(j.DailyFrequency)) AS NVARCHAR), '''') + ''.''
                    ELSE ''.'' 
                END

            -- Default case for other frequencies
            ELSE ''Other frequency: '' + j.Frequency
        END AS Schedule
    FROM 
        [DBADB].[dbo].[sql_server_agent_job] j
)

-- Main Query to get aggregated job failure details
INSERT INTO @EmailData (JobId, JobName, StepName, Schedule, FailureCount, FailureTimes, FailureMessages, FirstFailureTime, LastFailureTime, JobStartTime)
SELECT 
    j.sql_server_agent_job_id,
    j.sql_server_agent_job_name,
    jf.job_failure_step_name,
    sc.Schedule,
    COUNT(jf.job_failure_time_utc) AS FailureCount,
    STUFF((SELECT '', '' + CONVERT(NVARCHAR, jf_inner.job_failure_time_utc, 120)
           FROM [DBADB].[dbo].[sql_server_agent_job_failure] jf_inner
           WHERE jf_inner.sql_server_agent_job_id = j.sql_server_agent_job_id
           FOR XML PATH('''')), 1, 2, '''') AS FailureTimes,
    STUFF((SELECT ''; '' + jf_inner.job_step_failure_message
           FROM RankedFailures jf_inner
           WHERE jf_inner.sql_server_agent_job_id = j.sql_server_agent_job_id AND jf_inner.rn = 1  -- Limit to the top message
           FOR XML PATH('''')), 1, 2, '''') AS FailureMessages,
    MIN(jf.job_failure_time_utc) AS FirstFailureTime,
    MAX(jf.job_failure_time_utc) AS LastFailureTime,
    MIN(jf.job_start_time_utc) AS JobStartTime -- Assuming JobStartTime is the earliest failure time
FROM 
    [DBADB].[dbo].[sql_server_agent_job] j
JOIN 
    [DBADB].[dbo].[sql_server_agent_job_failure] jf ON j.sql_server_agent_job_id = jf.sql_server_agent_job_id
JOIN 
    ScheduleCTE sc ON j.sql_server_agent_job_id = sc.sql_server_agent_job_id
WHERE 
    jf.has_email_been_sent_to_operator=0 and (ticket_status is null or ticket_status<>''Open'') AND   jf.job_step_message_id<>-1 
GROUP BY 
    j.sql_server_agent_job_id, j.sql_server_agent_job_name, jf.job_failure_step_name, sc.Schedule;

	
--select * from @EmailData;

-- Prepare email content
DECLARE @subject NVARCHAR(255),
        @body NVARCHAR(MAX),
        @JobId NVARCHAR(255),
        @JobName NVARCHAR(255),
        @StepName NVARCHAR(255),
        @Schedule NVARCHAR(255),
        @FailureCount INT,
        @FailureTimes NVARCHAR(MAX),
        @FailureMessages NVARCHAR(MAX),
        @FirstFailureTime DATETIME,
        @LastFailureTime DATETIME,
		@JobStartTime DATETIME;


DECLARE EmailCursor CURSOR FOR 
SELECT JobId, JobName, StepName,  Schedule, FailureCount, FailureTimes, FailureMessages, FirstFailureTime, LastFailureTime ,JobStartTime
FROM @EmailData;

OPEN EmailCursor;
FETCH NEXT FROM EmailCursor INTO 
    @JobId, @JobName, @StepName, @Schedule, @FailureCount, @FailureTimes, @FailureMessages, @FirstFailureTime, @LastFailureTime,@JobStartTime;

WHILE @@FETCH_STATUS = 0
BEGIN
    -- Set email subject
    SET @subject = ''Thyrocare ''+ @server_name +'' ''+@JobName + '' Failed Alert ->Open'' ;

    -- Prepare email body based on the number of failures
    IF @FailureCount > 1
    BEGIN
        -- Multiple failures HTML format
        SET @body = 
            ''<html>
            <head>
                 <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff; /* White background */
            color: #333;
        }
        h2 {
            color: #d9534f;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #ffffff; /* White table background */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #343a40; /* Dark gray for headers */
            color: #ffffff; /* White text color for headers */
        }
        tr:nth-child(even) {
            background-color: #f9f9f9; /* Light gray for even rows */
        }
        tr:hover {
            background-color: #f1f1f1; /* Hover effect for rows */
        }
        p {
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
            </head>
            <body>
                <h2>Job Failure Alert</h2>
                <table>
                    <tr><th>Job Name</th><td>'' + @JobName + ''</td></tr>
                    <tr><th>Step Name</th><td>'' + ISNULL(@StepName, ''N/A'') + ''</td></tr>
                    <tr><th>Error Messages</th><td>'' + ISNULL(@FailureMessages, ''N/A'') + ''</td></tr>
                    <tr><th>Failure Count</th><td>'' + CAST(@FailureCount AS NVARCHAR) + ''</td></tr>
                    <tr><th>First Start Time</th><td>'' + CONVERT(NVARCHAR, @JobStartTime, 120) + ''</td></tr>
                    <tr><th>First Failure Time</th><td>'' + CONVERT(NVARCHAR, @FirstFailureTime, 120) + ''</td></tr>
                    <tr><th>Last Failure Time</th><td>'' + CONVERT(NVARCHAR, @LastFailureTime, 120) + ''</td></tr>
                    <tr><th>Schedule</th><td>'' + @Schedule + ''</td></tr>
                </table>
            </body>
            </html>'';
    END
    ELSE
    BEGIN
        -- Single failure HTML format
        SET @body = 
            ''<html>
            <head>
                 <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff; /* White background */
            color: #333;
        }
        h2 {
            color: #d9534f;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #ffffff; /* White table background */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #343a40; /* Dark gray for headers */
            color: #ffffff; /* White text color for headers */
        }
        tr:nth-child(even) {
            background-color: #f9f9f9; /* Light gray for even rows */
        }
        tr:hover {
            background-color: #f1f1f1; /* Hover effect for rows */
        }
        p {
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
            </head>
            <body>
                <h2>Job Failure Alert</h2>
                <table>
                    <tr><th>Job Name</th><td>'' + @JobName + ''</td></tr>
                    <tr><th>Step Name</th><td>'' + ISNULL(@StepName, ''N/A'') + ''</td></tr>
                    <tr><th>Error Message</th><td>'' + ISNULL(@FailureMessages, ''N/A'') + ''</td></tr>
                    <tr><th>Job Start Time</th><td>'' + CONVERT(NVARCHAR, @JobStartTime, 120) + ''</td></tr>
                    <tr><th>Failure Time</th><td>'' + CONVERT(NVARCHAR, @LastFailureTime, 120) + ''</td></tr>
                    <tr><th>Schedule</th><td>'' + @Schedule + ''</td></tr>
                </table>
            </body>
            </html>'';
    END

    -- Send the email
	--select @body;
   EXEC msdb.dbo.sp_send_dbmail
        @profile_name = ''DBA'', -- Update with current server DB mail profile
        @recipients = ''mssqlalerts@geopits.com'', -- add if additional Id''ds
        @subject = @subject,
        @body = @body,
        @body_format = ''HTML'';
		
	UPDATE [DBADB].[dbo].[sql_server_agent_job_failure]
   SET 
       has_email_been_sent_to_operator = 1,
       ticket_status = ''Open''
   WHERE sql_server_agent_job_id = @JobId and has_email_been_sent_to_operator =0;

    FETCH NEXT FROM EmailCursor INTO 
        @JobId, @JobName, @StepName,  @Schedule, @FailureCount, @FailureTimes, @FailureMessages, @FirstFailureTime, @LastFailureTime,@JobStartTime;
END

CLOSE EmailCursor;
DEALLOCATE EmailCursor;
SET NOCOUNT OFF;', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Close]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Close', 
		@step_id=3, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SET NOCOUNT ON;
IF OBJECT_ID(''tempdb..#job_success'', ''U'') IS NOT NULL
        DROP TABLE #job_success;
		IF OBJECT_ID(''tempdb..#job_step_success'', ''U'') IS NOT NULL
		DROP TABLE #job_step_success;

DECLARE @server_name NVARCHAR(255) = @@SERVERNAME;
DECLARE @minutes_to_monitor SMALLINT = 480;
-- Temporary table to hold email data
DECLARE @EmailData TABLE (
    JobId NVARCHAR(255),
    JobName NVARCHAR(255),
    StepName NVARCHAR(255),
    Schedule NVARCHAR(255),
    LastSuccessTime NVARCHAR(MAX),
    SuccessMessages NVARCHAR(MAX),
    LastFailureTime DATETIME,
    JobStartTime DATETIME -- Added Job Start Time column
);
WITH CTE_NORMALIZE_DATETIME_DATA AS (
		SELECT
			sysjobhistory.job_id AS sql_server_agent_job_id_guid,
			CAST(sysjobhistory.run_date AS VARCHAR(MAX)) AS run_date_string, 
			REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_time AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_time AS VARCHAR(MAX)) AS run_time_string,
			REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_duration AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_duration AS VARCHAR(MAX)) AS run_duration_string,
			sysjobhistory.run_status,
			sysjobhistory.message,
			sysjobhistory.instance_id
		FROM msdb.dbo.sysjobhistory WITH (NOLOCK)
		WHERE sysjobhistory.run_status = 1
		AND sysjobhistory.step_id = 0),
	CTE_GENERATE_DATETIME_DATA AS (
		SELECT
			CTE_NORMALIZE_DATETIME_DATA.sql_server_agent_job_id_guid,
			CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 5, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 7, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 1, 4) AS DATETIME) +
			CAST(STUFF(STUFF(CTE_NORMALIZE_DATETIME_DATA.run_time_string, 5, 0, '':''), 3, 0, '':'') AS DATETIME) AS job_start_datetime,
			CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 1, 2) AS INT) * 3600 +
				CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 3, 2) AS INT) * 60 + 
				CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 5, 2) AS INT) AS job_duration_seconds,
			CASE CTE_NORMALIZE_DATETIME_DATA.run_status
				WHEN 0 THEN ''Failure''
				WHEN 1 THEN ''Success''
				WHEN 2 THEN ''Retry''
				WHEN 3 THEN ''Canceled''
				ELSE ''Unknown''
			END AS job_status,
			CTE_NORMALIZE_DATETIME_DATA.message,
			CTE_NORMALIZE_DATETIME_DATA.instance_id
		FROM CTE_NORMALIZE_DATETIME_DATA)
	SELECT
		CTE_GENERATE_DATETIME_DATA.sql_server_agent_job_id_guid,
		( CTE_GENERATE_DATETIME_DATA.job_start_datetime) AS job_start_time_utc,
		( DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime)) AS job_Success_time_utc
		
		INTO #job_success
	FROM CTE_GENERATE_DATETIME_DATA
	WHERE ( DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime)) > DATEADD(MINUTE, -1 * @minutes_to_monitor, getdate());
	WITH CTE_NORMALIZE_DATETIME_DATA AS (
		SELECT
			sysjobhistory.job_id AS sql_server_agent_job_id_guid,
			CAST(sysjobhistory.run_date AS VARCHAR(MAX)) AS run_date_string, 
			REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_time AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_time AS VARCHAR(MAX)) AS run_time_string,
			REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_duration AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_duration AS VARCHAR(MAX)) AS run_duration_string,
			sysjobhistory.run_status,
			sysjobhistory.step_id,
			sysjobhistory.step_name,
			sysjobhistory.message,
			sysjobhistory.retries_attempted,
			sysjobhistory.sql_severity,
			sysjobhistory.sql_message_id,
			sysjobhistory.instance_id
		FROM msdb.dbo.sysjobhistory WITH (NOLOCK)
		WHERE sysjobhistory.run_status = 1
		AND sysjobhistory.step_id > 0 ),
	CTE_GENERATE_DATETIME_DATA AS (
		SELECT
			CTE_NORMALIZE_DATETIME_DATA.sql_server_agent_job_id_guid,
			CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 5, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 7, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 1, 4) AS DATETIME) +
			CAST(STUFF(STUFF(CTE_NORMALIZE_DATETIME_DATA.run_time_string, 5, 0, '':''), 3, 0, '':'') AS DATETIME) AS job_start_datetime,
			CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 1, 2) AS INT) * 3600 +
				CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 3, 2) AS INT) * 60 + 
				CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 5, 2) AS INT) AS job_duration_seconds,
			CASE CTE_NORMALIZE_DATETIME_DATA.run_status
				WHEN 0 THEN ''Failure''
				WHEN 1 THEN ''Success''
				WHEN 2 THEN ''Retry''
				WHEN 3 THEN ''Canceled''
				ELSE ''Unknown''
			END AS job_status,
			CTE_NORMALIZE_DATETIME_DATA.step_id,
			CTE_NORMALIZE_DATETIME_DATA.step_name,
			CTE_NORMALIZE_DATETIME_DATA.message,
			CTE_NORMALIZE_DATETIME_DATA.retries_attempted,
			CTE_NORMALIZE_DATETIME_DATA.sql_severity,
			CTE_NORMALIZE_DATETIME_DATA.sql_message_id,
			CTE_NORMALIZE_DATETIME_DATA.instance_id
		FROM CTE_NORMALIZE_DATETIME_DATA)
	SELECT
		CTE_GENERATE_DATETIME_DATA.sql_server_agent_job_id_guid,
		 CTE_GENERATE_DATETIME_DATA.job_start_datetime AS job_start_time_utc,
		DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime) AS job_success_time_utc,
		CTE_GENERATE_DATETIME_DATA.step_id AS job_failure_step_number,
		ISNULL(CTE_GENERATE_DATETIME_DATA.message, '''') AS job_step_success_message,
		CTE_GENERATE_DATETIME_DATA.sql_severity AS job_step_severity,
		CTE_GENERATE_DATETIME_DATA.retries_attempted,
		CTE_GENERATE_DATETIME_DATA.step_name,
		CTE_GENERATE_DATETIME_DATA.sql_message_id,
		CTE_GENERATE_DATETIME_DATA.instance_id
	INTO #job_step_success
	FROM CTE_GENERATE_DATETIME_DATA
	WHERE  DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime) > DATEADD(MINUTE, -1 * @minutes_to_monitor, getdate());
	
	WITH ScheduleCTE AS (
    SELECT 
        j.sql_server_agent_job_id,
        CASE 
            -- Handle Daily Frequency
            WHEN j.Frequency = ''Daily'' THEN 
                CASE 
                    WHEN j.DailyFrequency LIKE ''%Repeat%'' 
                    THEN ''Every day from '' + CAST(j.StartTime AS NVARCHAR(8)) + 
                         '' to '' + CAST(j.EndTime AS NVARCHAR(8)) + 
                         '', repeats every '' + 
                         NULLIF(CAST(SUBSTRING(j.DailyFrequency, CHARINDEX(''every '', j.DailyFrequency) + 6, LEN(j.DailyFrequency)) AS NVARCHAR), '''') + ''.''
                    ELSE ''Every day at '' + CAST(j.StartTime AS NVARCHAR(8)) + ''.''
                END

            -- Handle Weekly Frequency
            WHEN j.Frequency = ''Weekly'' THEN 
                ''Every '' + 
                -- Concatenate the days correctly
                REPLACE(j.DayInterval, '' '', '', '') + 
                '' starts at '' + CAST(j.StartTime AS NVARCHAR(8)) + 
                CASE 
                    WHEN j.DailyFrequency LIKE ''%Repeat%'' THEN 
                        '', repeats every '' + 
                        NULLIF(CAST(SUBSTRING(j.DailyFrequency, CHARINDEX(''every '', j.DailyFrequency) + 6, LEN(j.DailyFrequency)) AS NVARCHAR), '''') + ''.''
                    ELSE ''.'' 
                END

            -- Handle Monthly Frequency
            WHEN j.Frequency = ''Monthly'' THEN 
                ''On the '' + 
                CASE 
                    WHEN j.DayInterval LIKE ''%1%'' THEN ''1st ''
                    WHEN j.DayInterval LIKE ''%2%'' THEN ''2nd ''
                    WHEN j.DayInterval LIKE ''%3%'' THEN ''3rd ''
                    WHEN j.DayInterval LIKE ''%4%'' THEN ''4th ''
                    WHEN j.DayInterval LIKE ''%5%'' THEN ''5th ''
                    WHEN j.DayInterval LIKE ''%last%'' THEN ''Last ''
                    ELSE ''Unknown ''
                END + 
                ''day of the month at '' + CAST(j.StartTime AS NVARCHAR(8)) +
                CASE 
                    WHEN j.DailyFrequency LIKE ''%Repeat%'' THEN 
                        '', repeats every '' + 
                        NULLIF(CAST(SUBSTRING(j.DailyFrequency, CHARINDEX(''every '', j.DailyFrequency) + 6, LEN(j.DailyFrequency)) AS NVARCHAR), '''') + ''.''
                    ELSE ''.'' 
                END

            -- Default case for other frequencies
            ELSE ''Other frequency: '' + j.Frequency
        END AS Schedule
    FROM 
        [DBADB].[dbo].[sql_server_agent_job] j
)
INSERT INTO @EmailData (JobId, JobName, StepName, Schedule ,JobStartTime, SuccessMessages, LastSuccessTime , LastFailureTime)
	select j.sql_server_agent_job_id,
    j.sql_server_agent_job_name,
	js.step_name , 
	sc.Schedule ,
	max(js.job_start_time_utc) as Last_succes_Start_timestamp,
	js.job_step_success_message,
	max(CONVERT(VARCHAR(23), CAST(js.job_success_time_utc AS DATETIME), 121)) as Last_job_success_timestamp , 
	max(jf.job_failure_time_utc) as Last_job_failure_timestamp 
	from #job_step_success js inner join [DBADB].[dbo].[sql_server_agent_job] j 
        ON js.sql_server_agent_job_id_guid = j.sql_server_agent_job_id_guid inner join [DBADB].[dbo].[sql_server_agent_job_failure] jf on j.sql_server_agent_job_id=jf.sql_server_agent_job_id JOIN 
    ScheduleCTE sc ON j.sql_server_agent_job_id = sc.sql_server_agent_job_id
		WHERE jf.ticket_status = ''Open'' and js.step_name=jf.job_failure_step_name and jf.job_step_message_id>-1
		
		group by j.sql_server_agent_job_id,
    j.sql_server_agent_job_name,
	js.step_name , 
	sc.Schedule ,js.job_step_success_message
	having max(CONVERT(VARCHAR(23), CAST(js.job_success_time_utc AS DATETIME), 121)) >max(jf.job_failure_time_utc);

--select JobId, JobName, StepName, Schedule ,JobStartTime, SuccessMessages, LastSuccessTime  , LastFailureTime from @EmailData;

    
DECLARE @subject NVARCHAR(255),
        @body NVARCHAR(MAX),
        @JobId NVARCHAR(255),
        @JobName NVARCHAR(255),
        @StepName NVARCHAR(255),
        @Schedule NVARCHAR(255),
        @SuccessMessages NVARCHAR(MAX),
        @LastFailureTime DATETIME,
        @LastSuccessTime DATETIME,
		@JobStartTime DATETIME;

DECLARE EmailCursor CURSOR FOR 
SELECT JobId, JobName, StepName, Schedule ,JobStartTime, SuccessMessages, LastSuccessTime , LastFailureTime
FROM @EmailData;

OPEN EmailCursor;
FETCH NEXT FROM EmailCursor INTO 
    @JobId, @JobName, @StepName, @Schedule ,@JobStartTime, @SuccessMessages, @LastSuccessTime , @LastFailureTime;

WHILE @@FETCH_STATUS = 0
BEGIN

	
	SET @subject = ''Thyrocare ''+ @server_name +'' ''+@JobName + '' Failed Alert -> Closed '' ;

	 SET @body =''<html>
    <head>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #f4f6f9; /* Light gray background */
                color: #495057; /* Darker text color for better contrast */
            }
            h2 {
                color: #007bff; /* Soft blue color for headings */
                text-align: center;
                margin-bottom: 20px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
                background-color: #ffffff; /* White background for table */
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow for table */
            }
            th, td {
                padding: 15px;
                border: 1px solid #dee2e6; /* Lighter border color */
                text-align: left;
            }
            th {
                background-color: #007bff; /* Blue color for header */
                color: #ffffff; /* White text in header */
            }
            tr:nth-child(even) {
                background-color: #f8f9fa; /* Light gray for even rows */
            }
            tr:hover {
                background-color: #f1f1f1; /* Light hover effect for rows */
            }
            p {
                text-align: center;
                margin-top: 20px;
                font-weight: bold;
                color: #6c757d; /* Gray text color */
            }
        </style>
    </head>
    <body>
        <h2>Failed Job Success Alert</h2>
        <table>
            <tr><th>Job Name</th><td>'' + @JobName + ''</td></tr>
            <tr><th>Step Name</th><td>'' + ISNULL(@StepName, ''N/A'') + ''</td></tr>
            <tr><th>Success Message</th><td>'' + ISNULL(@SuccessMessages, ''N/A'') + ''</td></tr>
            <tr><th>Last Run Start Time</th><td>'' + CONVERT(NVARCHAR, @JobStartTime, 120) + ''</td></tr>
            <tr><th>Last Failure Time</th><td>'' + CONVERT(NVARCHAR, @LastFailureTime, 120) + ''</td></tr>
            <tr><th>Last Success Time</th><td>'' + CONVERT(NVARCHAR, @LastSuccessTime, 120) + ''</td></tr>
            <tr><th>Schedule</th><td>'' + @Schedule + ''</td></tr>
        </table>
    </body>
</html>'';
--select @body;
   EXEC msdb.dbo.sp_send_dbmail
        @profile_name = ''DBA'', -- Update with current server DB mail profile
        @recipients = ''mssqlalerts@geopits.com'', -- add if additional Id''ds
        @subject = @subject,
        @body = @body,
        @body_format = ''HTML'';
		
   UPDATE [DBADB].[dbo].[sql_server_agent_job_failure]
   SET ticket_status = ''Closed''
   WHERE sql_server_agent_job_id = @JobId and has_email_been_sent_to_operator =1 and ticket_status = ''Open'';

    FETCH NEXT FROM EmailCursor INTO 
        @JobId, @JobName, @StepName, @Schedule ,@JobStartTime, @SuccessMessages, @LastSuccessTime , @LastFailureTime;
END

CLOSE EmailCursor;
DEALLOCATE EmailCursor;	

DROP TABLE #job_success,#job_step_success;
SET NOCOUNT OFF;
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'new5m', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=5, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20241028, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'9c1b6612-e6b5-4c77-8b04-72e4e8943361'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_GeoPITS_LongRunningQueries_Alert]    Script Date: 2/9/2026 8:03:29 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:29 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_GeoPITS_LongRunningQueries_Alert', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s1]    Script Date: 2/9/2026 8:03:29 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'exec dbadb.[dbo].[DBA_GeoPITS_Longrunning]', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'dba1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=5, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20240915, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'e2588e19-1c4f-487b-a107-b491dce373a2'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_GeoPITS_LongRunningQueries_Closed]    Script Date: 2/9/2026 8:03:30 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:30 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_GeoPITS_LongRunningQueries_Closed', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s1]    Script Date: 2/9/2026 8:03:30 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'exec dbadb..DBA_GeoPITS_Longrunning_closed', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'dba', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=2, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20240915, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'3fb4e5bd-b0e4-4608-971f-87771a5276d7'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Health Check Report New]    Script Date: 2/9/2026 8:03:30 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:30 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Health Check Report New', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Health_Check]    Script Date: 2/9/2026 8:03:30 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Health_Check', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @RC int
DECLARE @MailProfile nvarchar(200)
DECLARE @MailID nvarchar(2000)
DECLARE @Server varchar(100)
 
-- TODO: Set parameter values here.
 
EXECUTE @RC = [DBADB].[dbo].[SQLhealthcheck_report_new2]
 ''DBA''
,''mssqltechsupport@geopits.com;''
,''CHARBISERVER''
,''Thyrocare''
GO

', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Every_6_AM', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20251229, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'6ece18e3-35cc-4cbb-96f0-3b9f7baca5b8'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_IDENTITY_HEALTH_MONITOR_AND_ALERT]    Script Date: 2/9/2026 8:03:30 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:30 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_IDENTITY_HEALTH_MONITOR_AND_ALERT', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [1]    Script Date: 2/9/2026 8:03:30 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'exec DBA_IDENTITY_HEALTH_MONITOR_AND_ALERT', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Occurs every day at 9:03:00 AM', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20260120, 
		@active_end_date=99991231, 
		@active_start_time=90300, 
		@active_end_time=235959, 
		@schedule_uid=N'7baad70c-6887-43d7-9c96-7db587125a3e'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_IndexFrag_Collection]    Script Date: 2/9/2026 8:03:30 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:30 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_IndexFrag_Collection', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Charbi frag]    Script Date: 2/9/2026 8:03:30 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Charbi frag', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=3, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'use charbi;
GO
-- Insert the index fragmentation data into the table
INSERT INTO dbadb.DBO.Indexfragdatacollection (Dbname,Schemaname, Tablename, Indexname, avg_fragmentation_in_percent, page_count)
SELECT 
	DB_NAME(DDIPS.database_id) AS ''DATABASE'' ,
    S.name AS ''Schema'',
    T.name AS ''Table'',
    I.name AS ''Index'',
    DDIPS.avg_fragmentation_in_percent,
    DDIPS.page_count
FROM 
    sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS DDIPS
INNER JOIN 
    sys.tables T ON T.object_id = DDIPS.object_id
INNER JOIN 
    sys.schemas S ON T.schema_id = S.schema_id
INNER JOIN 
    sys.indexes I ON I.object_id = DDIPS.object_id AND DDIPS.index_id = I.index_id
WHERE 
    db_name(DDIPS.database_id) = ''charbi'' AND I.name IS NOT NULL
ORDER BY 
    T.name ASC, I.name ASC;
GO', 
		@database_name=N'charbi', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Thyrocare frag]    Script Date: 2/9/2026 8:03:30 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Thyrocare frag', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SET ANSI_NULLS, QUOTED_IDENTIFIER ON;
use Thyrocare;
GO
-- Insert the index fragmentation data into the table
INSERT INTO dbadb.DBO.Indexfragdatacollection (Dbname,Schemaname, Tablename, Indexname, avg_fragmentation_in_percent, page_count)
SELECT 
	DB_NAME(DDIPS.database_id) AS ''DATABASE'' ,
    S.name AS ''Schema'',
    T.name AS ''Table'',
    I.name AS ''Index'',
    DDIPS.avg_fragmentation_in_percent,
    DDIPS.page_count
FROM 
    sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS DDIPS
INNER JOIN 
    sys.tables T ON T.object_id = DDIPS.object_id
INNER JOIN 
    sys.schemas S ON T.schema_id = S.schema_id
INNER JOIN 
    sys.indexes I ON I.object_id = DDIPS.object_id AND DDIPS.index_id = I.index_id
WHERE 
    db_name(DDIPS.database_id) = ''Thyrocare'' AND I.name IS NOT NULL
ORDER BY 
    T.name ASC, I.name ASC;
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;', 
		@database_name=N'Thyrocare', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [NuclearDB_frag]    Script Date: 2/9/2026 8:03:30 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'NuclearDB_frag', 
		@step_id=3, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'use Nueclear;
GO
-- Insert the index fragmentation data into the table
INSERT INTO dbadb.DBO.Indexfragdatacollection (Dbname,Schemaname, Tablename, Indexname, avg_fragmentation_in_percent, page_count)
SELECT 
	DB_NAME(DDIPS.database_id) AS ''DATABASE'' ,
    S.name AS ''Schema'',
    T.name AS ''Table'',
    I.name AS ''Index'',
    DDIPS.avg_fragmentation_in_percent,
    DDIPS.page_count
FROM 
    sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS DDIPS
INNER JOIN 
    sys.tables T ON T.object_id = DDIPS.object_id
INNER JOIN 
    sys.schemas S ON T.schema_id = S.schema_id
INNER JOIN 
    sys.indexes I ON I.object_id = DDIPS.object_id AND DDIPS.index_id = I.index_id
WHERE 
    db_name(DDIPS.database_id) = ''Nueclear'' AND I.name IS NOT NULL
ORDER BY 
    T.name ASC, I.name ASC;
GO', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [SyncDB_frag]    Script Date: 2/9/2026 8:03:30 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'SyncDB_frag', 
		@step_id=4, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'use SyncDB;
GO
-- Insert the index fragmentation data into the table
INSERT INTO dbadb.DBO.Indexfragdatacollection (Dbname,Schemaname, Tablename, Indexname, avg_fragmentation_in_percent, page_count)
SELECT 
	DB_NAME(DDIPS.database_id) AS ''DATABASE'' ,
    S.name AS ''Schema'',
    T.name AS ''Table'',
    I.name AS ''Index'',
    DDIPS.avg_fragmentation_in_percent,
    DDIPS.page_count
FROM 
    sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS DDIPS
INNER JOIN 
    sys.tables T ON T.object_id = DDIPS.object_id
INNER JOIN 
    sys.schemas S ON T.schema_id = S.schema_id
INNER JOIN 
    sys.indexes I ON I.object_id = DDIPS.object_id AND DDIPS.index_id = I.index_id
WHERE 
    db_name(DDIPS.database_id) = ''SyncDB'' AND I.name IS NOT NULL
ORDER BY 
    T.name ASC, I.name ASC;
GO', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Every Friday at 12:50 AM', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=32, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20250717, 
		@active_end_date=99991231, 
		@active_start_time=5000, 
		@active_end_time=235959, 
		@schedule_uid=N'fa70b229-54c5-4086-bcb1-b686ab812ab8'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Job_Failure_Collection_and_Notification]    Script Date: 2/9/2026 8:03:30 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]    Script Date: 2/9/2026 8:03:30 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Job_Failure_Collection_and_Notification', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=2, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', 
		@notify_email_operator_name=N'geopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [monitor_job_failures]    Script Date: 2/9/2026 8:03:30 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'monitor_job_failures', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXEC dbo.monitor_job_failures', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=10, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20230522, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'dd4728d3-129b-487b-9bf3-11151b27ca25'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Log_File_Data_Cleanup]    Script Date: 2/9/2026 8:03:30 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:30 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Log_File_Data_Cleanup', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Delete 7 Days Record]    Script Date: 2/9/2026 8:03:30 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Delete 7 Days Record', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DELETE FROM [dbo].[Log_File_Size]
WHERE LogDate < DATEADD(dd,-7,GETDATE())', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20241222, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'130bafa8-f7ee-4bc3-a787-52e8e567f3bc'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Log_File_Size_Collection&Shrink_Alert]    Script Date: 2/9/2026 8:03:30 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]    Script Date: 2/9/2026 8:03:30 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Log_File_Size_Collection&Shrink_Alert', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Data Collection]    Script Date: 2/9/2026 8:03:30 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Data Collection', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'Exec [dbo].[Log_File_Size_Data_Collection] ', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Shrink_Alert]    Script Date: 2/9/2026 8:03:30 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Shrink_Alert', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @TotalLogFileMB DECIMAL(18, 2),
        @DatabaseName NVARCHAR(128),
        @FileName NVARCHAR(256),
		@DiskFreeSpaceMB DECIMAL(18,2),
        @AlertMessage NVARCHAR(MAX),
        @EmailBody NVARCHAR(MAX),
        @LogDate DATETIME,
        @Threshold DECIMAL(18, 2) = 15360,
        @ClientName NVARCHAR(255) = ''Thyrocare'',--Change
        @Subject NVARCHAR(255),
        @AlertStatus NVARCHAR(20),
        @LastAlertTime DATETIME,
        @AlertID INT;

-- Declare cursor
DECLARE db_cursor CURSOR FOR 
SELECT [DBName], [FileName], TRY_CAST([TotalLogfileSizeMB] AS DECIMAL(18, 2)),DiskFreeSpaceMB ,[LogDate]
FROM [DBADB].[dbo].[Log_File_Size]
WHERE [LogDate] > DATEADD(MINUTE, -1, GETDATE());  

OPEN db_cursor;

FETCH NEXT FROM db_cursor INTO @DatabaseName, @FileName, @TotalLogFileMB,@DiskFreeSpaceMB, @LogDate;

-- Loop through cursor
WHILE @@FETCH_STATUS = 0
BEGIN
    SET @AlertMessage = '''';
    SET @EmailBody = '''';
    SET @Subject = '''';
    SET @LastAlertTime = NULL;
    SET @AlertID = NULL;

    -- Check if the log file size exceeds the threshold
    IF @TotalLogFileMB >= @Threshold
    BEGIN
        -- Fetch the last alert time for the "Open" status
        SELECT TOP 1 @LastAlertTime = AlertTime, @AlertID = AlertID
        FROM Log_File_Shrink_AlertTable
        WHERE DatabaseName = @DatabaseName AND LogFileName = @FileName AND AlertStatus = ''Open''
        ORDER BY AlertTime DESC;

        -- If no "Open" alert exists, insert a new alert and send email
        IF @LastAlertTime IS NULL
        BEGIN
            INSERT INTO Log_File_Shrink_AlertTable (DatabaseName, LogFileName, TotalLogFileSizeMB, AlertMessage, AlertTime, AlertStatus, has_email_been_sent_to_operator)
            VALUES (@DatabaseName, @FileName, @TotalLogFileMB, ''Log file size exceeded threshold.'', GETDATE(), ''Open'', 1);

            SET @AlertID = SCOPE_IDENTITY();
            SET @AlertStatus = ''Open'';

            -- Build the email subject and body
            SET @Subject = ''Open Alert (ID: '' + CAST(@AlertID AS NVARCHAR(10)) + '') -> Log File Shrinking Required for '' + @DatabaseName + '' on '' + @ClientName + '' ('' + @@SERVERNAME + '')'';
            SET @EmailBody = 
            ''<html>
            <head>
                <style>
                    body { font-family: Arial, sans-serif; color: #333; background-color: #ffffff; }
                    h2 { color: #d9534f; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { padding: 15px; border: 1px solid #ddd; text-align: center; }
                    th { background-color: #000000; color: white; } 
                    tr:hover { background-color: #f1f1f1; }
                </style>
            </head>
            <body>
                <h2>Log File Size Exceeded ''+ FORMAT(ROUND(@Threshold / 1024,0), ''N0'')+ '' GB</h2>
                <table>
                    <tr>
                        <th>Database Name</th>
                        <th>Log File Size (MB)</th>
						<th>Disk Free Space (GB)</th>
                    </tr>
                    <tr>
                        <td>'' + @DatabaseName + ''</td>
                        <td>'' + CAST(@TotalLogFileMB AS NVARCHAR(10)) + ''</td>
						<td>'' + FORMAT(ROUND(@DiskFreeSpaceMB / 1024,0), ''N2'') + ''</td>
                    </tr>
                </table>
            </body>
            </html>'';

            EXEC msdb.dbo.sp_send_dbmail
                @profile_name = ''DBA'',--Change 2
                @recipients = ''mssqlalerts@geopits.com'',--change 3
				@blind_copy_recipients = ''aruneswaran@geopits.com'',
                @subject = @Subject,
                @body = @EmailBody,
                @body_format = ''HTML'';
        END
        ELSE IF DATEDIFF(HOUR, @LastAlertTime, GETDATE()) >= 6
        BEGIN
            -- Update existing alert and resend email
            UPDATE Log_File_Shrink_AlertTable
            SET 
                TotalLogFileSizeMB = @TotalLogFileMB,
                AlertMessage = ''Log file size still exceeds threshold.'',
                AlertTime = GETDATE()
            WHERE AlertID = @AlertID;

            SET @AlertStatus = ''Open'';

            -- Build the email subject and body
            SET @Subject = ''Open Alert (ID: '' + CAST(@AlertID AS NVARCHAR(10)) + '') -> Log File Shrinking Still Required for '' + @DatabaseName + '' on '' + @ClientName + '' ('' + @@SERVERNAME + '')'';
            SET @EmailBody = 
            ''<html>
            <head>
                <style>
                    body { font-family: Arial, sans-serif; color: #333; background-color: #ffffff; }
                    h2 { color: #d9534f; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { padding: 15px; border: 1px solid #ddd; text-align: center; }
                    th { background-color: #000000; color: white; } 
                    tr:hover { background-color: #f1f1f1; }
                </style>
            </head>
            <body>
                <h2>Log File Size Still Exceeded '' + FORMAT(ROUND(@Threshold / 1024,0), ''N0'') + '' GB</h2>
                <table>
                    <tr>
                        <th>Database Name</th>
                        <th>Log File Size (MB)</th>
						<th>Disk Free Space (GB)</th>
                    </tr>
                    <tr>
                        <td>'' + @DatabaseName + ''</td>
                        <td>'' + CAST(@TotalLogFileMB AS NVARCHAR(10)) + ''</td>
						<td>'' + FORMAT(ROUND(@DiskFreeSpaceMB / 1024,0), ''N2'') + ''</td>
                    </tr>
                </table>
            </body>
            </html>'';

            EXEC msdb.dbo.sp_send_dbmail
                @profile_name = ''DBA'',-- Change 4
                @recipients = ''mssqlalerts@geopits.com'',--Change 5
				@blind_copy_recipients = ''aruneswaran@geopits.com'',
                @subject = @Subject,
                @body = @EmailBody,
                @body_format = ''HTML'';
        END
    END
    ELSE
    BEGIN
        -- Check if an "Open" alert exists to resolve it
        IF EXISTS (SELECT 1 FROM Log_File_Shrink_AlertTable WHERE DatabaseName = @DatabaseName AND LogFileName = @FileName AND AlertStatus = ''Open'')
        BEGIN
            SELECT @AlertID = AlertID
            FROM Log_File_Shrink_AlertTable
            WHERE DatabaseName = @DatabaseName AND LogFileName = @FileName AND AlertStatus = ''Open'';

            SET @AlertStatus = ''Resolved'';

            -- Update alert status to resolved
            UPDATE Log_File_Shrink_AlertTable
            SET 
                AlertStatus = @AlertStatus, 
                AlertMessage = ''Sufficient free space available.'', 
                TotalLogFileSizeMB = @TotalLogFileMB,
                AlertTime = GETDATE()
            WHERE AlertID = @AlertID;

            -- Build the email subject and body
            SET @Subject = ''Resolved Alert (ID: '' + CAST(@AlertID AS NVARCHAR(10)) + '') -> Log File Shrinking Completed for '' + @DatabaseName + '' on '' + @ClientName + '' ('' + @@SERVERNAME + '')'';
            SET @EmailBody = 
            ''<html>
            <head>
                <style>
                        body { font-family: Arial, sans-serif; color: #333; background-color: #ffffff; }
                        h2 { color: #29B626; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 15px; border: 1px solid #ddd; text-align: center; }
                        th { background-color: #000000; color: white; }
                        tr:hover { background-color: #f1f1f1; }
                 </style>
            </head>
            <body>
                <h2>Log File Size Reduced Below '' + FORMAT(ROUND(@Threshold / 1024,0), ''N0'') + '' GB</h2>
                <table>
                    <tr>
                        <th>Database Name</th>
                        <th>Log File Size (MB)</th>
						<th>Disk Free Space (GB)</th>
                    </tr>
                    <tr>
                        <td>'' + @DatabaseName + ''</td>
                        <td>'' + CAST(@TotalLogFileMB AS NVARCHAR(10)) + ''</td>
						<td>'' + FORMAT(ROUND(@DiskFreeSpaceMB / 1024,0), ''N2'') + ''</td> 
                    </tr>
                </table>
            </body>
            </html>'';

            EXEC msdb.dbo.sp_send_dbmail
                @profile_name = ''DBA'',--Change 6
                @recipients = ''mssqlalerts@geopits.com'',--Change 7
				@blind_copy_recipients = ''aruneswaran@geopits.com'',
                @subject = @Subject,
                @body = @EmailBody,
                @body_format = ''HTML'';
        END
    END

    FETCH NEXT FROM db_cursor INTO @DatabaseName, @FileName, @TotalLogFileMB,@DiskFreeSpaceMB ,@LogDate;
END

-- Close and deallocate cursor
CLOSE db_cursor;
DEALLOCATE db_cursor;
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20241220, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'34dc6030-8789-4758-a2ca-25a2d13507d4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Log_Shipping_Alert]    Script Date: 2/9/2026 8:03:30 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:30 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Log_Shipping_Alert', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [copy delay]    Script Date: 2/9/2026 8:03:30 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'copy delay', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'Exec [dbo].[Check_LogShippingCopyStatus_SecondLatest_V2]', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Every15Minutes', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=15, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20251111, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'd2f6b18f-fc42-4cbd-84e7-6bf1f764737a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_long_running_summary]    Script Date: 2/9/2026 8:03:30 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:30 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_long_running_summary', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Summary of Long running queries report weekly', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s1]    Script Date: 2/9/2026 8:03:31 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE [DBADB];
GO

DECLARE @tableHTML NVARCHAR(MAX);
DECLARE @subject NVARCHAR(200);
DECLARE @ServerName NVARCHAR(128);

SET @ServerName = @@SERVERNAME;
SET @tableHTML = 
N''<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; font-size: 15px; color: #333; margin: 0; padding: 20px; background-color: #ffffff; }
    .page-container { margin: 0 auto; padding: 30px; width: 95%; background-color: #ffffff; border: 2px solid #000000; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
    h1 { font-family: "Trebuchet MS", Helvetica, sans-serif; font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 20px; padding: 10px; border-radius: 8px; background-color: #004080; color: #ffffff; border-bottom: 2px solid #002147; }
    table { border-collapse: collapse; width: 100%; table-layout: fixed; margin-top: 10px; }
    th, td { border: 1px solid black; padding: 8px; text-align: left; vertical-align: top; font-size: 13px; word-wrap: break-word; white-space: normal; }
    th { background-color: #004080; color: #ffffff; font-size: 14px; font-weight: bold; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    tr:hover { background-color: #e6f2ff; }
    .sql-box { background: #fafafa; border: 1px solid #ccc; padding: 6px; max-height: 100px; overflow-y: auto; font-family: Consolas, monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; }
    .footer { margin-top: 15px; font-size: 11px; color: #555; text-align: center; }
  </style>
</head>
<body>
  <div class="page-container">
    <h1>Long Running Report Summary - '' + @ServerName + '' - '' + CONVERT(VARCHAR(10), GETDATE(), 105) + ''</h1>
    <table>
      <tr>
        <th style="width:5%;">Sino</th>
        <th style="width:10%;">Database</th>
        <th style="width:10%;">User</th>
        <th style="width:15%;">Stored Procedure</th>
        <th style="width:20%;">Executing SQL</th>
        <th style="width:20%;">Statement Text</th>
        <th style="width:10%;">Execution Count</th>
        <th style="width:10%;">Max Elapsed</th>
      </tr>'';

-- Summarize queries with ExecutionCount > 10
;WITH QuerySummary AS (
    SELECT 
        ISNULL(DatabaseName,''-'') AS DatabaseName,
        ISNULL(UserName,''-'') AS UserName,
        ISNULL(ExecutingSQL,''-'') AS ExecutingSQL,
        ISNULL(StatementText,''-'') AS StatementText,
        ISNULL(StoredProcedure,''-'') AS StoredProcedure,
        COUNT(*) AS ExecutionCount,
        MAX(DATEDIFF(SECOND,''00:00:00'', ElapsedTime)) AS MaxElapsedSec
    FROM [DBADB].[dbo].[longqrydetails]
    WHERE StartTime >= DATEADD(DAY, -7, GETDATE())
    GROUP BY 
        ISNULL(DatabaseName,''-''), 
        ISNULL(UserName,''-''), 
        ISNULL(ExecutingSQL,''-''), 
        ISNULL(StatementText,''-''), 
        ISNULL(StoredProcedure,''-'')
    HAVING COUNT(*) > 1
) 
SELECT @tableHTML = @tableHTML +
    N''<tr>
        <td>'' + CAST(ROW_NUMBER() OVER(ORDER BY MaxElapsedSec DESC) AS VARCHAR) + N''</td>
        <td>'' + DatabaseName + N''</td>
        <td>'' + UserName + N''</td>
		 <td>'' + StoredProcedure + N''</td>
        <td><div class="sql-box">'' + ExecutingSQL + N''</div></td>
        <td><div class="sql-box">'' + StatementText + N''</div></td>
       
        <td>'' + CAST(ExecutionCount AS VARCHAR) + N''</td>
        <td>'' + CONVERT(varchar, DATEADD(SECOND, CAST(MaxElapsedSec AS INT), 0), 108) + N''</td>
      </tr>''
FROM QuerySummary
ORDER BY MaxElapsedSec DESC;

SET @tableHTML = @tableHTML + 
N''</table>
<div class="footer">
 <br>
  Only queries with Execution Count > 1 are included.
</div>
</div>
</body></html>'';

SET @subject = ''Long Running Query Summary - '' + @ServerName + '' - '' + CONVERT(VARCHAR(10), GETDATE(), 105);

EXEC msdb.dbo.sp_send_dbmail
    @profile_name = ''dba'',                     
   @recipients = ''aswin.kumarvpkothuru@thyrocare.com;nikhil@pharmeasy.in;ankit.g@pharmeasy.in;rajesh.n@pharmeasy.in;pushparaj.j@pharmeasy.in'',
   @copy_recipients=''mssqlalerts@geopits.com'',
   @blind_copy_recipients=''mohamed@geopits.com;vishnupriya@geopits.com'',
    @subject      = @subject,
    @body         = @tableHTML,
    @body_format  = ''HTML'';
			
        ', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N's1', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=2, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20250915, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'ab890066-9dfb-41da-b74b-5f53ba88a1f2'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Low_memory_alert]    Script Date: 2/9/2026 8:03:31 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:31 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Low_memory_alert', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [low_memory_alert]    Script Date: 2/9/2026 8:03:31 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'low_memory_alert', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SET NOCOUNT ON;

SET ANSI_NULLS ON;

GO


SET QUOTED_IDENTIFIER ON
;
GO

DECLARE 
    @profile       NVARCHAR(100) = N''DBA'',
    @recipient     NVARCHAR(MAX)   = N''mssqlalerts@geopits.com'',
    @cc            NVARCHAR(MAX)   = N'''',
    @bcc           NVARCHAR(MAX)   = N''mohamed@geopits.com'',
    @body          NVARCHAR(MAX),
    @sub           NVARCHAR(200),
    @MinAvailableGB INT             = 10;  -- change threshold here

SET @sub = N''THYROCARE Memory Alert on '' 
         + CAST(@@SERVERNAME AS NVARCHAR(128)) 
         + N'': '' + CONVERT(NVARCHAR(30), GETDATE(), 107);

-- Prepare last 5 rows (most recent)
IF OBJECT_ID(''tempdb..#LastFive'') IS NOT NULL DROP TABLE #LastFive;
SELECT TOP (5)
    [Datetime],
    SQL_current_Memory_usage_Gb,
    SQL_Max_Memory_target_Gb,
    OS_Total_Memory_Gb,
    OS_Available_Memory_Gb
INTO #LastFive
FROM DBADB.dbo.MemoryUtilisationdata
ORDER BY [Datetime] DESC;

DECLARE @LowCount INT;
SELECT @LowCount = COUNT(*) FROM #LastFive WHERE OS_Available_Memory_Gb < @MinAvailableGB;

-- proceed only if all last 5 are below threshold
IF @LowCount = 5
BEGIN
    -- build HTML rows using STRING_AGG (preserves order with WITHIN GROUP)
    DECLARE @rows NVARCHAR(MAX);


    SELECT @rows = 
        STUFF((
            SELECT 
                N''<tr>'' +
                    N''<td>'' + CONVERT(NVARCHAR(19), [Datetime], 120) + N''</td>'' +
                    N''<td>'' + ISNULL(CAST(SQL_current_Memory_usage_Gb AS NVARCHAR(20)), N'''') + N''</td>'' +
                    N''<td>'' + ISNULL(CAST(SQL_Max_Memory_target_Gb AS NVARCHAR(20)), N'''') + N''</td>'' +
                    N''<td>'' + ISNULL(CAST(OS_Total_Memory_Gb AS NVARCHAR(20)), N'''') + N''</td>'' +
                    N''<td>'' + ISNULL(CAST(OS_Available_Memory_Gb AS NVARCHAR(20)), N'''') + N''</td>'' +
                N''</tr>''
            FROM #LastFive
            ORDER BY [Datetime]
            FOR XML PATH(''''), TYPE
        ).value(''.'', ''NVARCHAR(MAX)''), 1, 0, N'''');

    IF @rows IS NULL
        SET @rows = N''<tr><td colspan="5">No records found</td></tr>'';

    -- compose body
    SET @body = 
    N''<html>
        <head>
            <style>
                table, th, td { border: 1px solid black; border-collapse: collapse; text-align: center; padding: 5px; }
            </style>
        </head>
        <body>
            <h2>Low Memory Alert: '' + CAST(@@SERVERNAME AS NVARCHAR(128)) + N''</h2>
            <p>Last 5 occurrences all show low memory (&lt;'' + CAST(@MinAvailableGB AS NVARCHAR(10)) + N'' GB available):</p>
            <table>
                <tr>
                    <th>Date time</th>
                    <th>SQL Memory usage (GB)</th>
                    <th>SQL Max Memory (GB)</th>
                    <th>OS Total Memory (GB)</th>
                    <th>OS Available Memory (GB)</th>
                </tr>''
                + @rows +
            N''</table>
        </body>
    </html>'';

    -- send email
    EXEC msdb.dbo.sp_send_dbmail
        @profile_name = @profile,
        @recipients = @recipient,
        @copy_recipients = @cc,
        @blind_copy_recipients = @bcc,
        @subject = @sub,
        @body = @body,
        @body_format = N''HTML'';
END

DROP TABLE #LastFive;
SET NOCOUNT OFF;
GO
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N's1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=5, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250904, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'00730b8c-5ed2-438b-95a9-750f0e8f497f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Low_memory_data_collection]    Script Date: 2/9/2026 8:03:31 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:31 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Low_memory_data_collection', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [data_collection]    Script Date: 2/9/2026 8:03:31 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'data_collection', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE master;
GO

INSERT INTO [DBADB].[dbo].[MemoryUtilisationdata]
SELECT 
    GETDATE(),
    SQL_current_Memory_usage_mb/1024.0 AS [SQL_current_Memory_usage_Gb],
    SQL_Max_Memory_target_mb/1024.0 AS [SQL_Max_Memory_target_Gb], 
    OS_Total_Memory_mb/1024.0 AS [OS_Total_Memory_Gb],
    OS_Available_Memory_mb/1024.0 AS [OS_Available_Memory_Gb] 
FROM fn_checkSQLMemory();
GO
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N's1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250904, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'f395b025-e93b-4747-9ec0-20e39e27ed49'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Monitor_Log Files]    Script Date: 2/9/2026 8:03:31 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [Instance Monitor]    Script Date: 2/9/2026 8:03:31 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'Instance Monitor' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'Instance Monitor'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Monitor_Log Files', 
		@enabled=1, 
		@notify_level_eventlog=2, 
		@notify_level_email=2, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Check for databases whose transaction logs are nearing capacity.', 
		@category_name=N'Instance Monitor', 
		@owner_login_name=N'sa', 
		@notify_email_operator_name=N'geopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Check for databases whose transaction logs are nearing capacity.]    Script Date: 2/9/2026 8:03:31 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Check for databases whose transaction logs are nearing capacity.', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXEC dbo.MonitorLogFiles', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'DBA_Monitor_Log Files', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=19900101, 
		@active_end_date=99991231, 
		@active_start_time=1200, 
		@active_end_time=235959, 
		@schedule_uid=N'881ae500-641a-4690-96ae-b2a195aa164f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Perfmon_Data]    Script Date: 2/9/2026 8:03:31 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:31 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Perfmon_Data', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:31 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE DBADB

GO

SET NOCOUNT ON;

DECLARE @PerfCounters TABLE

    (

      [Counter] NVARCHAR(770) ,

      [CounterType] INT ,

      [FirstValue] DECIMAL(38, 2) ,

      [FirstDateTime] DATETIME ,

      [SecondValue] DECIMAL(38, 2) ,

      [SecondDateTime] DATETIME ,

      [ValueDiff] AS ( [SecondValue] - [FirstValue] ) ,

      [TimeDiff] AS ( DATEDIFF(SS, FirstDateTime, SecondDateTime) ) ,

      [CounterValue] DECIMAL(38, 2)

    );

INSERT  INTO @PerfCounters

        ( [Counter] ,

          [CounterType] ,

          [FirstValue] ,

          [FirstDateTime]

        )

        SELECT  RTRIM([object_name]) + N'':'' + RTRIM([counter_name]) + N'':''

                + RTRIM([instance_name]) ,

                [cntr_type] ,

                [cntr_value] ,

                GETDATE()

        FROM    sys.dm_os_performance_counters

        WHERE   [counter_name] IN ( N''Page life expectancy'',

                                    N''Lazy writes/sec'', N''Page reads/sec'',

                                    N''Page writes/sec'', N''Free Pages'',

                                    N''Free list stalls/sec'',

                                    N''User Connections'',

                                    N''Lock Waits/sec'',

                                    N''Number of Deadlocks/sec'',

                                    N''Transactions/sec'',

                                    N''Forwarded Records/sec'',

                                    N''Index Searches/sec'',

                                    N''Full Scans/sec'',

                                    N''Batch Requests/sec'',

                                    N''SQL Compilations/sec'',

                                    N''SQL Re-Compilations/sec'',

                                    N''Total Server Memory (KB)'',

                                    N''Target Server Memory (KB)'',

                                    N''Latch Waits/sec'' )

        ORDER BY [object_name] + N'':'' + [counter_name] + N'':''

                + [instance_name];

WAITFOR DELAY ''00:00:10'';

UPDATE  @PerfCounters

SET     [SecondValue] = [cntr_value] ,

        [SecondDateTime] = GETDATE()

FROM    sys.dm_os_performance_counters

WHERE   [Counter] = RTRIM([object_name]) + N'':'' + RTRIM([counter_name])

                                                                  + N'':''

        + RTRIM([instance_name])

        AND [counter_name] IN ( N''Page life expectancy'', 

                                N''Lazy writes/sec'',

                                N''Page reads/sec'', N''Page writes/sec'',

                                N''Free Pages'', N''Free list stalls/sec'',

                                N''User Connections'', N''Lock Waits/sec'',

                                N''Number of Deadlocks/sec'',

                                N''Transactions/sec'',

                                N''Forwarded Records/sec'',

                                N''Index Searches/sec'', N''Full Scans/sec'',

                                N''Batch Requests/sec'',

                                N''SQL Compilations/sec'',

                                N''SQL Re-Compilations/sec'',

                                N''Total Server Memory (KB)'',

                                N''Target Server Memory (KB)'',

                                N''Latch Waits/sec'' );

UPDATE  @PerfCounters

SET     [CounterValue] = [ValueDiff] / [TimeDiff]

WHERE   [CounterType] = 272696576;

UPDATE  @PerfCounters

SET     [CounterValue] = [SecondValue]

WHERE   [CounterType] <> 272696576;

INSERT  INTO [dbo].[PerfMonData]

        ( [Counter] ,

          [Value] ,

          [CaptureDate]

        )

        SELECT  [Counter] ,

                [CounterValue] ,

                [SecondDateTime]

        FROM    @PerfCounters;', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20240223, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'71e12272-da68-4ebc-a5aa-0ac7dc676856'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_PLE_Data_Collection]    Script Date: 2/9/2026 8:03:31 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:31 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_PLE_Data_Collection', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits1', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Data_Collection]    Script Date: 2/9/2026 8:03:31 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Data_Collection', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'

--Schedule data collection job every one min
-- Ensure the PageLifeExpectancyLog table exists in DBADB
    IF NOT EXISTS (
        SELECT 1 
        FROM DBADB.sys.tables 
        WHERE name = ''PageLifeExpectancyLog'' AND schema_id = SCHEMA_ID(''dbo'')
    )
    BEGIN
        EXEC(''
            USE DBADB;
            CREATE TABLE dbo.PageLifeExpectancyLog (
                LogID INT IDENTITY(1,1) PRIMARY KEY,
                CounterName NVARCHAR(255),
                PageLifeExpectancy BIGINT,
                LoggedAt DATETIME DEFAULT GETDATE()
            );
        '');
    END

INSERT INTO DBADB.dbo.PageLifeExpectancyLog (CounterName, PageLifeExpectancy)
SELECT
    [counter_name],
    [cntr_value]
FROM
    sys.dm_os_performance_counters
WHERE
    [object_name] = ''SQLServer:Buffer Manager''
    AND [counter_name] = ''Page life expectancy'';
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Every1Minutes', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250902, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'16e33718-1a94-4f69-ba47-dcb4ae515003'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Test_Jobs]    Script Date: 2/9/2026 8:03:31 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/9/2026 8:03:31 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Test_Jobs', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=2, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits', 
		@notify_email_operator_name=N'geopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/9/2026 8:03:31 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'ABCDEFGH', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO


