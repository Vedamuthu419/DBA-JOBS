USE [msdb]
GO

/****** Object:  Job [DBA CPU Data collection]    Script Date: 2/10/2026 6:29:01 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:01 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA CPU Data collection', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s1]    Script Date: 2/10/2026 6:29:01 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE DBADB
go
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
insert into DBADB.dbo.CPUUtilisationdata
SELECT
getdate(),
         cpu_idle = record.value(''(./Record/SchedulerMonitorEvent/SystemHealth/SystemIdle)[1]'', ''int''),
         cpu_sql = record.value(''(./Record/SchedulerMonitorEvent/SystemHealth/ProcessUtilization)[1]'', ''int''),
Other_process = 100 - record.value(''(./Record/SchedulerMonitorEvent/SystemHealth/SystemIdle)[1]'', ''int'') - record.value(''(./Record/SchedulerMonitorEvent/SystemHealth/ProcessUtilization)[1]'', ''int'')
FROM (
         SELECT TOP 1 CONVERT(XML, record) AS record
         FROM sys.dm_os_ring_buffers
         WHERE ring_buffer_type = N''RING_BUFFER_SCHEDULER_MONITOR''
         AND record LIKE ''% %''
ORDER BY TIMESTAMP DESC
)
as cpu_usage', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N's1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20240319, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'd019b330-fa56-4a72-b9f4-a06dfa3a2bab'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Database Size Report]    Script Date: 2/10/2026 6:29:01 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:01 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Database Size Report', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/10/2026 6:29:01 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'insert into DBADB.[dbo].[DB_Meta]
SELECT
    @@SERVERNAME AS ServerName,
    d.name AS DatabaseName,
    CONVERT(date, GETDATE()) AS Date,
    CONVERT(decimal(10, 2), SUM(CAST(mf.size AS bigint)) * 8 / 1024) AS [TotalDiskSpaceMB]
FROM sys.databases d
JOIN sys.master_files mf ON d.database_id = mf.database_id
GROUP BY d.name
ORDER BY d.name;
 
set nocount on
declare @profile varchar(100) = ''DBA''
declare @recipient varchar(max) = ''mssqlsupport@geopits.com''
declare @bcc varchar(max)= ''''
declare @body nvarchar(max)
declare @copy_recipients varchar(max) = ''mssqlsupport@geopits.com''
declare @sub varchar(100)=''Database Size Report:10.10.10.42''+(select convert(varchar,getdate(),107))+''''
DECLARE @SNAME VARCHAR(100)
 
DECLARE  @xml nvarchar(max)
 
 
SELECT @xml = Cast((SELECT a.Instance_Name AS ''td'',
'''',
a.Database_Names AS ''td'',
'''',
b.size2 AS ''td'',
'''',
a.size1 AS ''td'',
'''',
(cast(cast(((a.size1 - b.size2)/b.size2 * 100) as decimal(6,2)) as varchar(100)) +'' %'') AS ''td''
FROM (SELECT Database_Names,Instance_Name,[Size MB] as size1 from DBADB.dbo.DB_Meta
where Dates=cast(GETDATE() as date)) as a
inner join
(SELECT Database_Names,Instance_Name,[Size MB] as size2 from DBADB.dbo.DB_Meta where Dates=cast(GETDATE()-1 as date)) as b
on  a.Database_Names=b.Database_Names and a.Instance_Name=b.Instance_Name
where a.Database_Names not in (''master'',''model'',''msdb'',''DBADB'')
order by a.Instance_Name
FOR xml path(''tr''), elements) AS NVARCHAR(max))
SET @body =
''<html>
<head>
<style>
   table, th, td
   {
    border: 1px solid black;
    border-collapse: collapse;
    text-align: center;
   }
</style>
</head>
<body>
<H2>
  Database Size:10.10.10.42
</H2>
<table>
<tr>
<th> Server </th> <th>Database Name</th> <th>Yesterday DB Size(MB)</th><th>Today DB Size(MB)</th> <th>Difference</th>  
</tr>''
   SET @body = @body + @xml + ''
</table>
</body>
</html>''
if(@xml is not null)
BEGIN
EXEC msdb.dbo.sp_send_dbmail
@profile_name=@profile,
@body=@body,
@body_format=''html'',
@recipients=@recipient,
@blind_copy_recipients = @bcc,
@subject=@sub;
END
SET NOCOUNT OFF', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20240801, 
		@active_end_date=99991231, 
		@active_start_time=180000, 
		@active_end_time=235959, 
		@schedule_uid=N'90f85998-b11f-4eb4-8715-b30f2c7c6aa5'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA DB File Size Data]    Script Date: 2/10/2026 6:29:02 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:02 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA DB File Size Data', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s1]    Script Date: 2/10/2026 6:29:02 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'insert into DBADB.dbo. DB_FileSizeData

SELECT top 20
    d.name AS ''Database'',
 
                  m.name AS ''File'',

                   m.type_desc as Type,
  
	 -- m.size,
   	
	 m.size * 8/1024 ''Size (MB)'',
   
	 SUM(m.size * 8/1024) OVER (PARTITION BY d.name) AS ''Database Total'',

	Getdate() as Date
  
	 -- m.max_size
FROM sys.master_files m
	
INNER JOIN sys.databases d
	 ON
d.database_id = m.database_id;', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Backupinfo]    Script Date: 2/10/2026 6:29:02 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Backupinfo', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'INSERT INTO DBADB.dbo.Backupinfodata

SELECT
    CONVERT(CHAR(100), SERVERPROPERTY(''Servername'')) AS ServerName,
    bs.database_name,
    bs.backup_start_date,
    bs.backup_finish_date,
    bs.expiration_date,
    CASE bs.type
        WHEN ''D'' THEN ''Database''
        WHEN ''I'' THEN ''DIFF''
        WHEN ''L'' THEN ''Log''
    END AS BackupType,
    bs.backup_size,
    bmf.physical_device_name,
    bs.name AS BackupSetName,
    bs.description
FROM msdb.dbo.backupset bs
INNER JOIN msdb.dbo.backupmediafamily bmf 
    ON bmf.media_set_id = bs.media_set_id
WHERE bs.backup_start_date >= DATEADD(DAY, -8, GETDATE())
  AND NOT EXISTS (
      SELECT 1
      FROM DBADB.dbo.Backupinfodata t
      WHERE t.DbNmae   = bs.database_name
        AND t.BackupStartDate = bs.backup_start_date
        AND t.BackupEndTime= bs.backup_finish_date
        AND t.BackupType      = CASE bs.type
                                  WHEN ''D'' THEN ''Database''
                                  WHEN ''I'' THEN ''DIFF''
                                  WHEN ''L'' THEN ''Log''
                                END
  )
ORDER BY bs.database_name, bs.backup_finish_date;
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20240115, 
		@active_end_date=99991231, 
		@active_start_time=234000, 
		@active_end_time=235959, 
		@schedule_uid=N'1fde32f8-20d2-4894-b72b-870e97be60c8'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Health Check Report]    Script Date: 2/10/2026 6:29:02 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]    Script Date: 2/10/2026 6:29:02 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Health Check Report', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/10/2026 6:29:02 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @RC int
DECLARE @MailProfile nvarchar(200)
DECLARE @MailID nvarchar(2000)
DECLARE @Server varchar(100)
 
-- TODO: Set parameter values here.
 
EXECUTE @RC = DBADB.[dbo].[SQLhealthcheck_report]
   ''DBA''
  ,''mssqlsupport@geopits.com;dbasupport@geopits.freshdesk.com''
  ,''10.10.10.42''
GO
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20230209, 
		@active_end_date=99991231, 
		@active_start_time=63000, 
		@active_end_time=235959, 
		@schedule_uid=N'84d22cd1-bd3c-4e2d-b7e8-a72716fc6c6f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA HealthCheck Report New]    Script Date: 2/10/2026 6:29:02 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:03 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA HealthCheck Report New', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Health_Check_Report]    Script Date: 2/10/2026 6:29:03 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Health_Check_Report', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=2, 
		@retry_interval=2, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @RC int
DECLARE @MailProfile nvarchar(200)
DECLARE @MailID nvarchar(2000)
DECLARE @Server varchar(100)
 
-- TODO: Set parameter values here.
 
EXECUTE @RC = [DBADB].[dbo].[SQLhealthcheck_report_new2]
 ''DBA''
,''mssqltechsupport@geopits.com;''
,''MISSERVERCLOUD''
,''Thyrocare''
GO

', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Every_6_AM', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20251229, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'41621b65-4cef-45f6-80d3-0479ab8724c7'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA High CPU Alert]    Script Date: 2/10/2026 6:29:03 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]    Script Date: 2/10/2026 6:29:03 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA High CPU Alert', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/10/2026 6:29:03 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE DBADB;
GO

SET NOCOUNT ON;

DECLARE @total_util_count INT, @total_avg FLOAT, @sql_avg FLOAT, @other_avg FLOAT;
DECLARE @cpu_threshold INT = 90; -- Threshold set to 90% CPU utilization
DECLARE @body_resp VARCHAR(200), @subject_resp VARCHAR(200), @content VARCHAR(MAX);
DECLARE @ServerName VARCHAR(200);
SET @ServerName = (Select @@SERVERNAME);

-- Drop the temporary table if it exists
IF OBJECT_ID(''tempdb.dbo.#cpu_util'', ''U'') IS NOT NULL
    DROP TABLE #cpu_util;

-- Create a temporary table to store CPU utilization data
CREATE TABLE #cpu_util (idle INT, sql INT, other INT);

-- Insert the last 5 records of CPU utilization where idle CPU is not null and other processes are not null
INSERT INTO #cpu_util
SELECT TOP 5 IdleCPU, SQLUtilisedCPU, OtherProsses
FROM [dbo].[CPUUtilisationdata]
WHERE IdleCPU IS NOT NULL AND OtherProsses IS NOT NULL
ORDER BY time DESC;

-- Get the count of records in the temporary table
SELECT @total_util_count = COUNT(*) FROM #cpu_util;

-- If there are at least 5 records, calculate the averages
IF @total_util_count = 5
BEGIN
    -- Calculate the total average CPU utilization, SQL utilization, and other processes utilization
    SELECT @total_avg = 100 - ROUND(AVG(CAST(idle AS FLOAT(2))), 2), 
           @sql_avg = ROUND(AVG(CAST(sql AS FLOAT(2))), 2), 
           @other_avg = ROUND(AVG(CAST(other AS FLOAT(2))), 2)
    FROM #cpu_util;
    
    -- If the average CPU utilization exceeds the threshold of 90%, send an email alert
    IF @total_avg > @cpu_threshold
    BEGIN
        -- Construct the email body with the CPU utilization details
		SET @Content= ''<p>Hello Team,</p>'' +
		''<p>Our DBAs have detected High CPU Utilization on <b>''+ @ServerName+ ''</b> Server , which may impact overall system performance.</p>''
        SET @body_resp = ''CPU Utilization is <span style="color:red;"> '' + CAST(@total_avg AS VARCHAR(8)) + ''</span>''+ ''% for the last 5 occurrences''
                 + ''<br/>'' + ''SQL Utilization: '' + CAST(@sql_avg AS VARCHAR(8)) + ''%''
                 + ''<br/>'' + ''Other Process Utilization: '' + CAST(@other_avg AS VARCHAR(8)) + ''%'';

        -- Construct the email subject
        SET @subject_resp = ''Thyrocare HIGH CPU Alert! CPU Utilization has reached '' + CAST(@total_avg AS VARCHAR(8)) + ''%'' + '' (''+@ServerName+'')''; --change1
        IF OBJECT_ID(''tempdb..#BlockingInfo'') IS NOT NULL DROP TABLE #BlockingInfo;
IF OBJECT_ID(''tempdb..#RequestInfo'') IS NOT NULL DROP TABLE #RequestInfo;
IF OBJECT_ID(''tempdb..#ConnectionStats'') IS NOT NULL DROP TABLE #ConnectionStats;

-- Create the temporary tables
CREATE TABLE #BlockingInfo (
    head_blocker_session_id INT,
    blocking_queries_count INT,
    head_blocker_query NVARCHAR(200)
);

CREATE TABLE #RequestInfo (
    session_id INT,
    duration_mm_ss VARCHAR(8),
    statement_text NVARCHAR(200),
    cpu_time_ms INT,
    logical_reads BIGINT,
    request_start_time DATETIME
);

CREATE TABLE #ConnectionStats (
    DBName NVARCHAR(128),
    NumberOfConnections INT
    
);

	-- Generate combined HTML for the email
	DECLARE @html NVARCHAR(MAX);
	DECLARE @full_body NVARCHAR(MAX);

	
-- Insert data into #BlockingInfo
WITH cteHead AS (
    SELECT 
        sess.session_id, 
        req.request_id, 
        LEFT(ISNULL(req.wait_type, ''''), 50) AS wait_type,
        LEFT(ISNULL(req.wait_resource, ''''), 40) AS wait_resource, 
        LEFT(req.last_wait_type, 50) AS last_wait_type,
        sess.is_user_process, 
        req.cpu_time AS request_cpu_time, 
        req.logical_reads AS request_logical_reads,
        req.reads AS request_reads, 
        req.writes AS request_writes, 
        req.wait_time, 
        req.blocking_session_id,
        sess.memory_usage,
        sess.cpu_time AS session_cpu_time, 
        sess.reads AS session_reads, 
        sess.writes AS session_writes, 
        sess.logical_reads AS session_logical_reads,
        CONVERT(decimal(5,2), req.percent_complete) AS percent_complete, 
        req.estimated_completion_time AS est_completion_time,
        req.start_time AS request_start_time, 
        LEFT(req.status, 15) AS request_status, 
        req.command,
        req.plan_handle, 
        req.sql_handle, 
        req.statement_start_offset, 
        req.statement_end_offset, 
        conn.most_recent_sql_handle,
        LEFT(sess.status, 15) AS session_status, 
        sess.group_id, 
        req.query_hash, 
        req.query_plan_hash
    FROM sys.dm_exec_sessions AS sess
    LEFT OUTER JOIN sys.dm_exec_requests AS req 
        ON sess.session_id = req.session_id
    LEFT OUTER JOIN sys.dm_exec_connections AS conn 
        ON conn.session_id = sess.session_id 
),
cteBlockingHierarchy AS (
    SELECT 
        head.session_id AS head_blocker_session_id, 
        head.session_id AS session_id, 
        head.blocking_session_id,
        head.wait_type, 
        head.wait_time, 
        head.wait_resource, 
        head.statement_start_offset, 
        head.statement_end_offset,
        head.plan_handle, 
        head.sql_handle, 
        head.most_recent_sql_handle, 
        0 AS Level
    FROM cteHead AS head
    WHERE (head.blocking_session_id IS NULL OR head.blocking_session_id = 0)
    AND head.session_id IN (SELECT DISTINCT blocking_session_id FROM cteHead WHERE blocking_session_id != 0)
    UNION ALL
    SELECT 
        h.head_blocker_session_id, 
        blocked.session_id, 
        blocked.blocking_session_id, 
        blocked.wait_type,
        blocked.wait_time, 
        blocked.wait_resource, 
        h.statement_start_offset, 
        h.statement_end_offset,
        h.plan_handle, 
        h.sql_handle, 
        h.most_recent_sql_handle, 
        [Level] + 1
    FROM cteHead AS blocked
    INNER JOIN cteBlockingHierarchy AS h 
        ON h.session_id = blocked.blocking_session_id 
        AND h.session_id != blocked.session_id -- Avoid infinite recursion for latch type of blocking
    WHERE h.wait_type COLLATE Latin1_General_BIN NOT IN (''EXCHANGE'', ''CXPACKET'') 
        OR h.wait_type IS NULL
)
INSERT INTO #BlockingInfo (head_blocker_session_id, blocking_queries_count, head_blocker_query)
SELECT 
    bh.head_blocker_session_id,
    COUNT(bh.session_id) - 1 AS blocking_queries_count,
    LEFT(txt.text, 200) AS head_blocker_query
FROM cteBlockingHierarchy AS bh
OUTER APPLY sys.dm_exec_sql_text(ISNULL(bh.sql_handle, bh.most_recent_sql_handle)) AS txt
GROUP BY bh.head_blocker_session_id, txt.text;

-- Insert data into #RequestInfo
INSERT INTO #RequestInfo (session_id, duration_mm_ss, statement_text, cpu_time_ms, logical_reads, request_start_time)
SELECT TOP 5
    req.session_id,
    -- Convert total_elapsed_time to hh:mm:ss format
    RIGHT(''0'' + CAST((req.total_elapsed_time / 3600000) AS VARCHAR(2)), 2) + '':'' +
    RIGHT(''0'' + CAST(((req.total_elapsed_time % 3600000) / 60000) AS VARCHAR(2)), 2) + '':'' +
    RIGHT(''0'' + CAST((((req.total_elapsed_time % 3600000) % 60000) / 1000) AS VARCHAR(2)), 2) AS duration_mm_ss,
    LEFT(
        REPLACE(
            REPLACE(
                SUBSTRING(
                    ST.text, 
                    (req.statement_start_offset / 2) + 1, 
                    ((CASE req.statement_end_offset
                        WHEN -1 THEN DATALENGTH(ST.text)
                        ELSE req.statement_end_offset
                     END - req.statement_start_offset) / 2) + 1
                ),
                CHAR(10), '' ''
            ), 
            CHAR(13), '' ''
        ),
        200
    ) AS statement_text,
    req.cpu_time AS cpu_time_ms,
    req.logical_reads,
    -- Get the start time formatted as yyyy-MM-dd HH:mm:ss
    req.start_time AS request_start_time
FROM sys.dm_exec_requests AS req
CROSS APPLY sys.dm_exec_sql_text(req.sql_handle) AS ST
WHERE req.total_elapsed_time / 60000 > 5
and LEFT(
        REPLACE(
            REPLACE(
                SUBSTRING(
                    ST.text, 
                    (req.statement_start_offset / 2) + 1, 
                    ((CASE req.statement_end_offset
                        WHEN -1 THEN DATALENGTH(ST.text)
                        ELSE req.statement_end_offset
                     END - req.statement_start_offset) / 2) + 1
                ),
                CHAR(10), '' ''
            ), 
            CHAR(13), '' ''
        ),
        200
    )not like  ''sp_server_diagnostics%'' 
	and    LEFT(
        REPLACE(
            REPLACE(
                SUBSTRING(
                    ST.text, 
                    (req.statement_start_offset / 2) + 1, 
                    ((CASE req.statement_end_offset
                        WHEN -1 THEN DATALENGTH(ST.text)
                        ELSE req.statement_end_offset
                     END - req.statement_start_offset) / 2) + 1
                ),
                CHAR(10), '' ''
            ), 
            CHAR(13), '' ''
        ),
        200
    )not like  ''%WAITFOR(RECEIVE conversation_handle%'' and    LEFT(
        REPLACE(
            REPLACE(
                SUBSTRING(
                    ST.text, 
                    (req.statement_start_offset / 2) + 1, 
                    ((CASE req.statement_end_offset
                        WHEN -1 THEN DATALENGTH(ST.text)
                        ELSE req.statement_end_offset
                     END - req.statement_start_offset) / 2) + 1
                ),
                CHAR(10), '' ''
            ), 
            CHAR(13), '' ''
        ),
        200
    )not like  ''BACKUP DATABASE%''
	
ORDER BY req.total_elapsed_time DESC;

-- Insert data into #ConnectionStats
INSERT INTO #ConnectionStats (DBName, NumberOfConnections)
SELECT 
    DB_NAME(dbid) AS DBName,
    COUNT(dbid) AS NumberOfConnections
    
FROM sys.sysprocesses
WHERE dbid > 5 and status <> ''sleeping'' and DB_NAME(dbid) not in (''DBADB'')
GROUP BY dbid
ORDER BY DB_NAME(dbid);


	-- Append rows for long running queries

SET @html = N''
		<html>''+
		''<head>'' +
		''<style>'' +
		''body { font-family: Arial, sans-serif; color: #333; line-height: 1.6; }'' +
		''table { width: 100%; border-collapse: collapse; margin-top: 20px; }'' +
		''table, th, td { border: 1px solid #ddd; }'' +
		''th, td { padding: 12px; text-align: centre; }'' +
		''th { background-color: #008bff; color: white; }'' +
		''tr:nth-child(even) { background-color: #f2f2f2; }'' +
		''p { margin: 0 0 10px; }'' +
		''h2 { color: #007bff; }'' +
		''</style>'' +
		''</head>''

IF EXISTS (SELECT 1 FROM #RequestInfo)
BEGIN

     set @html=@html+'' 
                  <h2>Long Running Queries</h2>
           <table>
               <tr>
                   <th>Session ID</th>
                   <th>Duration (hh:mm:ss)</th>
                   <th>Statement Text</th>
                   <th>CPU Time (ms)</th>
                   <th>Logical Reads</th>
                   <th>Request Start Time</th>
               </tr>'';

    SELECT @html = @html + 
    N''<tr>
	
        <td>'' + CAST(session_id AS NVARCHAR) + ''</td>
        <td>'' + duration_mm_ss + ''</td>
        <td>'' + statement_text + ''</td>
        <td>'' + CAST(cpu_time_ms AS NVARCHAR) + ''</td>
        <td>'' + CAST(logical_reads AS NVARCHAR) + ''</td>
        <td>'' + FORMAT(request_start_time, ''yyyy-MM-dd HH:mm:ss'') + ''</td>
    </tr>''
FROM #RequestInfo;

       -- Close the long Queries table
    SET @html = @html + 
        N''</table>'';
END
ELSE
BEGIN
    SET @html = @html + N''
    <h2>Long Running Queries</h2>
        <p>No long Running Queries more then 5 Minutes .</p>'';
		
END



-- Add Blocking Queries section if any blocking is detected
IF EXISTS (SELECT 1 FROM #BlockingInfo)
BEGIN
    SET @html = @html + N''
    <h2>Blocking Queries </h2>
    <table>
        <tr>
            <th>Head Blocker Session ID</th>
            <th>Blocking Queries Count</th>
            <th>Head Blocker Query</th>
        </tr>'';

    -- Append rows for blocking queries
    SELECT @html = @html + 
        N''<tr>
            <td>'' + CAST(head_blocker_session_id AS NVARCHAR) + ''</td>
            <td>'' + CAST(blocking_queries_count AS NVARCHAR) + ''</td>
            <td>'' + head_blocker_query + ''</td>
        </tr>''
    FROM #BlockingInfo;

    -- Close the Blocking Queries table
    SET @html = @html + 
        N''</table>'';
END
ELSE
BEGIN
    SET @html = @html + N''
    <h2>Blocking Queries </h2>
        <p>No blocking currently occurred.</p>'';
END

-- Add Connection Stats section
SET @html = @html + N''
    <h2>Connection Statistics</h2>
    <table border="1" cellpadding="5" cellspacing="0">
        <thead>
            <tr>
                <th>Database Name</th>
                <th>Number of Connections</th>
            </tr>
        </thead>
        <tbody>'';

-- Loop through the connection statistics and append each row
SELECT @html = @html + 
    N''<tr>
        <td>'' + DBName + ''</td>
        <td>'' + CAST(NumberOfConnections AS NVARCHAR) + ''</td>
    </tr>''
FROM #ConnectionStats;

-- Closing the table after appending the rows
SET @html = @html + N''</tbody></table>'';

DECLARE @Signature VARCHAR(MAX);

SET @Signature = ''<br>'' + 
    '' <p>Thanks for your attention.</p>'' +
    ''<p>Best Regards,<br>MSSQL DBA<br>GeoPITS</p>'' -- change 2
        -- Send the email using sp_send_dbmail
SET @full_body= @content+ @body_resp + @html + @Signature
        EXEC msdb.dbo.sp_send_dbmail
            @profile_name = ''DBA'', --change 3 client profiler
            @body = @full_body,
            @body_format=''HTML'',
            @recipients = ''mssqlalerts@geopits.com'', -- change 4 client mail , our mail
            @subject = @subject_resp;
    END
END

-- Drop the temporary table after use
IF OBJECT_ID(''tempdb.dbo.#cpu_util'', ''U'') IS NOT NULL
    DROP TABLE #cpu_util;

SET NOCOUNT OFF;
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=5, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20230209, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'82d20699-e6a5-4f86-b87a-eae8d8a085c0'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA JOB to find client ipaddress]    Script Date: 2/10/2026 6:29:03 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:03 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA JOB to find client ipaddress', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [collect logs]    Script Date: 2/10/2026 6:29:04 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'collect logs', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--CREATE TABLE SessionLogs (
--    LogID INT IDENTITY(1,1) PRIMARY KEY, -- Unique identifier for each log entry
--    SessionID INT,
--    HostName NVARCHAR(128),
--    ProgramName NVARCHAR(256),
--    LoginName NVARCHAR(128),
--    ClientIPAddress NVARCHAR(45), -- Supports IPv6
--    ServerIPAddress NVARCHAR(45), -- Supports IPv6
--    ConnectionStartTime DATETIME,
--    SessionStatus NVARCHAR(50),
--    CPUTime INT,
--    MemoryUsage INT,
--    LogTimestamp DATETIME DEFAULT GETDATE() -- Timestamp when the entry is logged
--);


INSERT INTO DBADB..SessionLogs (
    SessionID,
    HostName,
    ProgramName,
    LoginName,
    ClientIPAddress,
    ServerIPAddress,
    ConnectionStartTime,
    SessionStatus,
    CPUTime,
    MemoryUsage
)
SELECT 
    s.session_id AS SessionID,
    s.host_name AS HostName,
    s.program_name AS ProgramName,
    s.login_name AS LoginName,
    c.client_net_address AS ClientIPAddress,
    c.local_net_address AS ServerIPAddress,
    c.connect_time AS ConnectionStartTime,
    s.status AS SessionStatus,
    s.cpu_time AS CPUTime,
    s.memory_usage AS MemoryUsage
FROM sys.dm_exec_sessions s
JOIN sys.dm_exec_connections c
    ON s.session_id = c.session_id
WHERE s.is_user_process = 1 -- Exclude system sessions;', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'every 2 mins', 
		@enabled=0, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250225, 
		@active_end_date=20250311, 
		@active_start_time=100000, 
		@active_end_time=95959, 
		@schedule_uid=N'83ed1e1f-531d-4a10-9d53-bd90fa39597a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Long runing query alert]    Script Date: 2/10/2026 6:29:04 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:04 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Long runing query alert', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/10/2026 6:29:04 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @TABLE TABLE (
	[Instance_Name] [varchar](100) NULL,
	[Start_Time] [datetime] NULL,
	[SPID] [int] NULL,
	[User_Names] [varchar](300) NULL,
	[ServerName] [varchar](100) NULL,
	[Database_Names] [varchar](300) NULL,
	[Executing_Sql] [nvarchar](max) NULL,
	[wait_type] [varchar](300) NULL,
	[wait_time_Minutes] [decimal](10, 2) NULL
)
insert into  @TABLE
SELECT (select @@servicename)as Instance_Name,r.start_time [Start Time],
r.session_ID [SPID], c.login_name as User_Name,c.host_name as Server,
DB_NAME(r.database_id) [Database],
t.text as [Executing SQL],wait_type,cast(cast (wait_time/1000 as decimal(10,2))/60 as decimal(10,2))as wait_time
FROM sys.dm_exec_requests r OUTER APPLY sys.dm_exec_sql_text(sql_handle) t inner join sys.dm_exec_sessions c on 
r.session_id =c.session_id
WHERE r.session_id != @@SPID and r.session_id > 50 and wait_time>600000 and DB_NAME(r.database_id) not in (''master'',''msdb'')

--insert into  DBADB.dbo.LongRunningQueries
--SELECT Instance_Name,Start_Time,SPID,User_Names,ServerName,Database_Names,Executing_Sql,wait_type,wait_time_Minutes from @TABLE

SET NOCOUNT ON
DECLARE  @xml nvarchar(max)
SELECT @xml = Cast((SELECT Instance_Name AS ''td'',
'''',
Start_Time AS ''td'',
'''',
SPID AS ''td'',
'''',
User_Names AS ''td'',
'''',
ServerName AS ''td'',
'''',
Database_Names AS ''td'',
'''',
SUBSTRING(Executing_Sql,1,100) AS ''td'',
'''',
wait_type AS ''td'',
'''',
wait_time_Minutes AS ''td''
FROM @TABLE
FOR xml path(''tr''), elements) AS NVARCHAR(max))
Declare @body nvarchar(max)
SET @body =
''<html>
	<head>
		<style>
			table, th, td 
			{
				border: 1px solid black;
				border-collapse: collapse;
				text-align: center;
			}
		</style>
	</head>
	<body>
		<H2>
		Long Running Quries: 192.168.6.140
		</H2>
		<table> 
			<tr>
				<th> Instance Name </th> <th> Start_Time </th> <th> SPID</th> <th> User_Names </th>
				<th> Host Name </th> <th> Database_Names </th> <th> Executing_Sql</th> <th> wait_type </th><th> wait_time_Minutes </th>
			</tr>''
			SET @body = @body + @xml + ''
		</table>
	</body>
</html>''
if(@xml is not null)
BEGIN
EXEC msdb.dbo.Sp_send_dbmail
@profile_name = ''DBA'',
@body = @body,
@body_format =''html'',
@recipients = '' mssqlsupport@geopits.com;analytics@thyrocare.com'',
@copy_recipients =''aswin.kumarvpkothuru@thyrocare.com;retheesh.pillai@thyrocare.com;db@thyrocare.com;kumar.akarsh@pharmeasy.in'',
@blind_copy_recipients='''',
@subject = ''Long Running Quries:192.168.6.140'';
END
SET NOCOUNT OFF', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Optimize_plan]    Script Date: 2/10/2026 6:29:04 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Optimize_plan', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'-- ==============================================================
-- Top 10 Expensive Queries with Execution Plan (for Optimization)
-- ==============================================================

SET NOCOUNT ON;

SELECT TOP 10
    DB_NAME(qt.dbid) AS [DatabaseName],
    qs.execution_count AS [ExecutionCount],
    CAST((qs.total_worker_time / qs.execution_count) / 1000.0 AS DECIMAL(18,2)) AS [AvgCPU_ms],
    CAST((qs.total_logical_reads / qs.execution_count) AS DECIMAL(18,2)) AS [AvgLogicalReads],
    CAST((qs.total_elapsed_time / qs.execution_count) / 1000.0 AS DECIMAL(18,2)) AS [AvgDuration_ms],
    LEFT(REPLACE(REPLACE(SUBSTRING(qt.text, (qs.statement_start_offset/2)+1,
        ((CASE qs.statement_end_offset
            WHEN -1 THEN DATALENGTH(qt.text)
            ELSE qs.statement_end_offset END
          - qs.statement_start_offset)/2)+1), CHAR(10), '' ''), CHAR(13), '' ''), 500) AS [QuerySnippet],
    qp.query_plan AS [ExecutionPlan_XML]
FROM sys.dm_exec_query_stats AS qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) AS qt
CROSS APPLY sys.dm_exec_query_plan(qs.plan_handle) AS qp
WHERE qt.dbid > 4   -- exclude system databases
ORDER BY qs.total_worker_time DESC;
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Next]    Script Date: 2/10/2026 6:29:04 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Next', 
		@step_id=3, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'-- Optional: summarized execution plan details
SELECT TOP 10
    DB_NAME(qt.dbid) AS [DatabaseName],
    qs.execution_count AS [ExecutionCount],
    CAST((qs.total_worker_time / qs.execution_count) / 1000.0 AS DECIMAL(18,2)) AS [AvgCPU_ms],
    CAST((qs.total_logical_reads / qs.execution_count) AS DECIMAL(18,2)) AS [AvgLogicalReads],
    CAST((qs.total_elapsed_time / qs.execution_count) / 1000.0 AS DECIMAL(18,2)) AS [AvgDuration_ms],
    LEFT(REPLACE(REPLACE(SUBSTRING(qt.text, (qs.statement_start_offset/2)+1,
        ((CASE qs.statement_end_offset
            WHEN -1 THEN DATALENGTH(qt.text)
            ELSE qs.statement_end_offset END
          - qs.statement_start_offset)/2)+1), CHAR(10), '' ''), CHAR(13), '' ''), 500) AS [QuerySnippet],
    CASE 
        WHEN qp.query_plan.value(''count(//RelOp[@PhysicalOp="Table Scan"])'', ''int'') > 0 THEN ''Table Scan''
        WHEN qp.query_plan.value(''count(//RelOp[@PhysicalOp="Index Scan"])'', ''int'') > 0 THEN ''Index Scan''
        WHEN qp.query_plan.value(''count(//RelOp[@PhysicalOp="Key Lookup"])'', ''int'') > 0 THEN ''Key Lookup''
        ELSE ''Optimal Plan''
    END AS [PlanObservation]
FROM sys.dm_exec_query_stats AS qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) AS qt
CROSS APPLY sys.dm_exec_query_plan(qs.plan_handle) AS qp
WHERE qt.dbid > 4
ORDER BY qs.total_worker_time DESC;
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [long_running]    Script Date: 2/10/2026 6:29:04 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'long_running', 
		@step_id=4, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'WITH RankedQueries AS
(
    SELECT 
        [StartTime] AS [Start Time],
        [ElapsedTime] AS [Elapsed Time],
        [DatabaseName] AS [Database Name],
        [StatementText] AS [Statement Text],
        [StoredProcedure] AS [Stored Procedure],
        [WaitType] AS [Wait Type],
        ROW_NUMBER() OVER (
            PARTITION BY [StoredProcedure]
            ORDER BY TRY_CAST([ElapsedTime] AS FLOAT) DESC
        ) AS rn
    FROM [DBADB].[dbo].[longqrydetails]
    WHERE [StartTime] BETWEEN DATEADD(DAY, -15, GETDATE()) AND GETDATE()
)
SELECT TOP 50
    [Start Time],
    [Elapsed Time],
    [Database Name],
    [Statement Text],
    [Stored Procedure],
    [Wait Type]
FROM RankedQueries
WHERE rn = 1
ORDER BY [Elapsed Time]  DESC;
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=10, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20230209, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'ed7ff164-34b2-47a7-937f-0c33cf8cd065'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Perfmon colloction]    Script Date: 2/10/2026 6:29:04 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:04 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Perfmon colloction', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/10/2026 6:29:04 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE DBADB
GO
SET NOCOUNT ON;
DECLARE @PerfCounters TABLE
    (
      [Counter] NVARCHAR(770) ,
      [CounterType] INT ,
      [FirstValue] DECIMAL(38, 2) ,
      [FirstDateTime] DATETIME ,
      [SecondValue] DECIMAL(38, 2) ,
      [SecondDateTime] DATETIME ,
      [ValueDiff] AS ( [SecondValue] - [FirstValue] ) ,
      [TimeDiff] AS ( DATEDIFF(SS, FirstDateTime, SecondDateTime) ) ,
      [CounterValue] DECIMAL(38, 2)
    );
INSERT  INTO @PerfCounters
        ( [Counter] ,
          [CounterType] ,
          [FirstValue] ,
          [FirstDateTime]
        )
        SELECT  RTRIM([object_name]) + N'':'' + RTRIM([counter_name]) + N'':''
                + RTRIM([instance_name]) ,
                [cntr_type] ,
                [cntr_value] ,
                GETDATE()
        FROM    sys.dm_os_performance_counters
        WHERE   [counter_name] IN ( N''Page life expectancy'',
                                    N''Lazy writes/sec'', N''Page reads/sec'',
                                    N''Page writes/sec'', N''Free Pages'',
                                    N''Free list stalls/sec'',
                                    N''User Connections'',
                                    N''Lock Waits/sec'',
                                    N''Number of Deadlocks/sec'',
                                    N''Transactions/sec'',
                                    N''Forwarded Records/sec'',
                                    N''Index Searches/sec'',
                                    N''Full Scans/sec'',
                                    N''Batch Requests/sec'',
                                    N''SQL Compilations/sec'',
                                    N''SQL Re-Compilations/sec'',
                                    N''Total Server Memory (KB)'',
                                    N''Target Server Memory (KB)'',
                                    N''Latch Waits/sec'' )
        ORDER BY [object_name] + N'':'' + [counter_name] + N'':''
                + [instance_name];
WAITFOR DELAY ''00:00:10'';
UPDATE  @PerfCounters
SET     [SecondValue] = [cntr_value] ,
        [SecondDateTime] = GETDATE()
FROM    sys.dm_os_performance_counters
WHERE   [Counter] = RTRIM([object_name]) + N'':'' + RTRIM([counter_name])
                                                                  + N'':''
        + RTRIM([instance_name])
        AND [counter_name] IN ( N''Page life expectancy'', 
                                N''Lazy writes/sec'',
                                N''Page reads/sec'', N''Page writes/sec'',
                                N''Free Pages'', N''Free list stalls/sec'',
                                N''User Connections'', N''Lock Waits/sec'',
                                N''Number of Deadlocks/sec'',
                                N''Transactions/sec'',
                                N''Forwarded Records/sec'',
                                N''Index Searches/sec'', N''Full Scans/sec'',
                                N''Batch Requests/sec'',
                                N''SQL Compilations/sec'',
                                N''SQL Re-Compilations/sec'',
                                N''Total Server Memory (KB)'',
                                N''Target Server Memory (KB)'',
                                N''Latch Waits/sec'' );
UPDATE  @PerfCounters
SET     [CounterValue] = [ValueDiff] / [TimeDiff]
WHERE   [CounterType] = 272696576;
UPDATE  @PerfCounters
SET     [CounterValue] = [SecondValue]
WHERE   [CounterType] <> 272696576;
INSERT  INTO [dbo].[PerfMonData]
        ( [Counter] ,
          [Value] ,
          [CaptureDate]
        )
        SELECT  [Counter] ,
                [CounterValue] ,
                [SecondDateTime]
        FROM    @PerfCounters;
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N's1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20240319, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'e675de59-5282-4c36-80f1-3ea8f6dd7817'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Table Size Data]    Script Date: 2/10/2026 6:29:04 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:04 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Table Size Data', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s1]    Script Date: 2/10/2026 6:29:04 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'insert into DBADB.dbo.TableSizeData
exec sp_MSforeachdb ''USE [?]

SELECT 
db_id(),
db_name(),
    t.NAME AS TableName,
    s.Name AS SchemaName,
    p.rows,
    SUM(a.total_pages) * 8 AS TotalSpaceKB, 
    CAST(ROUND(((SUM(a.total_pages) * 8) / 1024.00), 2) AS NUMERIC(36, 2)) AS TotalSpaceMB,
    SUM(a.used_pages) * 8 AS UsedSpaceKB, 
    CAST(ROUND(((SUM(a.used_pages) * 8) / 1024.00), 2) AS NUMERIC(36, 2)) AS UsedSpaceMB, 
    (SUM(a.total_pages) - SUM(a.used_pages)) * 8 AS UnusedSpaceKB,
    CAST(ROUND(((SUM(a.total_pages) - SUM(a.used_pages)) * 8) / 1024.00, 2) AS NUMERIC(36, 2)) AS UnusedSpaceMB,
	getdate()
FROM 
    sys.tables t
INNER JOIN      
    sys.indexes i ON t.OBJECT_ID = i.object_id
INNER JOIN 
    sys.partitions p ON i.object_id = p.OBJECT_ID AND i.index_id = p.index_id
INNER JOIN 
    sys.allocation_units a ON p.partition_id = a.container_id
LEFT OUTER JOIN 
    sys.schemas s ON t.schema_id = s.schema_id
WHERE 
    t.NAME NOT LIKE ''''dt%'''' 
    AND t.is_ms_shipped = 0
    AND i.OBJECT_ID > 255 
GROUP BY 
    t.Name, s.Name, p.Rows
ORDER BY 
    TotalSpaceMB DESC, t.Name''', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N's1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20240319, 
		@active_end_date=99991231, 
		@active_start_time=120000, 
		@active_end_time=235959, 
		@schedule_uid=N'3fcd9a10-fead-4332-b9a4-3bc7affb056f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA UnusedIndex Report]    Script Date: 2/10/2026 6:29:05 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:05 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA UnusedIndex Report', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s1]    Script Date: 2/10/2026 6:29:05 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @subjectcontent NVARCHAR(512);
DECLARE @ServerName NVARCHAR(512);

SET @ServerName = @@servername;--Change if required
SET @subjectcontent = ''Thyrocare '' + @ServerName + '' Unused Index Report '' + FORMAT(GETDATE(), ''yyyy-MM-dd HH:mm'');--Change

EXEC dbadb.dbo.DBAUnusedIndexReport 
    @subjectcontent = @subjectcontent,
    @ServerName = @ServerName,
    @Recipient = ''mssqlsupport@geopits.com'', --Change
    @DBProfile = ''DBA'';--Change', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'daily6pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250127, 
		@active_end_date=99991231, 
		@active_start_time=180000, 
		@active_end_time=235959, 
		@schedule_uid=N'4f4cbd9a-3e9b-4f89-a883-7e3f28b2029c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA Wait Stat Collection]    Script Date: 2/10/2026 6:29:05 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:05 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA Wait Stat Collection', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Data_Colleciton]    Script Date: 2/10/2026 6:29:06 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Data_Colleciton', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE DBADB
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
GO

WITH [Waits] AS
(
	SELECT	[wait_type],
			[wait_time_ms] / 1000.0 AS [WaitS],
			([wait_time_ms] - [signal_wait_time_ms]) / 1000.0 AS [ResourceS],
			[signal_wait_time_ms] / 1000.0 AS [SignalS],
			[waiting_tasks_count] AS [WaitCount],
			100.0 * [wait_time_ms] / SUM ([wait_time_ms]) OVER() AS [Percentage],
			ROW_NUMBER() OVER(ORDER BY [wait_time_ms] DESC) AS [RowNum]
    FROM	sys.dm_os_wait_stats
    WHERE	[wait_type] NOT IN
	(
		N''BROKER_EVENTHANDLER'',         N''BROKER_RECEIVE_WAITFOR'',
		N''BROKER_TASK_STOP'',            N''BROKER_TO_FLUSH'',
		N''BROKER_TRANSMITTER'',          N''CHECKPOINT_QUEUE'',
		N''CHKPT'',                       N''CLR_AUTO_EVENT'',
		N''CLR_MANUAL_EVENT'',            N''CLR_SEMAPHORE'',
		N''DBMIRROR_DBM_EVENT'',          N''DBMIRROR_EVENTS_QUEUE'',
		N''DBMIRROR_WORKER_QUEUE'',       N''DBMIRRORING_CMD'',
		N''DIRTY_PAGE_POLL'',             N''DISPATCHER_QUEUE_SEMAPHORE'',
		N''EXECSYNC'',                    N''FSAGENT'',
		N''FT_IFTS_SCHEDULER_IDLE_WAIT'', N''FT_IFTSHC_MUTEX'',
		N''HADR_CLUSAPI_CALL'',           N''HADR_FILESTREAM_IOMGR_IOCOMPLETION'',
		N''HADR_LOGCAPTURE_WAIT'',        N''HADR_NOTIFICATION_DEQUEUE'',
		N''HADR_TIMER_TASK'',             N''HADR_WORK_QUEUE'',
		N''KSOURCE_WAKEUP'',              N''LAZYWRITER_SLEEP'',
		N''LOGMGR_QUEUE'',                N''ONDEMAND_TASK_QUEUE'',
		N''PWAIT_ALL_COMPONENTS_INITIALIZED'',
		N''QDS_PERSIST_TASK_MAIN_LOOP_SLEEP'',
		N''QDS_CLEANUP_STALE_QUERIES_TASK_MAIN_LOOP_SLEEP'',
		N''REQUEST_FOR_DEADLOCK_SEARCH'', N''RESOURCE_QUEUE'',
		N''SERVER_IDLE_CHECK'',           N''SLEEP_BPOOL_FLUSH'',
		N''SLEEP_DBSTARTUP'',             N''SLEEP_DCOMSTARTUP'',
		N''SLEEP_MASTERDBREADY'',         N''SLEEP_MASTERMDREADY'',
		N''SLEEP_MASTERUPGRADED'',        N''SLEEP_MSDBSTARTUP'',
		N''SLEEP_SYSTEMTASK'',            N''SLEEP_TASK'',
		N''SLEEP_TEMPDBSTARTUP'',         N''SNI_HTTP_ACCEPT'',
		N''SP_SERVER_DIAGNOSTICS_SLEEP'', N''SQLTRACE_BUFFER_FLUSH'',
		N''SQLTRACE_INCREMENTAL_FLUSH_SLEEP'',
		N''SQLTRACE_WAIT_ENTRIES'',       N''WAIT_FOR_RESULTS'',
		N''WAITFOR'',                     N''WAITFOR_TASKSHUTDOWN'',
		N''WAIT_XTP_HOST_WAIT'',          N''WAIT_XTP_OFFLINE_CKPT_NEW_LOG'',
		N''WAIT_XTP_CKPT_CLOSE'',         N''XE_DISPATCHER_JOIN'',
		N''XE_DISPATCHER_WAIT'',          N''XE_TIMER_EVENT'',
		N''QDS_SHUTDOWN_QUEUE'')
	AND	waiting_tasks_count > 0
	)
	INSERT into DBADB.[dbo].[WaitStatData] 
	SELECT MAX ([W1].[wait_type]) AS [WaitType],
		CAST (MAX ([W1].[WaitS]) AS DECIMAL (16,2)) AS [Wait_S],
		--CAST (MAX ([W1].[ResourceS]) AS DECIMAL (16,2)) AS [Resource_S],
		CAST (MAX ([W1].[SignalS]) AS DECIMAL (16,2)) AS [Signal_S],
		MAX ([W1].[WaitCount]) AS [WaitCount],
		CAST (MAX ([W1].[Percentage]) AS DECIMAL (5,2)) AS [Percentage],
		CAST ((MAX ([W1].[WaitS]) / MAX ([W1].[WaitCount])) AS DECIMAL (16,4)) AS [AvgWait_S],
		--CAST ((MAX ([W1].[ResourceS]) / MAX ([W1].[WaitCount])) AS DECIMAL (16,4)) AS [AvgRes_S],
		--CAST ((MAX ([W1].[SignalS]) / MAX ([W1].[WaitCount])) AS DECIMAL (16,4)) AS [AvgSig_S],
		--''http://documentation.red-gate.com/display/SM4/'' + W1.wait_type AS [DocumentLink],
		Getdate()
FROM	[Waits] AS [W1] INNER JOIN [Waits] AS [W2]
		ON ([W2].[RowNum] <= [W1].[RowNum])
GROUP BY
		[W1].[RowNum],
		W1.wait_type
HAVING	SUM ([W2].[Percentage]) - MAX ([W1].[Percentage]) < 99.9;
GO
DBCC SQLPERF("sys.dm_os_wait_stats",CLEAR);
go
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
GO
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Every_1 Hour', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20251229, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'119a3489-c56a-4d49-b173-e4c4965bb317'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Auto_Kill_Long_Running_iisuser_90_Minutes]    Script Date: 2/10/2026 6:29:06 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:06 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Auto_Kill_Long_Running_iisuser_90_Minutes', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Auto_Kill_iisuser]    Script Date: 2/10/2026 6:29:07 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Auto_Kill_iisuser', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @session_id INT;
DECLARE @kill_cmd NVARCHAR(100);

DECLARE cur CURSOR FAST_FORWARD FOR
SELECT 
    DISTINCT s.session_id
        		
    FROM sys.dm_exec_sessions s
    LEFT JOIN sys.dm_exec_requests r ON s.session_id = r.session_id
    LEFT JOIN sys.dm_exec_connections c ON s.session_id = c.session_id
	left join sys.dm_exec_cached_plans cp on r.plan_handle=cp.plan_handle
    OUTER APPLY sys.dm_exec_sql_text(
        CASE 
            WHEN r.sql_handle IS NOT NULL THEN r.sql_handle
            ELSE c.most_recent_sql_handle
        END
    ) AS st
    WHERE s.session_id>50
	and cp.objtype=''Adhoc''  
	AND st.objectid is null
    AND s.is_user_process = 1
    AND s.session_id <> @@SPID
    AND r.command=''SELECT''
    AND s.login_name =''iisuser''  -- Change the username on the based on server login name
    AND (
        -- Running or sleeping more than 90 mins 
        DATEDIFF(MINUTE, s.last_request_end_time, GETDATE()) >= 90
        
    );

OPEN cur;
FETCH NEXT FROM cur INTO @session_id;

WHILE @@FETCH_STATUS = 0
BEGIN
    INSERT INTO dbadb.dbo.KilledSessionsLog (
        SessionID, LoginName, HostName, ProgramName, Status, LastRequestEndTime, LoginTime, SqlText, ObjectName, WaitType, DatabaseName, OpenTranCount
    )
    SELECT 
        s.session_id,
        s.login_name,
        s.host_name,
        s.program_name,
        s.status,
        s.last_request_end_time,
        s.login_time,
        st.text AS SqlText,
        COALESCE(
            QUOTENAME(DB_NAME(st.dbid)) + N''.'' + 
            QUOTENAME(OBJECT_SCHEMA_NAME(st.objectid, st.dbid)) + N''.'' + 
            QUOTENAME(OBJECT_NAME(st.objectid, st.dbid)), 
            ''Query''
        ) AS ObjectName,
        r.wait_type,
        DB_NAME(s.database_id) AS DatabaseName,
        s.open_transaction_count
    FROM sys.dm_exec_sessions s
    LEFT JOIN sys.dm_exec_requests r ON s.session_id = r.session_id
    LEFT JOIN sys.dm_exec_connections c ON s.session_id = c.session_id
    OUTER APPLY sys.dm_exec_sql_text(
        CASE 
            WHEN r.sql_handle IS NOT NULL THEN r.sql_handle
            ELSE c.most_recent_sql_handle
        END
    ) AS st
    WHERE s.session_id = @session_id;

    PRINT ''Killing session: '' + CAST(@session_id AS VARCHAR(10));

    SET @kill_cmd = ''KILL '' + CAST(@session_id AS VARCHAR(10));
    EXEC sp_executesql @kill_cmd;

    FETCH NEXT FROM cur INTO @session_id;
END

CLOSE cur;
DEALLOCATE cur;
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Every_5_Minutes', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=5, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250805, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'd692270f-c080-4523-8f75-5826bc5fac04'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Auto_Killed_SELECT_Queries_Report]    Script Date: 2/10/2026 6:29:07 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:07 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Auto_Killed_SELECT_Queries_Report', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Report]    Script Date: 2/10/2026 6:29:07 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Report', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @sql TABLE(
    SessionID INT,
    LoginName NVARCHAR(128),
    HostName NVARCHAR(128),
    ProgramName NVARCHAR(128),
    Status NVARCHAR(30),
    LastRequestEndTime DATETIME,
    LoginTime DATETIME,
    SqlText NVARCHAR(MAX),
    ObjectName NVARCHAR(512),
    WaitType NVARCHAR(60),
    DatabaseName NVARCHAR(128),
    OpenTranCount INT NULL
);

-- Insert yesterday''s killed session details
INSERT INTO @sql
SELECT  [SessionID],
        [LoginName],
        [HostName],
        [ProgramName],
        [Status],
        [LastRequestEndTime],
        [LoginTime],
        [SqlText],
        [ObjectName],
        [WaitType],
        [DatabaseName],
        [OpenTranCount]
FROM [DBADB].[dbo].[KilledSessionsLog]
WHERE CAST(LastRequestEndTime AS date) = CAST(GETDATE() - 1 AS date);

-- Variables for email
SET NOCOUNT ON;
DECLARE @xml NVARCHAR(MAX),
        @body NVARCHAR(MAX),
        @ServerName NVARCHAR(128) = @@SERVERNAME,
        @ReportDate NVARCHAR(20) = CONVERT(VARCHAR(10), GETDATE()-1, 105), -- dd-mm-yyyy
        @subject NVARCHAR(200);

IF EXISTS (SELECT 1 FROM @sql)
BEGIN
    -- Convert result to HTML rows
    SELECT @xml = CAST(( 
        SELECT  SessionID AS ''td'','''',
                LoginName AS ''td'','''',
                HostName AS ''td'','''',
                ProgramName AS ''td'','''',
                Status AS ''td'','''',
                LastRequestEndTime AS ''td'','''',
                LoginTime AS ''td'','''',
                SqlText AS ''td'','''',
                ObjectName AS ''td'','''',
                WaitType AS ''td'','''',
                DatabaseName AS ''td'','''',
                OpenTranCount AS ''td'',''''
        FROM @sql
        FOR XML PATH(''tr''), ELEMENTS
    ) AS NVARCHAR(MAX));

    SET @body = 
    ''<html>
        <head>
            <style>
                table, th, td { border: 1px solid #ddd; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th { background-color: #008bff; color: white; }
                th, td { padding: 12px; text-align: center; }
                tr:nth-child(even) { background-color: #f2f2f2; }
                h2 { color: #007bff; }
            </style>
        </head>
        <body>
            <H2>Automatic Killed SELECT Queries (Login: iisuser, Duration > 90 Minutes)</H2>
            <p>Report Date: ''+@ReportDate+'' | Server: ''+@ServerName+''</p>
            <table>
                <tr>
                    <th>SessionID</th><th>LoginName</th><th>HostName</th><th>ProgramName</th>
                    <th>Status</th><th>LastRequestEndTime</th><th>LoginTime</th>
                    <th>SqlText</th><th>ObjectName</th><th>WaitType</th>
                    <th>DatabaseName</th><th>OpenTranCount</th>
                </tr>'' 
                + @xml +
            ''</table>
        </body>
    </html>'';

    SET @subject = ''Killed SELECT Queries (Login: iisuser >90 Min) - '' 
                    + @ServerName + '' - '' + @ReportDate;

    -- Send email only if data exists
    EXEC msdb.dbo.sp_send_dbmail
        @profile_name = ''DBA'',
        @body = @body,
        @body_format =''HTML'',
		@recipients = ''aswin.kumarvpkothuru@thyrocare.com;nikhil@pharmeasy.in;ankit.g@pharmeasy.in;rajesh.n@pharmeasy.in;pushparaj.j@pharmeasy.in'',
        @subject = @subject;
END
ELSE 
PRINT(''Skipping the Mail'')', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'EveryDay12_AM', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250806, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'df104c9c-e20b-4de4-b834-24d09ae45897'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_BWR_extraction]    Script Date: 2/10/2026 6:29:07 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:07 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_BWR_extraction', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'modifed to exclude all database table excpt DWH database', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s1]    Script Date: 2/10/2026 6:29:07 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE [DBADB];

 
DECLARE @data_extract_query Report_Data_Query;
 
INSERT INTO @data_extract_query
VALUES
(''cpu_usage'', ''
            SELECT
                [Time],
                [IdleCPU] AS [Idle_CPU],
                [SQLUtilisedCPU] AS [SQL Utilised CPU],
                [Otherprosses] AS [Other Processes]
            FROM [DBADB].[dbo].[CPUUtilisationdata]
            WHERE [Time] >= DATEADD(DAY, -15, GETDATE())''),
(''peak_cpu_usage'', ''
            SELECT TOP 10
                [Time],
                [IdleCPU] AS [Idle_CPU],
                [SQLUtilisedCPU] AS [SQL Utilised CPU],
                [Otherprosses] AS [Other Processes]
            FROM [DBADB].[dbo].[CPUUtilisationdata]
            WHERE [Time] >= DATEADD(DAY, -15, GETDATE())
            ORDER BY SQLUtilisedCPU DESC''),
(''user_connection_insights'', ''
            SELECT
                [CaptureDate] AS [Time],
                [Value] AS [Transactions]
            FROM [DBADB].[dbo].[PerfMonData]
            WHERE CaptureDate >= DATEADD(DAY, -15, GETDATE())
                AND Counter = ''''SQLServer:General Statistics:User Connections:''''''),
(''peak_user_connection_insights'', ''SELECT TOP 10
                [CaptureDate] AS [Time],
                [Value] AS [Transactions]
            FROM [DBADB].[dbo].[PerfMonData]
            WHERE CaptureDate >= DATEADD(DAY, -15, GETDATE())
                AND Counter = ''''SQLServer:General Statistics:User Connections:''''
            ORDER BY Value DESC''),
(''row_count'', ''
SELECT Top 10
DBNAME, 
TableName, 
(SELECT TOp 1 rows FROM [DBADB].[dbo].[TableSizeData] 
	WHERE TableName = TSD.TableName 
	-- AND DBNAME NOT IN ()
	AND DBNAME = TSD.DBNAME 
	AND Date = DATEADD(day, -15, TSD.Date)) AS [15 Days before Row Count],
TSD.rows AS [Current RowCount],
TotalSpaceMB 
FROM [DBADB].[dbo].[TableSizeData] TSD
WHERE Date = (SELECT MAX(Date) FROM [DBADB].[dbo].[TableSizeData])
and DBName IN (''''DWH'''') 
  AND TableName NOT LIKE ''''%$%''''
  AND DBName NOT LIKE ''''THYROCARE_%''''
  -- Exclude archival DBs
  AND DBName NOT LIKE ''''charbi_%''''  -- Exclude archival DBs
  AND DBName NOT LIKE ''''MINILab_%''''
  AND DBName NOT LIKE ''''Labso_%'''' 
ORDER BY TotalSpaceMB DESC
''),
(''db_sizes'', ''
            SELECT
                a.Instance_Name AS [Instance Name],
                a.Database_Names AS [Database Name],
                b.size2 AS [15 Days before DB size (MB)],
                a.size1 AS [Current size (MB)],
                CAST(CAST(((a.size1 - b.size2)/b.size2 * 100) AS DECIMAL(6,2)) AS VARCHAR(100)) AS [Difference]
            FROM (
                SELECT
                    Database_Names,
                    Instance_Name,
                    [Size MB] AS size1
                FROM DBADB.dbo.DB_Meta
                WHERE Dates = CAST(GETDATE()-1 AS DATE)) AS a INNER JOIN (
                    SELECT
                        Database_Names,
                        Instance_Name,
                        [Size MB] AS size2
                    FROM DBADB.dbo.DB_Meta
                    WHERE Dates = CAST(GETDATE()-15 AS DATE)) AS b
                ON a.Database_Names = b.Database_Names
                    AND a.Instance_Name = b.Instance_Name
            WHERE a.Database_Names IN (''''DWH'''')
            ORDER BY a.Instance_Name''),
(''peak_table_usage'', ''SELECT TOP 10 
    @@SERVERNAME AS [Instance Name],
    a.DBName AS [Database Name],
    a.TableName AS [Table Name],
    b.size2 AS [15 days before size (MB)],
    a.size1 AS [Current size (MB)],
    CAST(CAST(((a.size1 - b.size2) / b.size2 * 100) AS DECIMAL(18,2)) AS VARCHAR(100)) AS [Difference in %]
FROM 
(
    SELECT  
        DBName,
        TableName,
        SUM(TotalSpaceMB) AS size1  
    FROM [DBADB].[dbo].[TableSizeData]
    WHERE Date = CAST(GETDATE() - 1 AS DATE)
    GROUP BY DBName, TableName 
) AS a
INNER JOIN
(
    SELECT  
        DBName,
        TableName,
        SUM(TotalSpaceMB) AS size2  
    FROM [DBADB].[dbo].[TableSizeData]  
    WHERE Date = CAST(GETDATE() - 14 AS DATE)
    GROUP BY DBName, TableName 
) AS b
    ON a.DBName = b.DBName
   AND a.TableName = b.TableName
WHERE a.DBName IN (''''DWH'''') 
  AND a.TableName NOT LIKE ''''%$%''''
  AND a.DBName NOT LIKE ''''THYROCARE_%''''
  -- Exclude archival DBs
  AND a.DBName NOT LIKE ''''charbi_%''''   -- Exclude archival DBs
  AND a.DBName NOT LIKE ''''MINILab_%''''
  AND a.DBName NOT LIKE ''''Labso_%''''
ORDER BY a.size1 DESC

'')
--(''maintenance_plan_status'', ''
--            SELECT
--                [Job Name],
--                CASE
--                    WHEN run_status = 1 THEN ''''Succeeded''''
--                    WHEN run_status = 0 THEN ''''Failed''''
--                    WHEN run_status = 3 THEN ''''Cancelled''''
--                    ELSE ''''Unknown''''
--                END AS [Job Status],
--                run_date AS [Last Run Date]
--            FROM
--            (
--                SELECT
--                    jobs.name AS [Job Name],
--                    jobhistory.run_status,
--                    jobhistory.run_date,
--                    ROW_NUMBER() OVER (PARTITION BY jobs.name ORDER BY jobhistory.run_date DESC) AS RowNum
--                FROM msdb.dbo.sysjobs AS jobs
--                JOIN msdb.dbo.sysjobhistory AS jobhistory
--                    ON jobs.job_id = jobhistory.job_id
--                WHERE jobs.name LIKE ''''DBA_IndexOptimize''''
--                OR jobs.name LIKE ''''%Update%''''
--            ) AS LastJobRun
--            WHERE RowNum = 1
--        '');
 
 

 
EXEC [dbadb].[dbo].[report_aut_send_extracted_data]
    @company_name = ''thyrocare'',
    @extraction_queries = @data_extract_query,
    @profile_name=''DBA'',
    @recipients=''dccagent@geopits.com''', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Tuesday7AM', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=4, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20250506, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'64de2959-31d9-4215-870c-484f10103ede'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Data_File_Space_Collection]    Script Date: 2/10/2026 6:29:07 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:07 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Data_File_Space_Collection', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [script]    Script Date: 2/10/2026 6:29:07 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'script', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @sql NVARCHAR(MAX) = '''';

IF OBJECT_ID(''tempdb..#FreeSpace'') IS NOT NULL
    DROP TABLE #FreeSpace;

CREATE TABLE #FreeSpace (
    DatabaseName SYSNAME,
    DataFileName SYSNAME,
	Physical_File_Location NVARCHAR(MAX),
    TotalSizeGB DECIMAL(18,2),
    UsedSpaceGB DECIMAL(18,2),
    FreeSpaceGB DECIMAL(18,2)
);

-- Build dynamic SQL safely
SELECT @sql += ''
USE '' + QUOTENAME(name) + '';
INSERT INTO #FreeSpace 
SELECT 
    DB_NAME() AS DatabaseName, 
    mf.name AS DataFileName,
	mf.physical_name ,
    (mf.size / 128.0)/1024 AS TotalSizeGB, 
    CAST(FILEPROPERTY(mf.name, ''''SpaceUsed'''') AS INT) / 128.0 / 1024 AS UsedSpaceGB, 
    ISNULL((mf.size / 128.0 - CAST(FILEPROPERTY(mf.name, ''''SpaceUsed'''') AS INT) / 128.0), 0)/1024 AS FreeSpaceGB
FROM sys.database_files mf
WHERE mf.type_desc = ''''ROWS'''';
''
FROM sys.databases 
WHERE state_desc = ''ONLINE'' 
  AND database_id > 4 
  AND name NOT IN (''ReportServer'', ''ReportServerTempDB'',''DBADB'');

-- Execute the dynamic SQL
EXEC sp_executesql @sql;

-- Final result with filter for >20% free space
SELECT * FROM #FreeSpace

ORDER BY FreeSpaceGB DESC;

DROP TABLE #FreeSpace;
', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Disk_Space_Alert_GEOPITS]    Script Date: 2/10/2026 6:29:07 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:07 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Disk_Space_Alert_GEOPITS', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/10/2026 6:29:08 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'IF OBJECT_ID(''tempdb..#output'') IS NOT NULL DROP TABLE #output;

DECLARE @profile VARCHAR(100) = ''DBA'';
DECLARE @recipient VARCHAR(MAX) = ''mssqlalerts@geopits.com''; 
DECLARE @cc VARCHAR(MAX) = '''';
DECLARE @bcc VARCHAR(MAX) = '''';
DECLARE @body NVARCHAR(MAX);
DECLARE @sub VARCHAR(100) = ''Thyrocare '' + @@SERVERNAME + '' Disk Space Alert '' +'': '' + CONVERT(VARCHAR, GETDATE(), 107);

-- Collect drive info
DECLARE @new TABLE (
    drivename VARCHAR(10),
    [capacity(GB)] DECIMAL(12,2),
    [freespace(GB)] DECIMAL(12,2),
    [Used %] DECIMAL(5,2)
);

INSERT INTO @new
SELECT DISTINCT 
    vs.volume_mount_point,
    vs.total_bytes / 1073741824.0,
    vs.available_bytes / 1073741824.0,
    ((vs.total_bytes - vs.available_bytes) * 1.0 / vs.total_bytes) * 100
FROM sys.master_files AS f
CROSS APPLY sys.dm_os_volume_stats(f.database_id, f.file_id) AS vs
WHERE 
        ((((vs.total_bytes - vs.available_bytes) * 1.0 / vs.total_bytes) * 100)> 90.00 )
ORDER BY vs.volume_mount_point
OPTION (RECOMPILE);

-- Collect database file info
DECLARE @new1 TABLE (
    [Database] SYSNAME,
    [File name] VARCHAR(500),
    [File Size GB] DECIMAL(12,2),
    [Used space GB] DECIMAL(12,2),
    [Free Space GB] DECIMAL(12,2)
);

INSERT INTO @new1
SELECT 
    DB_NAME(database_id),
    physical_name,
    size/128.0/1024,
    FILEPROPERTY(name,''SpaceUsed'')/128.0/1024,
    (size - FILEPROPERTY(name,''SpaceUsed''))/128.0/1024
FROM sys.master_files;

-- Build XML for drives
DECLARE @xml NVARCHAR(MAX);
SELECT @xml = CAST((
    SELECT drivename AS ''td'','''',
           [capacity(GB)] AS ''td'','''',
           [freespace(GB)] AS ''td'','''',
           [Used %] AS ''td''
    FROM @new
    WHERE 
        ([Used %] > 90.00 )
    FOR XML PATH(''tr''), ELEMENTS
) AS NVARCHAR(MAX));

-- Build XML for DB files
DECLARE @xml1 NVARCHAR(MAX);
SELECT @xml1 = CAST((
    SELECT [Database] AS ''td'','''',
           [File name] AS ''td'','''',
           [File Size GB] AS ''td'','''',
           [Used space GB] AS ''td'','''',
           [Free Space GB] AS ''td''
    FROM @new1
    WHERE LEFT([File name],3) IN (
        SELECT drivename FROM @new
        WHERE 
        ([Used %] > 90.00 )
    )
    AND [Free Space GB] > 1
    ORDER BY [Free Space GB] DESC
    FOR XML PATH(''tr''), ELEMENTS
) AS NVARCHAR(MAX));


SET @body = ''
<html>
<head>
<style>
table, th, td { border: 1px solid black; border-collapse: collapse; text-align: center; }
</style>
</head>
<body>
<H2>Low Disk Space Alert: '' + @@SERVERNAME + ''</H2>
<table>
<tr><th>Drive Name</th><th>Total Size (GB)</th><th>Free Space (GB)</th><th>Used %</th></tr>'' 
+ ISNULL(@xml,''<tr><td colspan="4">No drives exceed threshold.</td></tr>'') + ''
</table><br/><H2>Database file size:</H2>'';

-- Add database table only if @xml1 has data
IF @xml1 IS NOT NULL
    SET @body = @body + ''
    <table>
    <tr><th>Database Name</th><th>File Name</th><th>File Size(GB)</th><th>Used Size</th><th>Free Size</th></tr>'' 
    + @xml1 + ''
    </table>'';
ELSE
    SET @body = @body + ''<p>No database files with free space found on affected drives.</p>'';

-- Add footer note
SET @body = @body + ''

</body>
</html>'';

if @xml is not null
BEGIN
 EXEC msdb.dbo.Sp_send_dbmail
     @profile_name = @profile,
     @body = @body,
     @body_format = ''html'',
     @recipients = @recipient,
     @copy_recipients = @cc,
     @blind_copy_recipients = @bcc,
     @subject = @sub;
 END', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=6, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250111, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'8897d639-1bfe-4bbb-8f95-11aaa35c515c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_GeoPITS_Blocking_Alerts]    Script Date: 2/10/2026 6:29:08 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:08 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_GeoPITS_Blocking_Alerts', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s1]    Script Date: 2/10/2026 6:29:08 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SET ANSI_NULLS, QUOTED_IDENTIFIER ON;

IF OBJECT_ID(''tempdb..#BlockingInfo'') IS NOT NULL DROP TABLE #BlockingInfo;
IF OBJECT_ID(''tempdb..#BlockingInfo1'') IS NOT NULL DROP TABLE #BlockingInfo1;

-- Create the temporary tables
CREATE TABLE #BlockingInfo (
    head_blocker_session_id INT,
    blocking_queries_count INT,
    head_blocker_query NVARCHAR(max));

IF OBJECT_ID(''dbadb..BlockedQueriesInfo'') IS NULL

CREATE TABLE dbadb..BlockedQueriesInfo (
    ServerName NVARCHAR(100),
    BlockedSessionID INT,
    StartTime DATETIME,
    WaitingInMinutes FLOAT,
    WaitType NVARCHAR(50),
    BlockingSessionID INT,
    QueryWaiting NVARCHAR(max),
	logdate datetime default getdate()
);

IF OBJECT_ID(''dbadb..HeadBlockingInfo'') IS NULL
CREATE TABLE dbadb..HeadBlockingInfo (
     host_name NVARCHAR(100),
	login_name NVARCHAR(100),
	duration NVARCHAR(100),
	head_blocker_session_id INT,
    blocking_queries_count INT,
    head_blocker_query NVARCHAR(max),
	logdate datetime default getdate()
,is_closed tinyint DEFAULT 0);

INSERT INTO dbadb..BlockedQueriesInfo (ServerName, BlockedSessionID, StartTime, WaitingInMinutes, WaitType, BlockingSessionID, QueryWaiting)
SELECT 
    DISTINCT @@SERVERNAME AS [Server Name], 
    b.session_id AS [Blocked Session ID], 
    r.start_time, 
    (b.wait_duration_ms / 1000) / 60 AS [Waiting in Minutes],
    b.wait_type AS [Wait Type], 
    b.blocking_session_id AS [Blocking Session ID], 
    t.[text] AS [Query Waiting to Execute]
FROM 
    sys.dm_os_waiting_tasks b 
INNER JOIN 
    sys.dm_exec_requests r ON r.session_id = b.session_id and r.session_id>50
OUTER APPLY 
    sys.dm_exec_sql_text(r.sql_handle) t 
WHERE 
    b.blocking_session_id <> 0 and b.blocking_session_id <>b.session_id ;

-- Insert data into #BlockingInfo
WITH cteHead AS (
    SELECT 
        sess.session_id, 
        req.request_id, 
        LEFT(ISNULL(req.wait_type, ''''), 50) AS wait_type,
        LEFT(ISNULL(req.wait_resource, ''''), 40) AS wait_resource, 
        LEFT(req.last_wait_type, 50) AS last_wait_type,
        sess.is_user_process, 
        req.cpu_time AS request_cpu_time, 
        req.logical_reads AS request_logical_reads,
        req.reads AS request_reads, 
        req.writes AS request_writes, 
        req.wait_time, 
        req.blocking_session_id,
        sess.memory_usage,
        sess.cpu_time AS session_cpu_time, 
        sess.reads AS session_reads, 
        sess.writes AS session_writes, 
        sess.logical_reads AS session_logical_reads,
        CONVERT(decimal(5,2), req.percent_complete) AS percent_complete, 
        req.estimated_completion_time AS est_completion_time,
        req.start_time AS request_start_time, 
        LEFT(req.status, 15) AS request_status, 
        req.command,
        req.plan_handle, 
        req.sql_handle, 
        req.statement_start_offset, 
        req.statement_end_offset, 
        conn.most_recent_sql_handle,
        LEFT(sess.status, 15) AS session_status, 
        sess.group_id, 
        req.query_hash, 
        req.query_plan_hash
    FROM sys.dm_exec_sessions AS sess
    LEFT OUTER JOIN sys.dm_exec_requests AS req 
        ON sess.session_id = req.session_id and req.session_id>50
    LEFT OUTER JOIN sys.dm_exec_connections AS conn 
        ON conn.session_id = sess.session_id and conn.session_id>50
		   

),
cteBlockingHierarchy AS (
    SELECT 
        head.session_id AS head_blocker_session_id, 
        head.session_id AS session_id, 
        head.blocking_session_id,
        head.wait_type, 
        head.wait_time, 
        head.wait_resource, 
        head.statement_start_offset, 
        head.statement_end_offset,
        head.plan_handle, 
        head.sql_handle, 
        head.most_recent_sql_handle, 
        0 AS Level
    FROM cteHead AS head
    WHERE (head.blocking_session_id IS NULL OR head.blocking_session_id = 0)
    AND head.session_id IN (SELECT DISTINCT blocking_session_id FROM cteHead WHERE blocking_session_id != 0)
    UNION ALL
    SELECT 
        h.head_blocker_session_id, 
        blocked.session_id, 
        blocked.blocking_session_id, 
        blocked.wait_type,
        blocked.wait_time, 
        blocked.wait_resource, 
        h.statement_start_offset, 
        h.statement_end_offset,                                                                                                                                                                                                                                                                               
        h.plan_handle, 
        h.sql_handle, 
        h.most_recent_sql_handle, 
        [Level] + 1
    FROM cteHead AS blocked
    INNER JOIN cteBlockingHierarchy AS h 
        ON h.session_id = blocked.blocking_session_id 
        AND h.session_id != blocked.session_id -- Avoid infinite recursion for latch type of blocking
    WHERE h.wait_type COLLATE Latin1_General_BIN NOT IN (''EXCHANGE'', ''CXPACKET'') 
        OR h.wait_type IS NULL
)
INSERT INTO #BlockingInfo (head_blocker_session_id, blocking_queries_count, head_blocker_query)
SELECT 
    bh.head_blocker_session_id,
    COUNT(bh.session_id)  AS blocking_queries_count,
    txt.text AS head_blocker_query
	

FROM cteBlockingHierarchy AS bh
OUTER APPLY sys.dm_exec_sql_text(ISNULL(bh.sql_handle, bh.most_recent_sql_handle)) AS txt
where bh.head_blocker_session_id<>bh.session_id
GROUP BY bh.head_blocker_session_id, txt.text;

 -- select * from #BlockingInfo

CREATE TABLE #BlockingInfo1 (
    session_id INT,
    host_name NVARCHAR(100),
	login_name NVARCHAR(100),
	);

insert into #BlockingInfo1(session_id,host_name,login_name)
SELECT s.session_id, s.host_name,s.login_name
FROM sys.dm_exec_sessions s 
LEFT OUTER JOIN sys.dm_exec_requests r on r.session_id = s.session_id
OUTER APPLY sys.dm_exec_sql_text (r.sql_handle) t
OUTER APPLY sys.dm_exec_input_buffer(s.session_id, NULL) AS ib
WHERE s.session_id in   (select head_blocker_session_id from #BlockingInfo) 
ORDER BY   r.blocking_session_id desc, r.session_id

insert  into dbadb..HeadBlockingInfo(head_blocker_session_id ,blocking_queries_count , head_blocker_query,host_name ,login_name ,duration )
SELECT 
    s.head_blocker_session_id, 
    s.blocking_queries_count, 
    s.head_blocker_query,
    t.host_name, 
    t.login_name,    
    CONVERT(VARCHAR, DATEADD(SECOND, DATEDIFF(SECOND, MAX(ses.last_request_start_time), GETDATE()), 0), 108) AS duration
FROM 
    #BlockingInfo s 
INNER JOIN 
    #BlockingInfo1 t ON s.head_blocker_session_id = t.session_id
INNER JOIN 
    sys.dm_exec_sessions ses ON t.session_id = ses.session_id
	
GROUP BY 
    s.head_blocker_session_id, 
    s.blocking_queries_count, 
    s.head_blocker_query, 
    t.host_name, 
    t.login_name
	HAVING 
    DATEDIFF(SECOND, MAX(ses.last_request_start_time), GETDATE()) > 300
	order by duration desc;

SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;
GO', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s2]    Script Date: 2/10/2026 6:29:08 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's2', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;

-- Step 3: Generate HTML content from the blocking table
DECLARE @HTML NVARCHAR(MAX);
DECLARE @ServerName NVARCHAR(128);
SET @ServerName = (Select @@SERVERNAME);

DECLARE @Subject NVARCHAR(256);
SET @subject = N''Thyrocare '' + @@ServerName + '' - Blocking Queries -> Open''; --Change 1


-- Initialize HTML
SET @HTML = ''<html>'' +
''<head>'' +
''<style>'' +
''body { font-family: Arial, sans-serif; color: #333; line-height: 1.6; background-color: white; padding: 20px; }'' +
''table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #ffffff; }'' +  
''table, th, td { border: 1px solid #ddd; }'' +
''th, td { padding: 12px; text-align: left; }'' +
''th { background-color: #008080; color: white; }'' +
''tr:nth-child(even) { background-color: #f2f2f2; }'' +
''tr:hover { background-color: #e9ecef; }'' +
''p { margin: 0 0 10px; }'' +
''</style>'' +
''</head>'' +
''<body>'' +
''<p>Hello Team,</p>'' +
''<p>We have detected blocking queries on the <b>'' + @ServerName + ''</b> server which are currently affecting system performance.</p>'' +
''<p><strong>Summary of Impact:</strong></p>'' +
''<ul>'';

-- Create the summary of blocking queries
DECLARE @Summary NVARCHAR(MAX);

SELECT @Summary = (
    SELECT 
        ''<li>SPID <b>'' + CAST(s.head_blocker_session_id AS NVARCHAR) + 
        ''</b> is blocking '' + CAST(s.blocking_queries_count AS NVARCHAR) + 
        '' queries and has been running for '' + 
        CONVERT(VARCHAR, DATEADD(SECOND, DATEDIFF(SECOND, MAX(ses.last_request_start_time), GETDATE()), 0), 108) + ''.</li>''
     FROM dbadb..HeadBlockingInfo s
    
    INNER JOIN sys.dm_exec_sessions ses ON s.head_blocker_session_id = ses.session_id
	 WHERE DATEDIFF(SECOND, logdate, GETDATE()) < 60
    GROUP BY s.head_blocker_session_id, s.blocking_queries_count
    HAVING DATEDIFF(SECOND, MAX(ses.last_request_start_time), GETDATE()) > 300
    FOR XML PATH(''''), TYPE).value(''.'', ''NVARCHAR(MAX)'');

SET @HTML = @HTML + @Summary + ''</ul>'' +
''<p><strong>Overview of Blocking Queries:</strong></p>'' +
''<p>Blocking occurs when one query holds a lock on a resource required by another query, leading to delays and performance degradation.</p>'' +
''<p>Below are the details of the blocking sessions identified:</p>'' +
''<table>'' +
''<thead>'' +
''<tr>'' +
''<th>Head Blocker SPID</th>'' +
''<th>No. Queries Waiting</th>'' +
''<th>Blocking Query Text</th>'' +
''<th>Host Name</th>'' +
''<th>Login Name</th>'' +
''<th>Duration</th>'' +
''</tr>'' +
''</thead>'' +
''<tbody>'' +
(SELECT 
        ''<tr>'' +
        ''<td>'' + CAST(s.head_blocker_session_id AS NVARCHAR) + ''</td>'' +
        ''<td>'' + CAST(s.blocking_queries_count AS NVARCHAR) + ''</td>'' +
        ''<td>'' + LEFT(s.head_blocker_query, 300) + ''</td>'' +
        ''<td>'' + s.host_name + ''</td>'' +
        ''<td>'' + s.login_name + ''</td>'' +
        ''<td>'' + s.duration + ''</td>'' +
        ''</tr>''
    FROM dbadb..HeadBlockingInfo s
    WHERE DATEDIFF(SECOND, logdate, GETDATE()) < 60
	order by s.duration desc
    FOR XML PATH(''''), TYPE).value(''.'', ''NVARCHAR(MAX)'') +
''</tbody>'' +
''</table>'' +
''<p>The query has been identified as causing significant blocking issues within the database. We recommend promptly reviewing the query to assess whether terminating it is necessary to maintain optimal performance.</p>'' +
''<p>Please let us know if you would like us to proceed with terminating these queries or if youd prefer to allow them to complete their execution.</p>'' +
''<p>We are here to assist in resolving this issue.</p>'' +
''<p>Best Regards,</p>'' +
''<p>MSSQL DBA<br>GeoPITS</p>'' +  -- change 2
''</body>'' +
''</html>'';

-- Output the final HTML
--SELECT @HTML AS HTML;




if(@HTML is not null)
BEGIN
EXEC msdb.dbo.Sp_send_dbmail
@profile_name = ''DBA'',     --Change 3
@body = @HTML,
@body_format =''html'',
@recipients = ''mssqlalerts@geopits.com'',  -- change 4
--@copy_recipients ='''',
@blind_copy_recipients='''',
@subject =@Subject ;
END

 

GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s3]    Script Date: 2/10/2026 6:29:08 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's3', 
		@step_id=3, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SET ANSI_NULLS, QUOTED_IDENTIFIER ON;

-- Step 5: Generate HTML content for closed blocking statuses
DECLARE @HTML_Closed NVARCHAR(MAX) ,@Summary NVARCHAR(MAX);

SET @HTML_Closed = ''<html>'' +
''<head>'' +
''<meta charset="UTF-8">'' +
''<meta name="viewport" content="width=device-width, initial-scale=1.0">'' +
''<style>'' +
''body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; color: #333; line-height: 1.6; background-color: white; padding: 20px; margin: 0; }'' +
''header { background: #008080; padding: 10px 0; color: white; text-align: center; }'' +
''ul { list-style-type: none; padding: 0; }'' +
''ul li { margin: 10px 0; }'' +
''table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #ffffff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }'' +
''table, th, td { border: 1px solid #ddd; }'' +
''th, td { padding: 12px; text-align: left; }'' +
''th { background-color: #008000; color: white; }'' +
''tr:nth-child(even) { background-color: #f2f2f2; }'' +
''tr:hover { background-color: #e0f7fa; }'' +
''p { margin: 10px 0; }'' +
''footer { margin-top: 20px; font-size: 0.9em; color: #777; text-align: center; }'' +
''</style>'' +
''</head>'' +
''<body>'' +
''<p>Hello Team,</p>'' +
''<p>This is a notification regarding previously detected blocking queries on the <b>'' + @@ServerName + ''</b> server that have now been resolved.</p>'' +
''<p><strong>Summary of Resolved Blocking Queries:</strong></p>'' +
''<ul>'';

-- Create the summary of closed blocking queries
SELECT @Summary = (
    SELECT 
        ''<li>SPID <b>'' + CAST(s.head_blocker_session_id AS NVARCHAR) + 
        ''</b> was blocking '' + CAST(s.blocking_queries_count AS NVARCHAR) + 
        '' queries and has resolved successfully.</li>''
    FROM (
        SELECT 
            head_blocker_session_id,
            blocking_queries_count,
            ROW_NUMBER() OVER (PARTITION BY head_blocker_session_id ORDER BY duration DESC) AS rn
        FROM dbadb..HeadBlockingInfo
        WHERE is_closed = 0 AND DATEDIFF(MINUTE, logdate, GETDATE()) < 30 -- Focus on open blocking session_id
    ) s
    WHERE s.rn = 1 and head_blocker_session_id not in (select session_id from sys.dm_exec_sessions where session_id>50 and DATEDIFF(MINUTE, last_request_start_time, GETDATE()) <1) -- Only get the row with the maximum duration for each SPID
    FOR XML PATH(''''), TYPE).value(''.'', ''NVARCHAR(MAX)'');


    

SET @HTML_Closed = @HTML_Closed + @Summary + ''</ul>'' +
''<p>Below are the details of the resolved blocking sessions:</p>'' +
''<table>'' +
''<thead>'' +
''<tr>'' +
''<th>Head Blocker SPID</th>'' +
''<th>No. Queries Waiting</th>'' +
''<th>Blocking Query Text</th>'' +
''<th>Host Name</th>'' +
''<th>Login Name</th>'' +
''<th>Duration</th>'' +
''</tr>'' +
''</thead>'' +
''<tbody>'' +
(SELECT 
        ''<tr>'' +
        ''<td>'' + CAST(s.head_blocker_session_id AS NVARCHAR) + ''</td>'' +
        ''<td>'' + CAST(s.blocking_queries_count AS NVARCHAR) + ''</td>'' +
        ''<td>'' + LEFT(s.head_blocker_query, 300) + ''</td>'' +
        ''<td>'' + s.host_name + ''</td>'' +
        ''<td>'' + s.login_name + ''</td>'' +
        ''<td>'' + CAST(s.duration AS NVARCHAR) + ''</td>'' + -- Cast duration to NVARCHAR
        ''</tr>''
    FROM (
        SELECT 
            head_blocker_session_id,
            blocking_queries_count,
            host_name,
            login_name,
            head_blocker_query,
            duration,
            ROW_NUMBER() OVER (PARTITION BY head_blocker_session_id ORDER BY duration DESC) AS rn
        FROM dbadb..HeadBlockingInfo
        WHERE is_closed = 0 AND DATEDIFF(MINUTE, logdate, GETDATE()) < 30 -- Focus on open blocking
    ) s
	WHERE s.rn = 1 and head_blocker_session_id not in (select session_id from sys.dm_exec_sessions where session_id>50 and DATEDIFF(MINUTE, last_request_start_time, GETDATE()) <1)
    
    FOR XML PATH(''''), TYPE).value(''.'', ''NVARCHAR(MAX)'') +
''</tbody>'' +
''</table>'' +
''<p>We appreciate your attention to these matters and are glad to report that performance has returned to normal.</p>'' +
''<p>If you have any questions or require further details, please do not hesitate to reach out.</p>'' +
''<p>Best Regards,</p>'' +
''<p>MSSQL DBA<br>GeoPITS</p>'' +  --Change 2
''</body>'' +
''</html>'';



-- Output the final HTML for closed queries


 UPDATE dbadb..HeadBlockingInfo
 SET is_closed = 1
 
 WHERE DATEDIFF(MINUTE, logdate, GETDATE()) < 30 AND is_closed = 0 and head_blocker_session_id not in (select session_id from sys.dm_exec_sessions where session_id>50 and DATEDIFF(MINUTE, last_request_start_time, GETDATE()) <1); 

DECLARE @subject NVARCHAR(256);

 SET @subject = N''Thyrocare '' + @@ServerName + '' - Blocking Queries -> Closed''; --Change 1
IF (@HTML_Closed IS NOT NULL)
BEGIN
EXEC msdb.dbo.sp_send_dbmail
@profile_name = ''DBA'',     -- Change 3
@body = @HTML_Closed,
@body_format = ''html'',
@recipients = ''mssqlalerts@geopits.com'', -- change 4
 @subject =@subject
END

go
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Blockingalert', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=5, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20240921, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'73092bd6-858a-4015-ad48-b01a86da5b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_GeoPITS_Job_failure]    Script Date: 2/10/2026 6:29:08 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:08 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_GeoPITS_Job_failure', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Collect]    Script Date: 2/10/2026 6:29:08 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Collect', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE DBADB;
GO
SET NOCOUNT ON;
IF OBJECT_ID(''tempdb..#job_failure'', ''U'') IS NOT NULL
        DROP TABLE #job_failure;
IF OBJECT_ID(''tempdb..#job_step_failure'', ''U'') IS NOT NULL
  DROP TABLE #job_step_failure;
IF OBJECT_ID(''tempdb..#error_messages'', ''U'') IS NOT NULL
  DROP TABLE #error_messages;


	DECLARE  @minutes_to_monitor SMALLINT = 1440;
-- NEW CTE: Extract error messages from run_status = 4 (Log Shipping detailed errors)
-- These contain the full error messages that correspond to run_status = 0 failures
WITH CTE_ERROR_MESSAGES AS (
    SELECT
        sysjobhistory.job_id AS sql_server_agent_job_id_guid,
        sysjobhistory.instance_id,
        CAST(sysjobhistory.run_date AS VARCHAR(MAX)) AS run_date_string,
        REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_time AS VARCHAR(MAX)))) + 
            CAST(sysjobhistory.run_time AS VARCHAR(MAX)) AS run_time_string,
        sysjobhistory.step_id,
        sysjobhistory.message AS error_message,
        sysjobhistory.run_status
    FROM msdb.dbo.sysjobhistory WITH (NOLOCK)
 inner join [DBADB].[dbo].[sql_server_agent_job] on sysjobhistory.job_id=[sql_server_agent_job].sql_server_agent_job_id_guid

    WHERE sysjobhistory.run_status = 4  -- Detailed error messages
        AND sysjobhistory.step_id > 0  -- Only step-level messages
  AND [sql_server_agent_job].job_category_name=''Log Shipping''
        AND LEN(LTRIM(RTRIM(ISNULL(sysjobhistory.message, '''')))) > 0  -- Only non-empty messages
)
SELECT 
    sql_server_agent_job_id_guid,
    instance_id,
    run_date_string,
    run_time_string,
    step_id,
    error_message,
    run_status,
    CAST(SUBSTRING(run_date_string, 5, 2) + ''/'' + 
         SUBSTRING(run_date_string, 7, 2) + ''/'' + 
         SUBSTRING(run_date_string, 1, 4) AS DATETIME) +
    CAST(STUFF(STUFF(run_time_string, 5, 0, '':''), 3, 0, '':'') AS DATETIME) AS error_datetime
INTO #error_messages
FROM CTE_ERROR_MESSAGES
WHERE CAST(SUBSTRING(run_date_string, 5, 2) + ''/'' + 
           SUBSTRING(run_date_string, 7, 2) + ''/'' + 
           SUBSTRING(run_date_string, 1, 4) AS DATETIME) +
      CAST(STUFF(STUFF(run_time_string, 5, 0, '':''), 3, 0, '':'') AS DATETIME) 
      > DATEADD(MINUTE, -1 * @minutes_to_monitor, GETDATE())
   AND error_message like ''%error%'' ;
	

	WITH JobSchedules AS (
    SELECT
        ss.schedule_id,
        ss.enabled,
        CASE ss.freq_type
            WHEN 1 THEN ''One time only''
            WHEN 4 THEN ''Daily''
            WHEN 8 THEN ''Weekly''
            WHEN 16 THEN ''Monthly''
            WHEN 32 THEN ''Monthly, Relative''
            WHEN 64 THEN ''When SQL Server Agent starts''
            WHEN 128 THEN ''When computer is idle''
            ELSE ''Other''
        END AS Frequency,
        
        -- Day Interval logic
        IIF(ss.freq_type = 32 AND ss.freq_relative_interval <> 0,
            CASE ss.freq_relative_interval
                WHEN 1 THEN ''First ''
                WHEN 2 THEN ''Second ''
                WHEN 4 THEN ''Third ''
                WHEN 8 THEN ''Fourth ''
                WHEN 16 THEN ''Last ''
            END, '''') +
        CASE ss.freq_type
            WHEN 1 THEN ''''
            WHEN 4 THEN IIF(ss.freq_interval = 1, ''Every day'', ''Every '' + CAST(ss.freq_interval AS VARCHAR(3)) + '' day(s)'')
            WHEN 8 THEN
                IIF(ss.freq_interval & 2 = 2, ''Mon '', '''') +
                IIF(ss.freq_interval & 4 = 4, ''Tue '', '''') +
                IIF(ss.freq_interval & 8 = 8, ''Wed '', '''') +
                IIF(ss.freq_interval & 16 = 16, ''Thu '', '''') +
                IIF(ss.freq_interval & 32 = 32, ''Fri '', '''') +
                IIF(ss.freq_interval & 64 = 64, ''Sat '', '''') +
                IIF(ss.freq_interval & 1 = 1, ''Sun '', '''')
            WHEN 16 THEN ''On the '' + CAST(ss.freq_interval AS VARCHAR(3)) + '' day of the month.''
            WHEN 32 THEN
                CASE ss.freq_interval
                    WHEN 1 THEN ''Sunday''
                    WHEN 2 THEN ''Monday''
                    WHEN 3 THEN ''Tuesday''
                    WHEN 4 THEN ''Wednesday''
                    WHEN 5 THEN ''Thursday''
                    WHEN 6 THEN ''Friday''
                    WHEN 7 THEN ''Saturday''
                    WHEN 8 THEN ''Day''
                    WHEN 9 THEN ''Weekday''
                    WHEN 10 THEN ''Weekend day''
                END
            ELSE ''''
        END AS DayInterval,
        IIF(
            ss.freq_type = 4 AND ss.freq_interval = 1 AND ss.freq_subday_interval = 0, 
            ''Occurs Once at '' + STUFF(STUFF(RIGHT(''00000'' + CAST(ss.active_start_time AS VARCHAR(6)), 6), 3, 0, '':''), 6, 0, '':''),
            IIF(
                ss.freq_type = 8 AND ss.freq_subday_type = 1 AND ss.freq_subday_interval = 0, 
                ''Occurs Once at '' + STUFF(STUFF(RIGHT(''00000'' + CAST(ss.active_start_time AS VARCHAR(6)), 6), 3, 0, '':''), 6, 0, '':''),
                IIF(
                    ss.freq_subday_interval <> 0,
                    CASE ss.freq_subday_type
                        WHEN 1 THEN ''Occurs Once at '' + STUFF(STUFF(RIGHT(''00000'' + CAST(ss.active_start_time AS VARCHAR(6)), 6), 3,0,'':''), 6,0,'':'')
                        WHEN 2 THEN ''Repeat every '' + CAST(ss.freq_subday_interval AS VARCHAR(3)) + '' seconds''
                        WHEN 4 THEN ''Repeat every '' + CAST(ss.freq_subday_interval AS VARCHAR(3)) + '' minutes''
                        WHEN 8 THEN ''Repeat every '' + CAST(ss.freq_subday_interval AS VARCHAR(3)) + '' hours''
                    END,
                    ''''
                )
            )
        ) AS DailyFrequency,
        
        CASE
            WHEN ss.freq_type = 8 THEN ''Repeat every '' + CAST(ss.freq_recurrence_factor AS VARCHAR(3)) + '' week(s).''
            WHEN ss.freq_type IN (16, 32) THEN ''Repeat every '' + CAST(ss.freq_recurrence_factor AS VARCHAR(3)) + '' month(s).''
            ELSE ''''
        END AS Recurrence,
        
        -- Start and End time formatting
        STUFF(STUFF(RIGHT(''00000'' + CAST(ss.active_start_time AS VARCHAR(6)), 6), 3, 0, '':''), 6, 0, '':'') AS StartTime,
        STUFF(STUFF(RIGHT(''00000'' + CAST(ss.active_end_time AS VARCHAR(6)), 6), 3, 0, '':''), 6, 0, '':'') AS EndTime
    FROM msdb.dbo.sysschedules AS ss
), RankedJobSchedules AS (
    SELECT 
        ss.schedule_id,
        ss.Frequency,
        ss.DayInterval,
        ss.DailyFrequency,
        ss.StartTime,
        ss.EndTime,
        ss.enabled,
        JJS.job_id,
        ROW_NUMBER() OVER (PARTITION BY JJS.job_id ORDER BY ss.schedule_id) AS rn
    FROM JobSchedules ss
    JOIN msdb.dbo.sysjobschedules JJS ON ss.schedule_id = JJS.schedule_id
)
MERGE INTO [DBADB].[dbo].[sql_server_agent_job] AS TARGET
USING (
    SELECT
        J.job_id AS sql_server_agent_job_id_guid,
        J.name AS sql_server_agent_job_name,
        J.date_created AS job_create_datetime_utc,
        J.date_modified AS job_last_modified_datetime_utc,
        J.enabled AS is_enabled,
        0 AS is_deleted,
        LEFT(ISNULL(jc.name, ''Unknown''), 100) AS job_category_name,
        LEFT(ISNULL(SP.name, ''Unknown''), 256) AS owner_login_name,
        JS.schedule_id,
        ISNULL(JS.Frequency, '''') AS Frequency,
        ISNULL(JS.DayInterval, '''') AS DayInterval,
        ISNULL(JS.DailyFrequency, '''') AS DailyFrequency,
        ISNULL(JS.StartTime, '''') AS StartTime,
        ISNULL(JS.EndTime, '''') AS EndTime,
        ISNULL(JS.enabled, 0) AS ScheduleIsEnabled
    FROM msdb.dbo.sysjobs AS J
    LEFT JOIN sys.server_principals AS SP ON J.owner_sid = SP.sid
    LEFT JOIN msdb.dbo.sysjobschedules AS JJS ON J.job_id = JJS.job_id
    LEFT JOIN RankedJobSchedules AS JS ON JJS.schedule_id = JS.schedule_id AND JS.rn = 1  -- Ensure only one schedule per job
    LEFT JOIN msdb.dbo.syscategories AS jc ON jc.category_id = J.category_id
) AS SOURCE
ON (SOURCE.sql_server_agent_job_id_guid = TARGET.sql_server_agent_job_id_guid and SOURCE.sql_server_agent_job_name=TARGET.sql_server_agent_job_name)

-- When not matched, insert the job details
WHEN NOT MATCHED BY TARGET THEN
    INSERT (
        sql_server_agent_job_id_guid,
        sql_server_agent_job_name,
        job_create_datetime_utc,
        job_last_modified_datetime_utc,
        is_enabled,
        is_deleted,
        job_category_name,
        owner_login_name,
        Frequency,
        DayInterval,
        DailyFrequency,
        StartTime,
        EndTime,
        ScheduleIsEnabled
    )
    VALUES (
        SOURCE.sql_server_agent_job_id_guid,
        LEFT(SOURCE.sql_server_agent_job_name, 256),
        SOURCE.job_create_datetime_utc,
        SOURCE.job_last_modified_datetime_utc,
        SOURCE.is_enabled,
        SOURCE.is_deleted,
        LEFT(SOURCE.job_category_name, 100),
        LEFT(SOURCE.owner_login_name, 256),
        LEFT(SOURCE.Frequency, 4000),
        LEFT(SOURCE.DayInterval, 4000),
        LEFT(SOURCE.DailyFrequency, 4000),
        LEFT(SOURCE.StartTime, 16),
        LEFT(SOURCE.EndTime, 16),
        SOURCE.ScheduleIsEnabled
    )

-- When matched, update the existing job details if they are different
WHEN MATCHED AND (
    SOURCE.job_last_modified_datetime_utc > TARGET.job_last_modified_datetime_utc AND(
    SOURCE.Frequency <> TARGET.Frequency OR
    SOURCE.DayInterval <> TARGET.DayInterval OR
    SOURCE.DailyFrequency <> TARGET.DailyFrequency OR
    SOURCE.StartTime <> TARGET.StartTime OR
    SOURCE.EndTime <> TARGET.EndTime OR
    SOURCE.ScheduleIsEnabled <> TARGET.ScheduleIsEnabled)
) THEN
    UPDATE SET 
        sql_server_agent_job_name = LEFT(SOURCE.sql_server_agent_job_name, 256),
        job_create_datetime_utc = SOURCE.job_create_datetime_utc,
        job_last_modified_datetime_utc = SOURCE.job_last_modified_datetime_utc,
        is_enabled = SOURCE.is_enabled,
        is_deleted = SOURCE.is_deleted,
        job_category_name = LEFT(SOURCE.job_category_name, 100),
        owner_login_name = LEFT(SOURCE.owner_login_name, 256),
        Frequency = LEFT(SOURCE.Frequency, 4000),
        DayInterval = LEFT(SOURCE.DayInterval, 4000),
        DailyFrequency = LEFT(SOURCE.DailyFrequency, 4000),
        StartTime = LEFT(SOURCE.StartTime, 16),
        EndTime = LEFT(SOURCE.EndTime, 16),
        ScheduleIsEnabled = SOURCE.ScheduleIsEnabled;

	WITH CTE_NORMALIZE_DATETIME_DATA AS (
  SELECT
   sysjobhistory.job_id AS sql_server_agent_job_id_guid,
   CAST(sysjobhistory.run_date AS VARCHAR(MAX)) AS run_date_string, 
   REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_time AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_time AS VARCHAR(MAX)) AS run_time_string,
   REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_duration AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_duration AS VARCHAR(MAX)) AS run_duration_string,
   sysjobhistory.run_status,
   sysjobhistory.message,
   sysjobhistory.instance_id
  FROM msdb.dbo.sysjobhistory WITH (NOLOCK)
  WHERE sysjobhistory.run_status = 0
  AND sysjobhistory.step_id = 0),
 CTE_GENERATE_DATETIME_DATA AS (
  SELECT
   CTE_NORMALIZE_DATETIME_DATA.sql_server_agent_job_id_guid,
   CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 5, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 7, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 1, 4) AS DATETIME) +
   CAST(STUFF(STUFF(CTE_NORMALIZE_DATETIME_DATA.run_time_string, 5, 0, '':''), 3, 0, '':'') AS DATETIME) AS job_start_datetime,
   CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 1, 2) AS INT) * 3600 +
    CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 3, 2) AS INT) * 60 + 
    CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 5, 2) AS INT) AS job_duration_seconds,
   CASE CTE_NORMALIZE_DATETIME_DATA.run_status
    WHEN 0 THEN ''Failure''
    WHEN 1 THEN ''Success''
    WHEN 2 THEN ''Retry''
    WHEN 3 THEN ''Canceled''
    ELSE ''Unknown''
   END AS job_status,
   CTE_NORMALIZE_DATETIME_DATA.message,
   CTE_NORMALIZE_DATETIME_DATA.instance_id
  FROM CTE_NORMALIZE_DATETIME_DATA)
 SELECT
  CTE_GENERATE_DATETIME_DATA.sql_server_agent_job_id_guid,
  CTE_GENERATE_DATETIME_DATA.job_start_datetime AS job_start_time_utc,
  DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime) AS job_failure_time_utc,
  ISNULL(CTE_GENERATE_DATETIME_DATA.message, '''') AS job_failure_message,
  CTE_GENERATE_DATETIME_DATA.instance_id
 INTO #job_failure
 FROM CTE_GENERATE_DATETIME_DATA
 WHERE DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime) > DATEADD(MINUTE, -1 * @minutes_to_monitor, GETDATE());
 

 WITH CTE_NORMALIZE_DATETIME_DATA AS (
  SELECT
   sysjobhistory.job_id AS sql_server_agent_job_id_guid,
   CAST(sysjobhistory.run_date AS VARCHAR(MAX)) AS run_date_string, 
   REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_time AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_time AS VARCHAR(MAX)) AS run_time_string,
   REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_duration AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_duration AS VARCHAR(MAX)) AS run_duration_string,
   sysjobhistory.run_status,
   sysjobhistory.step_id,
   sysjobhistory.step_name,
   sysjobhistory.message,
   sysjobhistory.retries_attempted,
   sysjobhistory.sql_severity,
   sysjobhistory.sql_message_id,
   sysjobhistory.instance_id
  FROM msdb.dbo.sysjobhistory WITH (NOLOCK)
  WHERE sysjobhistory.run_status = 0
  AND sysjobhistory.step_id > 0 ),
 CTE_GENERATE_DATETIME_DATA AS (
  SELECT
   CTE_NORMALIZE_DATETIME_DATA.sql_server_agent_job_id_guid,
   CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 5, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 7, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 1, 4) AS DATETIME) +
   CAST(STUFF(STUFF(CTE_NORMALIZE_DATETIME_DATA.run_time_string, 5, 0, '':''), 3, 0, '':'') AS DATETIME) AS job_start_datetime,
   CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 1, 2) AS INT) * 3600 +
    CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 3, 2) AS INT) * 60 + 
    CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 5, 2) AS INT) AS job_duration_seconds,
   CASE CTE_NORMALIZE_DATETIME_DATA.run_status
    WHEN 0 THEN ''Failure''
    WHEN 1 THEN ''Success''
    WHEN 2 THEN ''Retry''
    WHEN 3 THEN ''Canceled''
    ELSE ''Unknown''
   END AS job_status,
   CTE_NORMALIZE_DATETIME_DATA.step_id,
   CTE_NORMALIZE_DATETIME_DATA.step_name,
   CTE_NORMALIZE_DATETIME_DATA.message AS job_step_failure_message,
   CTE_NORMALIZE_DATETIME_DATA.retries_attempted,
   CTE_NORMALIZE_DATETIME_DATA.sql_severity,
   CTE_NORMALIZE_DATETIME_DATA.sql_message_id,
   CTE_NORMALIZE_DATETIME_DATA.instance_id
  FROM CTE_NORMALIZE_DATETIME_DATA)
 SELECT
  CTE_GENERATE_DATETIME_DATA.sql_server_agent_job_id_guid,
  CTE_GENERATE_DATETIME_DATA.job_start_datetime AS job_start_time_utc,
  DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime) AS job_failure_time_utc,
  CTE_GENERATE_DATETIME_DATA.step_id AS job_failure_step_number,
  ISNULL(CTE_GENERATE_DATETIME_DATA.job_step_failure_message, '''') AS job_step_failure_message,
  CTE_GENERATE_DATETIME_DATA.sql_severity AS job_step_severity,
  CTE_GENERATE_DATETIME_DATA.retries_attempted,
  CTE_GENERATE_DATETIME_DATA.step_name,
  CTE_GENERATE_DATETIME_DATA.sql_message_id,
  CTE_GENERATE_DATETIME_DATA.instance_id
 INTO #job_step_failure
 FROM CTE_GENERATE_DATETIME_DATA
 WHERE CTE_GENERATE_DATETIME_DATA.sql_message_id >-1 
 AND DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime) > DATEADD(MINUTE, -1 * @minutes_to_monitor, GETDATE())
 AND CTE_GENERATE_DATETIME_DATA.instance_id NOT IN (SELECT sql_server_agent_job_failure.sql_server_agent_instance_id FROM dbo.sql_server_agent_job_failure);
 

WITH CTE_FAILURE_STEP AS (
    SELECT
        jsf.*,
        -- Get the error message that belongs to THIS specific failure run only
        (SELECT TOP 1 em.error_message
         FROM #error_messages em
         WHERE em.sql_server_agent_job_id_guid = jsf.sql_server_agent_job_id_guid
            AND em.step_id = jsf.job_failure_step_number
            AND em.instance_id < jsf.instance_id  -- Error logged BEFORE this failure
            AND em.run_date_string = CAST(YEAR(jsf.job_failure_time_utc) AS VARCHAR(4)) + 
                RIGHT(''0'' + CAST(MONTH(jsf.job_failure_time_utc) AS VARCHAR(2)), 2) + 
                RIGHT(''0'' + CAST(DAY(jsf.job_failure_time_utc) AS VARCHAR(2)), 2)
            -- CRITICAL: Ensure no other failure exists between this error and current failure
            -- This prevents picking up errors from previous job runs
            AND NOT EXISTS (
                SELECT 1 
                FROM #job_step_failure jsf2 inner join dbadb.dbo.sql_server_agent_job on sql_server_agent_job.sql_server_agent_job_id_guid=jsf2.sql_server_agent_job_id_guid
                WHERE jsf2.sql_server_agent_job_id_guid = em.sql_server_agent_job_id_guid 
                    AND jsf2.job_failure_step_number = em.step_id
                    AND jsf2.instance_id > em.instance_id  -- Another failure after the error
                    AND jsf2.instance_id < jsf.instance_id -- But before current failure
                    AND sql_server_agent_job.job_category_name=''Log Shipping''
            )
         ORDER BY em.instance_id Asc -- Get the closest error before this failure
        ) AS detailed_error_message,
        ROW_NUMBER() OVER (PARTITION BY jsf.sql_server_agent_job_id_guid, jsf.job_failure_time_utc 
                          ORDER BY jsf.job_failure_step_number DESC) AS recent_step_rank
    FROM #job_step_failure jsf
)
INSERT INTO [DBADB].dbo.sql_server_agent_job_failure
		(sql_server_agent_job_id, sql_server_agent_instance_id, job_start_time_utc, job_failure_time_utc, job_failure_step_number, job_failure_step_name,
		 job_failure_message, job_step_failure_message, job_step_severity, job_step_message_id, retries_attempted, has_email_been_sent_to_operator)
SELECT  
   
    sql_server_agent_job.sql_server_agent_job_id,
    CTE_FAILURE_STEP.instance_id,
    job_failure.job_start_time_utc,
    CTE_FAILURE_STEP.job_failure_time_utc,
    CTE_FAILURE_STEP.job_failure_step_number,
    CTE_FAILURE_STEP.step_name AS job_failure_step_name,
    job_failure.job_failure_message,
    ISNULL(CTE_FAILURE_STEP.detailed_error_message, CTE_FAILURE_STEP.job_step_failure_message) AS job_step_failure_message,
    CTE_FAILURE_STEP.job_step_severity,
    CTE_FAILURE_STEP.sql_message_id AS job_step_message_id,
    CTE_FAILURE_STEP.retries_attempted,
    0 AS has_email_been_sent_to_operator
FROM #job_failure job_failure
INNER JOIN [DBADB].dbo.sql_server_agent_job
    ON job_failure.sql_server_agent_job_id_guid = sql_server_agent_job.sql_server_agent_job_id_guid
INNER JOIN CTE_FAILURE_STEP
    ON job_failure.sql_server_agent_job_id_guid = CTE_FAILURE_STEP.sql_server_agent_job_id_guid
    AND job_failure.job_failure_time_utc = CTE_FAILURE_STEP.job_failure_time_utc
WHERE CTE_FAILURE_STEP.recent_step_rank = 1
AND CTE_FAILURE_STEP.instance_id NOT IN (SELECT sql_server_agent_job_failure.sql_server_agent_instance_id FROM dbo.sql_server_agent_job_failure)
    AND sql_server_agent_job.job_category_name <> ''Unmonitored'';


INSERT INTO [DBADB].dbo.sql_server_agent_job_failure
		(sql_server_agent_job_id, sql_server_agent_instance_id, job_start_time_utc, job_failure_time_utc, job_failure_step_number, job_failure_step_name,
		 job_failure_message, job_step_failure_message, job_step_severity, job_step_message_id, retries_attempted, has_email_been_sent_to_operator)
SELECT 
    
    sql_server_agent_job.sql_server_agent_job_id,
    job_failure.instance_id,
    job_failure.job_start_time_utc,
    job_failure.job_failure_time_utc,
    0 AS job_failure_step_number,
    '''' AS job_failure_step_name,
    job_failure.job_failure_message,
    '''' AS job_step_failure_message,
    -1 AS job_step_severity,
    -1 AS job_step_message_id,
    0 AS retries_attempted,
    0 AS has_email_been_sent_to_operator
FROM #job_failure job_failure
INNER JOIN dbo.sql_server_agent_job
    ON job_failure.sql_server_agent_job_id_guid = sql_server_agent_job.sql_server_agent_job_id_guid
WHERE sql_server_agent_job.job_category_name <> ''Unmonitored''
    AND NOT EXISTS (
        SELECT 1 
        FROM #job_step_failure job_step_failure 
        WHERE job_failure.sql_server_agent_job_id_guid = job_step_failure.sql_server_agent_job_id_guid 
            AND job_failure.job_failure_time_utc = job_step_failure.job_failure_time_utc
    )
	AND job_failure.instance_id NOT IN (SELECT sql_server_agent_job_failure.sql_server_agent_instance_id FROM dbo.sql_server_agent_job_failure);


-- INSERT 3: Step failures without job-level failure
WITH CTE_FAILURE_STEP AS (
    SELECT
        jsf.*,
        -- Get the error message that belongs to THIS specific failure run only
        (SELECT TOP 1 em.error_message
         FROM #error_messages em
         WHERE em.sql_server_agent_job_id_guid = jsf.sql_server_agent_job_id_guid
            AND em.step_id = jsf.job_failure_step_number
            AND em.instance_id < jsf.instance_id
            AND em.run_date_string = CAST(YEAR(jsf.job_failure_time_utc) AS VARCHAR(4)) + 
                RIGHT(''0'' + CAST(MONTH(jsf.job_failure_time_utc) AS VARCHAR(2)), 2) + 
                RIGHT(''0'' + CAST(DAY(jsf.job_failure_time_utc) AS VARCHAR(2)), 2)
            AND NOT EXISTS (
                SELECT 1 
                FROM #job_step_failure jsf2 
                WHERE jsf2.sql_server_agent_job_id_guid = em.sql_server_agent_job_id_guid
                    AND jsf2.job_failure_step_number = em.step_id
                    AND jsf2.instance_id > em.instance_id
                    AND jsf2.instance_id < jsf.instance_id
            )
         ORDER BY em.instance_id ASC
        ) AS detailed_error_message,
        ROW_NUMBER() OVER (PARTITION BY jsf.sql_server_agent_job_id_guid, jsf.job_failure_time_utc 
                          ORDER BY jsf.job_failure_step_number DESC) AS recent_step_rank
    FROM #job_step_failure jsf
)
INSERT INTO [DBADB].dbo.sql_server_agent_job_failure
		(sql_server_agent_job_id, sql_server_agent_instance_id, job_start_time_utc, job_failure_time_utc, job_failure_step_number, job_failure_step_name,
		 job_failure_message, job_step_failure_message, job_step_severity, job_step_message_id, retries_attempted, has_email_been_sent_to_operator)
SELECT  
     sql_server_agent_job.sql_server_agent_job_id,
    CTE_FAILURE_STEP.instance_id,
    CTE_FAILURE_STEP.job_start_time_utc,
    CTE_FAILURE_STEP.job_failure_time_utc,
    CTE_FAILURE_STEP.job_failure_step_number,
    CTE_FAILURE_STEP.step_name AS job_failure_step_name,
    '''' AS job_failure_message,
    ISNULL(CTE_FAILURE_STEP.detailed_error_message, CTE_FAILURE_STEP.job_step_failure_message) AS job_step_failure_message,
    CTE_FAILURE_STEP.job_step_severity,
    CTE_FAILURE_STEP.sql_message_id AS job_step_message_id,
    CTE_FAILURE_STEP.retries_attempted,
    0 AS has_email_been_sent_to_operator
FROM CTE_FAILURE_STEP
INNER JOIN dbo.sql_server_agent_job
    ON CTE_FAILURE_STEP.sql_server_agent_job_id_guid = sql_server_agent_job.sql_server_agent_job_id_guid
LEFT JOIN #job_failure job_failure
    ON job_failure.sql_server_agent_job_id_guid = CTE_FAILURE_STEP.sql_server_agent_job_id_guid
    AND job_failure.job_failure_time_utc = CTE_FAILURE_STEP.job_failure_time_utc
WHERE CTE_FAILURE_STEP.recent_step_rank = 1
    AND job_failure.sql_server_agent_job_id_guid IS NULL 
	AND job_failure.instance_id NOT IN (SELECT sql_server_agent_job_failure.sql_server_agent_instance_id FROM dbo.sql_server_agent_job_failure)
    AND sql_server_agent_job.job_category_name <> ''Unmonitored'';

	

	Drop table #job_failure,#job_step_failure;
	SET NOCOUNT OFF;
GO', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [open]    Script Date: 2/10/2026 6:29:08 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'open', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE DBADB;
GO
SET NOCOUNT ON;


DECLARE @server_name NVARCHAR(255) = @@SERVERNAME; --Change Optional

-- Temporary table to hold email data
DECLARE @EmailData TABLE (
    JobId NVARCHAR(255),
    JobName NVARCHAR(255),
    StepName NVARCHAR(255),
    Schedule NVARCHAR(255),
    FailureCount INT,
    FailureTimes NVARCHAR(MAX),
    FailureMessages NVARCHAR(MAX),
    FirstFailureTime DATETIME,
    LastFailureTime DATETIME,
    JobStartTime DATETIME -- Added Job Start Time column
);


	
WITH RankedFailures AS (
    SELECT 
        j.sql_server_agent_job_id,
        j.sql_server_agent_job_name,
        jf.job_failure_step_name,
        jf.job_step_failure_message,
        jf.job_failure_time_utc,
        j.Frequency,
        j.StartTime,
        j.EndTime,
        ROW_NUMBER() OVER (PARTITION BY j.sql_server_agent_job_id ORDER BY jf.job_failure_time_utc DESC) AS rn
    FROM 
        [DBADB].[dbo].[sql_server_agent_job] j
    JOIN 
        [DBADB].[dbo].[sql_server_agent_job_failure] jf ON j.sql_server_agent_job_id = jf.sql_server_agent_job_id
    WHERE 
        jf.has_email_been_sent_to_operator=0 and (ticket_status is null or ticket_status<>''Open'')  AND   jf.job_step_message_id<>-1 
)

, ScheduleCTE AS (
    SELECT 
        j.sql_server_agent_job_id,
        CASE 
            -- Handle Daily Frequency
            WHEN j.Frequency = ''Daily'' THEN 
                CASE 
                    WHEN j.DailyFrequency LIKE ''%Repeat%'' 
                    THEN ''Every day from '' + CAST(j.StartTime AS NVARCHAR(8)) + 
                         '' to '' + CAST(j.EndTime AS NVARCHAR(8)) + 
                         '', repeats every '' + 
                         NULLIF(CAST(SUBSTRING(j.DailyFrequency, CHARINDEX(''every '', j.DailyFrequency) + 6, LEN(j.DailyFrequency)) AS NVARCHAR), '''') + ''.''
                    ELSE ''Every day at '' + CAST(j.StartTime AS NVARCHAR(8)) + ''.''
                END

            -- Handle Weekly Frequency
            WHEN j.Frequency = ''Weekly'' THEN 
                ''Every '' + 
                -- Concatenate the days correctly
                REPLACE(j.DayInterval, '' '', '', '') + 
                '' starts at '' + CAST(j.StartTime AS NVARCHAR(8)) + 
                CASE 
                    WHEN j.DailyFrequency LIKE ''%Repeat%'' THEN 
                        '', repeats every '' + 
                        NULLIF(CAST(SUBSTRING(j.DailyFrequency, CHARINDEX(''every '', j.DailyFrequency) + 6, LEN(j.DailyFrequency)) AS NVARCHAR), '''') + ''.''
                    ELSE ''.'' 
                END

            -- Handle Monthly Frequency
            WHEN j.Frequency = ''Monthly'' THEN 
                ''On the '' + 
                CASE 
                    WHEN j.DayInterval LIKE ''%1%'' THEN ''1st ''
                    WHEN j.DayInterval LIKE ''%2%'' THEN ''2nd ''
                    WHEN j.DayInterval LIKE ''%3%'' THEN ''3rd ''
                    WHEN j.DayInterval LIKE ''%4%'' THEN ''4th ''
                    WHEN j.DayInterval LIKE ''%5%'' THEN ''5th ''
                    WHEN j.DayInterval LIKE ''%last%'' THEN ''Last ''
                    ELSE ''Unknown ''
                END + 
                ''day of the month at '' + CAST(j.StartTime AS NVARCHAR(8)) +
                CASE 
                    WHEN j.DailyFrequency LIKE ''%Repeat%'' THEN 
                        '', repeats every '' + 
                        NULLIF(CAST(SUBSTRING(j.DailyFrequency, CHARINDEX(''every '', j.DailyFrequency) + 6, LEN(j.DailyFrequency)) AS NVARCHAR), '''') + ''.''
                    ELSE ''.'' 
                END

            -- Default case for other frequencies
            ELSE ''Other frequency: '' + j.Frequency
        END AS Schedule
    FROM 
        [DBADB].[dbo].[sql_server_agent_job] j
)

-- Main Query to get aggregated job failure details
INSERT INTO @EmailData (JobId, JobName, StepName, Schedule, FailureCount, FailureTimes, FailureMessages, FirstFailureTime, LastFailureTime, JobStartTime)
SELECT 
    j.sql_server_agent_job_id,
    j.sql_server_agent_job_name,
    jf.job_failure_step_name,
    sc.Schedule,
    COUNT(jf.job_failure_time_utc) AS FailureCount,
    STUFF((SELECT '', '' + CONVERT(NVARCHAR, jf_inner.job_failure_time_utc, 120)
           FROM [DBADB].[dbo].[sql_server_agent_job_failure] jf_inner
           WHERE jf_inner.sql_server_agent_job_id = j.sql_server_agent_job_id
           FOR XML PATH('''')), 1, 2, '''') AS FailureTimes,
    STUFF((SELECT ''; '' + jf_inner.job_step_failure_message
           FROM RankedFailures jf_inner
           WHERE jf_inner.sql_server_agent_job_id = j.sql_server_agent_job_id AND jf_inner.rn = 1  -- Limit to the top message
           FOR XML PATH('''')), 1, 2, '''') AS FailureMessages,
    MIN(jf.job_failure_time_utc) AS FirstFailureTime,
    MAX(jf.job_failure_time_utc) AS LastFailureTime,
    MIN(jf.job_start_time_utc) AS JobStartTime -- Assuming JobStartTime is the earliest failure time
FROM 
    [DBADB].[dbo].[sql_server_agent_job] j
JOIN 
    [DBADB].[dbo].[sql_server_agent_job_failure] jf ON j.sql_server_agent_job_id = jf.sql_server_agent_job_id
JOIN 
    ScheduleCTE sc ON j.sql_server_agent_job_id = sc.sql_server_agent_job_id
WHERE 
    jf.has_email_been_sent_to_operator=0 and (ticket_status is null or ticket_status<>''Open'') AND   jf.job_step_message_id<>-1 
GROUP BY 
    j.sql_server_agent_job_id, j.sql_server_agent_job_name, jf.job_failure_step_name, sc.Schedule;

	
--select * from @EmailData;

-- Prepare email content
DECLARE @subject NVARCHAR(255),
        @body NVARCHAR(MAX),
        @JobId NVARCHAR(255),
        @JobName NVARCHAR(255),
        @StepName NVARCHAR(255),
        @Schedule NVARCHAR(255),
        @FailureCount INT,
        @FailureTimes NVARCHAR(MAX),
        @FailureMessages NVARCHAR(MAX),
        @FirstFailureTime DATETIME,
        @LastFailureTime DATETIME,
		@JobStartTime DATETIME;


DECLARE EmailCursor CURSOR FOR 
SELECT JobId, JobName, StepName,  Schedule, FailureCount, FailureTimes, FailureMessages, FirstFailureTime, LastFailureTime ,JobStartTime
FROM @EmailData;

OPEN EmailCursor;
FETCH NEXT FROM EmailCursor INTO 
    @JobId, @JobName, @StepName, @Schedule, @FailureCount, @FailureTimes, @FailureMessages, @FirstFailureTime, @LastFailureTime,@JobStartTime;

WHILE @@FETCH_STATUS = 0
BEGIN
    -- Set email subject
    SET @subject = ''Thyrocare ''+ @server_name +'' ''+@JobName + '' Failed Alert -> Open'' ; --Change

    -- Prepare email body based on the number of failures
    IF @FailureCount > 1
    BEGIN
        -- Multiple failures HTML format
        SET @body = 
            ''<html>
            <head>
                 <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff; /* White background */
            color: #333;
        }
        h2 {
            color: #d9534f;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #ffffff; /* White table background */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #343a40; /* Dark gray for headers */
            color: #ffffff; /* White text color for headers */
        }
        tr:nth-child(even) {
            background-color: #f9f9f9; /* Light gray for even rows */
        }
        tr:hover {
            background-color: #f1f1f1; /* Hover effect for rows */
        }
        p {
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
            </head>
            <body>
                <h2>Job Failure Alert </h2>
                <table>
                    <tr><th>Job Name</th><td>'' + @JobName + ''</td></tr>
                    <tr><th>Step Name</th><td>'' + ISNULL(@StepName, ''N/A'') + ''</td></tr>
                    <tr><th>Error Messages</th><td>'' + ISNULL(@FailureMessages, ''N/A'') + ''</td></tr>
                    <tr><th>Failure Count</th><td>'' + CAST(@FailureCount AS NVARCHAR) + ''</td></tr>
                    <tr><th>First Start Time</th><td>'' + CONVERT(NVARCHAR, @JobStartTime, 120) + ''</td></tr>
                    <tr><th>First Failure Time</th><td>'' + CONVERT(NVARCHAR, @FirstFailureTime, 120) + ''</td></tr>
                    <tr><th>Last Failure Time</th><td>'' + CONVERT(NVARCHAR, @LastFailureTime, 120) + ''</td></tr>
                    <tr><th>Schedule</th><td>'' + @Schedule + ''</td></tr>
                </table>
            </body>
            </html>'';
    END
    ELSE
    BEGIN
        -- Single failure HTML format
        SET @body = 
            ''<html>
            <head>
                 <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff; /* White background */
            color: #333;
        }
        h2 {
            color: #d9534f;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #ffffff; /* White table background */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #343a40; /* Dark gray for headers */
            color: #ffffff; /* White text color for headers */
        }
        tr:nth-child(even) {
            background-color: #f9f9f9; /* Light gray for even rows */
        }
        tr:hover {
            background-color: #f1f1f1; /* Hover effect for rows */
        }
        p {
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
            </head>
            <body>
                <h2>Job Failure Alert </h2>
                <table>
                    <tr><th>Job Name</th><td>'' + @JobName + ''</td></tr>
                    <tr><th>Step Name</th><td>'' + ISNULL(@StepName, ''N/A'') + ''</td></tr>
                    <tr><th>Error Message</th><td>'' + ISNULL(@FailureMessages, ''N/A'') + ''</td></tr>
                    <tr><th>Job Start Time</th><td>'' + CONVERT(NVARCHAR, @JobStartTime, 120) + ''</td></tr>
                    <tr><th>Failure Time</th><td>'' + CONVERT(NVARCHAR, @LastFailureTime, 120) + ''</td></tr>
                    <tr><th>Schedule</th><td>'' + @Schedule + ''</td></tr>
                </table>
            </body>
            </html>'';
    END

    -- Send the email
	--select @body;
   EXEC msdb.dbo.sp_send_dbmail
        @profile_name = ''DBA'', -- Change
        @recipients = ''mssqlalerts@geopits.com'', -- --Change
        @subject = @subject,
        @body = @body,
        @body_format = ''HTML'';
		
	UPDATE [DBADB].[dbo].[sql_server_agent_job_failure]
   SET 
       has_email_been_sent_to_operator = 1,
       ticket_status = ''Open''
   WHERE sql_server_agent_job_id = @JobId and has_email_been_sent_to_operator =0;

    FETCH NEXT FROM EmailCursor INTO 
        @JobId, @JobName, @StepName,  @Schedule, @FailureCount, @FailureTimes, @FailureMessages, @FirstFailureTime, @LastFailureTime,@JobStartTime;
END

CLOSE EmailCursor;
DEALLOCATE EmailCursor;
SET NOCOUNT OFF;
GO', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Close]    Script Date: 2/10/2026 6:29:08 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Close', 
		@step_id=3, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE DBADB;
GO
SET NOCOUNT ON;
IF OBJECT_ID(''tempdb..#job_success'', ''U'') IS NOT NULL
        DROP TABLE #job_success;
		IF OBJECT_ID(''tempdb..#job_step_success'', ''U'') IS NOT NULL
		DROP TABLE #job_step_success;

DECLARE @server_name NVARCHAR(255) = @@SERVERNAME; -- Change Optional
DECLARE @minutes_to_monitor SMALLINT = 480;
-- Temporary table to hold email data
DECLARE @EmailData TABLE (
    JobId NVARCHAR(255),
    JobName NVARCHAR(255),
    StepName NVARCHAR(255),
    Schedule NVARCHAR(255),
    LastSuccessTime NVARCHAR(MAX),
    SuccessMessages NVARCHAR(MAX),
    LastFailureTime DATETIME,
    JobStartTime DATETIME -- Added Job Start Time column
);
WITH CTE_NORMALIZE_DATETIME_DATA AS (
		SELECT
			sysjobhistory.job_id AS sql_server_agent_job_id_guid,
			CAST(sysjobhistory.run_date AS VARCHAR(MAX)) AS run_date_string, 
			REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_time AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_time AS VARCHAR(MAX)) AS run_time_string,
			REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_duration AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_duration AS VARCHAR(MAX)) AS run_duration_string,
			sysjobhistory.run_status,
			sysjobhistory.message,
			sysjobhistory.instance_id
		FROM msdb.dbo.sysjobhistory WITH (NOLOCK)
		WHERE sysjobhistory.run_status = 1
		AND sysjobhistory.step_id = 0),
	CTE_GENERATE_DATETIME_DATA AS (
		SELECT
			CTE_NORMALIZE_DATETIME_DATA.sql_server_agent_job_id_guid,
			CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 5, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 7, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 1, 4) AS DATETIME) +
			CAST(STUFF(STUFF(CTE_NORMALIZE_DATETIME_DATA.run_time_string, 5, 0, '':''), 3, 0, '':'') AS DATETIME) AS job_start_datetime,
			CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 1, 2) AS INT) * 3600 +
				CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 3, 2) AS INT) * 60 + 
				CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 5, 2) AS INT) AS job_duration_seconds,
			CASE CTE_NORMALIZE_DATETIME_DATA.run_status
				WHEN 0 THEN ''Failure''
				WHEN 1 THEN ''Success''
				WHEN 2 THEN ''Retry''
				WHEN 3 THEN ''Canceled''
				ELSE ''Unknown''
			END AS job_status,
			CTE_NORMALIZE_DATETIME_DATA.message,
			CTE_NORMALIZE_DATETIME_DATA.instance_id
		FROM CTE_NORMALIZE_DATETIME_DATA)
	SELECT
		CTE_GENERATE_DATETIME_DATA.sql_server_agent_job_id_guid,
		( CTE_GENERATE_DATETIME_DATA.job_start_datetime) AS job_start_time_utc,
		( DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime)) AS job_Success_time_utc
		
		INTO #job_success
	FROM CTE_GENERATE_DATETIME_DATA
	WHERE ( DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime)) > DATEADD(MINUTE, -1 * @minutes_to_monitor, getdate());
	WITH CTE_NORMALIZE_DATETIME_DATA AS (
		SELECT
			sysjobhistory.job_id AS sql_server_agent_job_id_guid,
			CAST(sysjobhistory.run_date AS VARCHAR(MAX)) AS run_date_string, 
			REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_time AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_time AS VARCHAR(MAX)) AS run_time_string,
			REPLICATE(''0'', 6 - LEN(CAST(sysjobhistory.run_duration AS VARCHAR(MAX)))) + CAST(sysjobhistory.run_duration AS VARCHAR(MAX)) AS run_duration_string,
			sysjobhistory.run_status,
			sysjobhistory.step_id,
			sysjobhistory.step_name,
			sysjobhistory.message,
			sysjobhistory.retries_attempted,
			sysjobhistory.sql_severity,
			sysjobhistory.sql_message_id,
			sysjobhistory.instance_id
		FROM msdb.dbo.sysjobhistory WITH (NOLOCK)
		WHERE sysjobhistory.run_status = 1
		AND sysjobhistory.step_id > 0 ),
	CTE_GENERATE_DATETIME_DATA AS (
		SELECT
			CTE_NORMALIZE_DATETIME_DATA.sql_server_agent_job_id_guid,
			CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 5, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 7, 2) + ''/'' + SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_date_string, 1, 4) AS DATETIME) +
			CAST(STUFF(STUFF(CTE_NORMALIZE_DATETIME_DATA.run_time_string, 5, 0, '':''), 3, 0, '':'') AS DATETIME) AS job_start_datetime,
			CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 1, 2) AS INT) * 3600 +
				CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 3, 2) AS INT) * 60 + 
				CAST(SUBSTRING(CTE_NORMALIZE_DATETIME_DATA.run_duration_string, 5, 2) AS INT) AS job_duration_seconds,
			CASE CTE_NORMALIZE_DATETIME_DATA.run_status
				WHEN 0 THEN ''Failure''
				WHEN 1 THEN ''Success''
				WHEN 2 THEN ''Retry''
				WHEN 3 THEN ''Canceled''
				ELSE ''Unknown''
			END AS job_status,
			CTE_NORMALIZE_DATETIME_DATA.step_id,
			CTE_NORMALIZE_DATETIME_DATA.step_name,
			CTE_NORMALIZE_DATETIME_DATA.message,
			CTE_NORMALIZE_DATETIME_DATA.retries_attempted,
			CTE_NORMALIZE_DATETIME_DATA.sql_severity,
			CTE_NORMALIZE_DATETIME_DATA.sql_message_id,
			CTE_NORMALIZE_DATETIME_DATA.instance_id
		FROM CTE_NORMALIZE_DATETIME_DATA)
	SELECT
		CTE_GENERATE_DATETIME_DATA.sql_server_agent_job_id_guid,
		 CTE_GENERATE_DATETIME_DATA.job_start_datetime AS job_start_time_utc,
		DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime) AS job_success_time_utc,
		CTE_GENERATE_DATETIME_DATA.step_id AS job_failure_step_number,
		ISNULL(CTE_GENERATE_DATETIME_DATA.message, '''') AS job_step_success_message,
		CTE_GENERATE_DATETIME_DATA.sql_severity AS job_step_severity,
		CTE_GENERATE_DATETIME_DATA.retries_attempted,
		CTE_GENERATE_DATETIME_DATA.step_name,
		CTE_GENERATE_DATETIME_DATA.sql_message_id,
		CTE_GENERATE_DATETIME_DATA.instance_id
	INTO #job_step_success
	FROM CTE_GENERATE_DATETIME_DATA
	WHERE  DATEADD(SECOND, ISNULL(CTE_GENERATE_DATETIME_DATA.job_duration_seconds, 0), CTE_GENERATE_DATETIME_DATA.job_start_datetime) > DATEADD(MINUTE, -1 * @minutes_to_monitor, getdate());
	
	WITH ScheduleCTE AS (
    SELECT 
        j.sql_server_agent_job_id,
        CASE 
            -- Handle Daily Frequency
            WHEN j.Frequency = ''Daily'' THEN 
                CASE 
                    WHEN j.DailyFrequency LIKE ''%Repeat%'' 
                    THEN ''Every day from '' + CAST(j.StartTime AS NVARCHAR(8)) + 
                         '' to '' + CAST(j.EndTime AS NVARCHAR(8)) + 
                         '', repeats every '' + 
                         NULLIF(CAST(SUBSTRING(j.DailyFrequency, CHARINDEX(''every '', j.DailyFrequency) + 6, LEN(j.DailyFrequency)) AS NVARCHAR), '''') + ''.''
                    ELSE ''Every day at '' + CAST(j.StartTime AS NVARCHAR(8)) + ''.''
                END

            -- Handle Weekly Frequency
            WHEN j.Frequency = ''Weekly'' THEN 
                ''Every '' + 
                -- Concatenate the days correctly
                REPLACE(j.DayInterval, '' '', '', '') + 
                '' starts at '' + CAST(j.StartTime AS NVARCHAR(8)) + 
                CASE 
                    WHEN j.DailyFrequency LIKE ''%Repeat%'' THEN 
                        '', repeats every '' + 
                        NULLIF(CAST(SUBSTRING(j.DailyFrequency, CHARINDEX(''every '', j.DailyFrequency) + 6, LEN(j.DailyFrequency)) AS NVARCHAR), '''') + ''.''
                    ELSE ''.'' 
                END

            -- Handle Monthly Frequency
            WHEN j.Frequency = ''Monthly'' THEN 
                ''On the '' + 
                CASE 
                    WHEN j.DayInterval LIKE ''%1%'' THEN ''1st ''
                    WHEN j.DayInterval LIKE ''%2%'' THEN ''2nd ''
                    WHEN j.DayInterval LIKE ''%3%'' THEN ''3rd ''
                    WHEN j.DayInterval LIKE ''%4%'' THEN ''4th ''
                    WHEN j.DayInterval LIKE ''%5%'' THEN ''5th ''
                    WHEN j.DayInterval LIKE ''%last%'' THEN ''Last ''
                    ELSE ''Unknown ''
                END + 
                ''day of the month at '' + CAST(j.StartTime AS NVARCHAR(8)) +
                CASE 
                    WHEN j.DailyFrequency LIKE ''%Repeat%'' THEN 
                        '', repeats every '' + 
                        NULLIF(CAST(SUBSTRING(j.DailyFrequency, CHARINDEX(''every '', j.DailyFrequency) + 6, LEN(j.DailyFrequency)) AS NVARCHAR), '''') + ''.''
                    ELSE ''.'' 
                END

            -- Default case for other frequencies
            ELSE ''Other frequency: '' + j.Frequency
        END AS Schedule
    FROM 
        [DBADB].[dbo].[sql_server_agent_job] j
)
INSERT INTO @EmailData (JobId, JobName, StepName, Schedule ,JobStartTime, SuccessMessages, LastSuccessTime , LastFailureTime)
	select j.sql_server_agent_job_id,
    j.sql_server_agent_job_name,
	js.step_name , 
	sc.Schedule ,
	max(js.job_start_time_utc) as Last_succes_Start_timestamp,
	js.job_step_success_message,
	max(CONVERT(VARCHAR(23), CAST(js.job_success_time_utc AS DATETIME), 121)) as Last_job_success_timestamp , 
	max(jf.job_failure_time_utc) as Last_job_failure_timestamp 
	from #job_step_success js inner join [DBADB].[dbo].[sql_server_agent_job] j 
        ON js.sql_server_agent_job_id_guid = j.sql_server_agent_job_id_guid inner join [DBADB].[dbo].[sql_server_agent_job_failure] jf on j.sql_server_agent_job_id=jf.sql_server_agent_job_id JOIN 
    ScheduleCTE sc ON j.sql_server_agent_job_id = sc.sql_server_agent_job_id
		WHERE jf.ticket_status = ''Open'' and js.step_name=jf.job_failure_step_name and jf.job_step_message_id>-1
		
		group by j.sql_server_agent_job_id,
    j.sql_server_agent_job_name,
	js.step_name , 
	sc.Schedule ,js.job_step_success_message
	having max(CONVERT(VARCHAR(23), CAST(js.job_success_time_utc AS DATETIME), 121)) >max(jf.job_failure_time_utc);

--select JobId, JobName, StepName, Schedule ,JobStartTime, SuccessMessages, LastSuccessTime  , LastFailureTime from @EmailData;

    
DECLARE @subject NVARCHAR(255),
        @body NVARCHAR(MAX),
        @JobId NVARCHAR(255),
        @JobName NVARCHAR(255),
        @StepName NVARCHAR(255),
        @Schedule NVARCHAR(255),
        @SuccessMessages NVARCHAR(MAX),
        @LastFailureTime DATETIME,
        @LastSuccessTime DATETIME,
		@JobStartTime DATETIME;

DECLARE EmailCursor CURSOR FOR 
SELECT JobId, JobName, StepName, Schedule ,JobStartTime, SuccessMessages, LastSuccessTime , LastFailureTime
FROM @EmailData;

OPEN EmailCursor;
FETCH NEXT FROM EmailCursor INTO 
    @JobId, @JobName, @StepName, @Schedule ,@JobStartTime, @SuccessMessages, @LastSuccessTime , @LastFailureTime;

WHILE @@FETCH_STATUS = 0
BEGIN

	
	SET @subject = ''Thyrocare ''+ @server_name +'' ''+@JobName + '' Failed Alert -> Closed '' ; -- Change

	 SET @body =''<html>
    <head>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #f4f6f9; /* Light gray background */
                color: #495057; /* Darker text color for better contrast */
            }
            h2 {
                color: #007bff; /* Soft blue color for headings */
                text-align: center;
                margin-bottom: 20px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
                background-color: #ffffff; /* White background for table */
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow for table */
            }
            th, td {
                padding: 15px;
                border: 1px solid #dee2e6; /* Lighter border color */
                text-align: left;
            }
            th {
                background-color: #007bff; /* Blue color for header */
                color: #ffffff; /* White text in header */
            }
            tr:nth-child(even) {
                background-color: #f8f9fa; /* Light gray for even rows */
            }
            tr:hover {
                background-color: #f1f1f1; /* Light hover effect for rows */
            }
            p {
                text-align: center;
                margin-top: 20px;
                font-weight: bold;
                color: #6c757d; /* Gray text color */
            }
        </style>
    </head>
    <body>
        <h2>Failed Job Success Alert</h2>
        <table>
            <tr><th>Job Name</th><td>'' + @JobName + ''</td></tr>
            <tr><th>Step Name</th><td>'' + ISNULL(@StepName, ''N/A'') + ''</td></tr>
            <tr><th>Success Message</th><td>'' + ISNULL(@SuccessMessages, ''N/A'') + ''</td></tr>
            <tr><th>Last Run Start Time</th><td>'' + CONVERT(NVARCHAR, @JobStartTime, 120) + ''</td></tr>
            <tr><th>Last Failure Time</th><td>'' + CONVERT(NVARCHAR, @LastFailureTime, 120) + ''</td></tr>
            <tr><th>Last Success Time</th><td>'' + CONVERT(NVARCHAR, @LastSuccessTime, 120) + ''</td></tr>
            <tr><th>Schedule</th><td>'' + @Schedule + ''</td></tr>
        </table>
    </body>
</html>'';
--select @body;
   EXEC msdb.dbo.sp_send_dbmail
        @profile_name = ''DBA'', -- Change
        @recipients = ''mssqlalerts@geopits.com'', -- Change
        @subject = @subject,
        @body = @body,
        @body_format = ''HTML'';
		
   UPDATE [DBADB].[dbo].[sql_server_agent_job_failure]
   SET ticket_status = ''Closed''
   WHERE sql_server_agent_job_id = @JobId and has_email_been_sent_to_operator =1 and ticket_status = ''Open'';

    FETCH NEXT FROM EmailCursor INTO 
        @JobId, @JobName, @StepName, @Schedule ,@JobStartTime, @SuccessMessages, @LastSuccessTime , @LastFailureTime;
END

CLOSE EmailCursor;
DEALLOCATE EmailCursor;	

DROP TABLE #job_success,#job_step_success;
SET NOCOUNT OFF;
GO', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'new5m', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=5, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20241028, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'9c1b6612-e6b5-4c77-8b04-72e4e8943361'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_GEOPITS_LONG_RUNNING_CLOSE]    Script Date: 2/10/2026 6:29:08 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:08 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_GEOPITS_LONG_RUNNING_CLOSE', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Close_Collection]    Script Date: 2/10/2026 6:29:08 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Close_Collection', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXEC [dbo].[DBA_GeoPITS_Longrunning_closed]', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=2, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250419, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'5db47de9-fc9a-4861-939c-2aff1c4f9fb7'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_GEOPITS_LONG_RUNNING_OPEN]    Script Date: 2/10/2026 6:29:09 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:09 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_GEOPITS_LONG_RUNNING_OPEN', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Open_Collection]    Script Date: 2/10/2026 6:29:09 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Open_Collection', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXEC [dbo].[DBA_GeoPITS_Longrunning]', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=5, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250419, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'418cbac2-07a1-4b9c-a486-987da052dbf9'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Log_File_Data_Cleanup]    Script Date: 2/10/2026 6:29:09 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:09 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Log_File_Data_Cleanup', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Delete 7 Days Record]    Script Date: 2/10/2026 6:29:09 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Delete 7 Days Record', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DELETE FROM [dbo].[Log_File_Size]
WHERE LogDate < DATEADD(dd,-7,GETDATE())', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20241222, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'3dd016ab-f8c3-43f1-963c-0406b74bc557'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Log_File_Size_Collection&Shrink_Alert]    Script Date: 2/10/2026 6:29:09 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]    Script Date: 2/10/2026 6:29:09 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Log_File_Size_Collection&Shrink_Alert', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Data_Collection]    Script Date: 2/10/2026 6:29:09 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Data_Collection', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'Exec [dbo].[Log_File_Size_Data_Collection] ', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Shrink_Alert]    Script Date: 2/10/2026 6:29:09 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Shrink_Alert', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'DECLARE @TotalLogFileMB DECIMAL(18, 2),
        @DatabaseName NVARCHAR(128),
        @FileName NVARCHAR(256),
		@DiskFreeSpaceMB DECIMAL(18,2),
        @AlertMessage NVARCHAR(MAX),
        @EmailBody NVARCHAR(MAX),
        @LogDate DATETIME,
        @Threshold DECIMAL(18, 2) = 5120,
        @ClientName NVARCHAR(255) = ''Thyrocare'',--Change
        @Subject NVARCHAR(255),
        @AlertStatus NVARCHAR(20),
        @LastAlertTime DATETIME,
        @AlertID INT;

-- Declare cursor
DECLARE db_cursor CURSOR FOR 
SELECT [DBName], [FileName], TRY_CAST([TotalLogfileSizeMB] AS DECIMAL(18, 2)),DiskFreeSpaceMB ,[LogDate]
FROM [DBADB].[dbo].[Log_File_Size]
WHERE [LogDate] > DATEADD(MINUTE, -1, GETDATE()) AND DBName not in (''test'');  

OPEN db_cursor;

FETCH NEXT FROM db_cursor INTO @DatabaseName, @FileName, @TotalLogFileMB,@DiskFreeSpaceMB, @LogDate;

-- Loop through cursor
WHILE @@FETCH_STATUS = 0
BEGIN
    SET @AlertMessage = '''';
    SET @EmailBody = '''';
    SET @Subject = '''';
    SET @LastAlertTime = NULL;
    SET @AlertID = NULL;

    -- Check if the log file size exceeds the threshold
    IF @TotalLogFileMB >= @Threshold
    BEGIN
        -- Fetch the last alert time for the "Open" status
        SELECT TOP 1 @LastAlertTime = AlertTime, @AlertID = AlertID
        FROM Log_File_Shrink_AlertTable
        WHERE DatabaseName = @DatabaseName AND LogFileName = @FileName AND AlertStatus = ''Open''
        ORDER BY AlertTime DESC;

        -- If no "Open" alert exists, insert a new alert and send email
        IF @LastAlertTime IS NULL
        BEGIN
            INSERT INTO Log_File_Shrink_AlertTable (DatabaseName, LogFileName, TotalLogFileSizeMB, AlertMessage, AlertTime, AlertStatus, has_email_been_sent_to_operator)
            VALUES (@DatabaseName, @FileName, @TotalLogFileMB, ''Log file size exceeded threshold.'', GETDATE(), ''Open'', 1);

            SET @AlertID = SCOPE_IDENTITY();
            SET @AlertStatus = ''Open'';

            -- Build the email subject and body
            SET @Subject = ''Open Alert (ID: '' + CAST(@AlertID AS NVARCHAR(10)) + '') -> Log File Shrinking Required for '' + @DatabaseName + '' on '' + @ClientName + '' ('' + @@SERVERNAME + '')'';
            SET @EmailBody = 
            ''<html>
            <head>
                <style>
                    body { font-family: Arial, sans-serif; color: #333; background-color: #ffffff; }
                    h2 { color: #d9534f; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { padding: 15px; border: 1px solid #ddd; text-align: center; }
                    th { background-color: #000000; color: white; } 
                    tr:hover { background-color: #f1f1f1; }
                </style>
            </head>
            <body>
                <h2>Log File Size Exceeded ''+ FORMAT(ROUND(@Threshold / 1024,0), ''N0'')+ '' GB</h2>
                <table>
                    <tr>
                        <th>Database Name</th>
                        <th>Log File Size (MB)</th>
						<th>Disk Free Space (GB)</th>
                    </tr>
                    <tr>
                        <td>'' + @DatabaseName + ''</td>
                        <td>'' + CAST(@TotalLogFileMB AS NVARCHAR(10)) + ''</td>
						<td>'' + FORMAT(ROUND(@DiskFreeSpaceMB / 1024,0), ''N2'') + ''</td>
                    </tr>
                </table>
            </body>
            </html>'';

            EXEC msdb.dbo.sp_send_dbmail
                @profile_name = ''DBA'',--Change 2
                @recipients = ''mssqlalerts@geopits.com'',--change 3
				@blind_copy_recipients = ''aruneswaran@geopits.com'',
                @subject = @Subject,
                @body = @EmailBody,
                @body_format = ''HTML'';
        END
        ELSE IF DATEDIFF(HOUR, @LastAlertTime, GETDATE()) >= 6
        BEGIN
            -- Update existing alert and resend email
            UPDATE Log_File_Shrink_AlertTable
            SET 
                TotalLogFileSizeMB = @TotalLogFileMB,
                AlertMessage = ''Log file size still exceeds threshold.'',
                AlertTime = GETDATE()
            WHERE AlertID = @AlertID;

            SET @AlertStatus = ''Open'';

            -- Build the email subject and body
            SET @Subject = ''Open Alert (ID: '' + CAST(@AlertID AS NVARCHAR(10)) + '') -> Log File Shrinking Still Required for '' + @DatabaseName + '' on '' + @ClientName + '' ('' + @@SERVERNAME + '')'';
            SET @EmailBody = 
            ''<html>
            <head>
                <style>
                    body { font-family: Arial, sans-serif; color: #333; background-color: #ffffff; }
                    h2 { color: #d9534f; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { padding: 15px; border: 1px solid #ddd; text-align: center; }
                    th { background-color: #000000; color: white; } 
                    tr:hover { background-color: #f1f1f1; }
                </style>
            </head>
            <body>
                <h2>Log File Size Still Exceeded '' + FORMAT(ROUND(@Threshold / 1024,0), ''N0'') + '' GB</h2>
                <table>
                    <tr>
                        <th>Database Name</th>
                        <th>Log File Size (MB)</th>
						<th>Disk Free Space (GB)</th>
                    </tr>
                    <tr>
                        <td>'' + @DatabaseName + ''</td>
                        <td>'' + CAST(@TotalLogFileMB AS NVARCHAR(10)) + ''</td>
						<td>'' + FORMAT(ROUND(@DiskFreeSpaceMB / 1024,0), ''N2'') + ''</td>
                    </tr>
                </table>
            </body>
            </html>'';

            EXEC msdb.dbo.sp_send_dbmail
                @profile_name = ''DBA'',-- Change 4
                @recipients = ''mssqlalerts@geopits.com'',--Change 5
				@blind_copy_recipients = ''aruneswaran@geopits.com'',
                @subject = @Subject,
                @body = @EmailBody,
                @body_format = ''HTML'';
        END
    END
    ELSE
    BEGIN
        -- Check if an "Open" alert exists to resolve it
        IF EXISTS (SELECT 1 FROM Log_File_Shrink_AlertTable WHERE DatabaseName = @DatabaseName AND LogFileName = @FileName AND AlertStatus = ''Open'')
        BEGIN
            SELECT @AlertID = AlertID
            FROM Log_File_Shrink_AlertTable
            WHERE DatabaseName = @DatabaseName AND LogFileName = @FileName AND AlertStatus = ''Open'';

            SET @AlertStatus = ''Resolved'';

            -- Update alert status to resolved
            UPDATE Log_File_Shrink_AlertTable
            SET 
                AlertStatus = @AlertStatus, 
                AlertMessage = ''Sufficient free space available.'', 
                TotalLogFileSizeMB = @TotalLogFileMB,
                AlertTime = GETDATE()
            WHERE AlertID = @AlertID;

            -- Build the email subject and body
            SET @Subject = ''Resolved Alert (ID: '' + CAST(@AlertID AS NVARCHAR(10)) + '') -> Log File Shrinking Completed for '' + @DatabaseName + '' on '' + @ClientName + '' ('' + @@SERVERNAME + '')'';
            SET @EmailBody = 
            ''<html>
            <head>
                <style>
                        body { font-family: Arial, sans-serif; color: #333; background-color: #ffffff; }
                        h2 { color: #29B626; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 15px; border: 1px solid #ddd; text-align: center; }
                        th { background-color: #000000; color: white; }
                        tr:hover { background-color: #f1f1f1; }
                 </style>
            </head>
            <body>
                <h2>Log File Size Reduced Below '' + FORMAT(ROUND(@Threshold / 1024,0), ''N0'') + '' GB</h2>
                <table>
                    <tr>
                        <th>Database Name</th>
                        <th>Log File Size (MB)</th>
						<th>Disk Free Space (GB)</th>
                    </tr>
                    <tr>
                        <td>'' + @DatabaseName + ''</td>
                        <td>'' + CAST(@TotalLogFileMB AS NVARCHAR(10)) + ''</td>
						<td>'' + FORMAT(ROUND(@DiskFreeSpaceMB / 1024,0), ''N2'') + ''</td> 
                    </tr>
                </table>
            </body>
            </html>'';

            EXEC msdb.dbo.sp_send_dbmail
                @profile_name = ''DBA'',--Change 6
                @recipients = ''mssqlalerts@geopits.com'',--Change 7
                @blind_copy_recipients = ''aruneswaran@geopits.com'',
                @subject = @Subject,
                @body = @EmailBody,
                @body_format = ''HTML'';
        END
    END

    FETCH NEXT FROM db_cursor INTO @DatabaseName, @FileName, @TotalLogFileMB,@DiskFreeSpaceMB ,@LogDate;
END

-- Close and deallocate cursor
CLOSE db_cursor;
DEALLOCATE db_cursor;
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20241220, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'9e6b0d2a-acb5-48fc-b607-218544e2410f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_LogShipping_Restoration_Alert]    Script Date: 2/10/2026 6:29:09 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:09 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_LogShipping_Restoration_Alert', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'logship', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Delay_Alert]    Script Date: 2/10/2026 6:29:10 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Delay_Alert', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE master;
GO
SET NOCOUNT ON;

DECLARE @ThresholdMinutes INT = 15;
DECLARE @CurrentTime DATETIME = GETDATE();
DECLARE @SessionId INT;
DECLARE @RestoreStartTime DATETIME;
DECLARE @RestoreDurationSeconds INT;
DECLARE @RestoreCommand NVARCHAR(MAX);
DECLARE @DatabaseName SYSNAME;
DECLARE @BackupFileName NVARCHAR(512) = N''N/A'';
DECLARE @ServerName NVARCHAR(128) = @@SERVERNAME;
DECLARE @BodyMessage NVARCHAR(MAX);


-- Step 1: Find currently running RESTORE LOG commands
SELECT TOP 1
    @SessionId = r.session_id,
    @RestoreStartTime = r.start_time,
    @DatabaseName = DB_NAME(r.database_id),
    @RestoreCommand = t.text
FROM sys.dm_exec_requests r
CROSS APPLY sys.dm_exec_sql_text(r.sql_handle) t
WHERE r.command LIKE ''RESTORE%'' AND r.status IN ( ''running'',''runnable'',''sleeping'',''suspended'')
  AND t.text LIKE ''%RESTORE LOG%'' AND r.start_time IS NOT NULL AND DATEDIFF(MINUTE, r.start_time, GETDATE())>15;

-- Step 2: Exit if no restore is currently running
IF @SessionId IS NULL
BEGIN
    PRINT ''No restore currently running.'';
    RETURN;
END

-- Step 3: Calculate restore duration
SET @RestoreDurationSeconds = DATEDIFF(SECOND, @RestoreStartTime, @CurrentTime);

-- Step 4: Only alert if duration exceeds threshold
IF @RestoreDurationSeconds < (@ThresholdMinutes * 60)
BEGIN
    PRINT ''Restore is running but within acceptable duration.'';
    RETURN;
END

-- Step 5: Extract backup file name from RESTORE command
IF @RestoreCommand LIKE ''%FROM DISK = N''''%''
BEGIN
    DECLARE @FileStart INT = CHARINDEX(''FROM DISK = N'''''', @RestoreCommand) + 16;
    DECLARE @FileEnd INT = CHARINDEX('''''''', @RestoreCommand, @FileStart);

    IF @FileStart > 0 AND @FileEnd > @FileStart
    BEGIN
        SET @BackupFileName = SUBSTRING(@RestoreCommand, @FileStart, @FileEnd - @FileStart);
    END
END

-- Step 6: Prepare and send email alert
SET @BodyMessage = 
N''<html>
<head>
<style>
    table {border-collapse:collapse; font-family:Arial; font-size:14px;}
    th {background-color:#0074D9; color:#FFFFFF; padding:8px;}
    td {padding:8px;}
</style>
</head>
<body>
<h3 style="color:#0074D9;">Log Shipping Restore Alert</h3>
<table border="1">
    <tr><th>Parameter</th><th>Value</th></tr>
    <tr><td>Server</td><td>'' + @ServerName + N''</td></tr>
    <tr><td>Database</td><td>'' + @DatabaseName + N''</td></tr>
    <tr><td>Restore Start Time</td><td>'' + CONVERT(NVARCHAR(20), @RestoreStartTime, 120) + N''</td></tr>
    <tr><td>Duration</td><td>'' + CAST(@RestoreDurationSeconds / 60 AS NVARCHAR) + N'' min '' + CAST(@RestoreDurationSeconds % 60 AS NVARCHAR) + N'' sec</td></tr>
    <tr><td>Backup File</td><td>'' + @BackupFileName + N''</td></tr>
    <tr><td>Alert Time</td><td>'' + CONVERT(NVARCHAR(20), @CurrentTime, 120) + N''</td></tr>
</table>
</body>
</html>'';

EXEC msdb.dbo.sp_send_dbmail
    @profile_name = ''DB Alerts'', -- Change DBMail Profile
    @recipients = ''mssqltechsupport@geopits.com;dcc@geopits.com;pushparaj.j@pharmeasy.in;aswin.kumarvpkothuru@thyrocare.com;mssqltechsupport@geopits.com'', -- Add Recipients
    @subject = '' Log Shipping Restore Delay Alert'',
    @body = @BodyMessage,
    @body_format = ''HTML'';

', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'every 5 mins', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=5, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250724, 
		@active_end_date=99991231, 
		@active_start_time=193000, 
		@active_end_time=80000, 
		@schedule_uid=N'b68d6581-0f29-49cd-8f52-14b2491d0d8b'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_long_running_summary]    Script Date: 2/10/2026 6:29:10 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:10 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_long_running_summary', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Summary of Long running queries report weekly', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [s1]    Script Date: 2/10/2026 6:29:10 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N's1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'USE [DBADB];
GO

DECLARE @tableHTML NVARCHAR(MAX);
DECLARE @subject NVARCHAR(200);
DECLARE @ServerName NVARCHAR(128);

SET @ServerName = @@SERVERNAME;
SET @tableHTML = 
N''<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; font-size: 15px; color: #333; margin: 0; padding: 20px; background-color: #ffffff; }
    .page-container { margin: 0 auto; padding: 30px; width: 95%; background-color: #ffffff; border: 2px solid #000000; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
    h1 { font-family: "Trebuchet MS", Helvetica, sans-serif; font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 20px; padding: 10px; border-radius: 8px; background-color: #004080; color: #ffffff; border-bottom: 2px solid #002147; }
    table { border-collapse: collapse; width: 100%; table-layout: fixed; margin-top: 10px; }
    th, td { border: 1px solid black; padding: 8px; text-align: left; vertical-align: top; font-size: 13px; word-wrap: break-word; white-space: normal; }
    th { background-color: #004080; color: #ffffff; font-size: 14px; font-weight: bold; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    tr:hover { background-color: #e6f2ff; }
    .sql-box { background: #fafafa; border: 1px solid #ccc; padding: 6px; max-height: 100px; overflow-y: auto; font-family: Consolas, monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; }
    .footer { margin-top: 15px; font-size: 11px; color: #555; text-align: center; }
  </style>
</head>
<body>
  <div class="page-container">
    <h1>Long Running Report Summary - '' + @ServerName + '' - '' + CONVERT(VARCHAR(10), GETDATE(), 105) + ''</h1>
    <table>
      <tr>
        <th style="width:5%;">Sino</th>
        <th style="width:10%;">Database</th>
        <th style="width:10%;">User</th>
        <th style="width:15%;">Stored Procedure</th>
        <th style="width:20%;">Executing SQL</th>
        <th style="width:20%;">Statement Text</th>
        <th style="width:10%;">Execution Count</th>
        <th style="width:10%;">Max Elapsed</th>
      </tr>'';

-- Summarize queries with ExecutionCount > 10
;WITH QuerySummary AS (
    SELECT 
        ISNULL(DatabaseName,''-'') AS DatabaseName,
        ISNULL(UserName,''-'') AS UserName,
        ISNULL(ExecutingSQL,''-'') AS ExecutingSQL,
        ISNULL(StatementText,''-'') AS StatementText,
        ISNULL(StoredProcedure,''-'') AS StoredProcedure,
        COUNT(*) AS ExecutionCount,
        MAX(DATEDIFF(SECOND,''00:00:00'', ElapsedTime)) AS MaxElapsedSec
    FROM [DBADB].[dbo].[longqrydetails]
    WHERE StartTime >= DATEADD(DAY, -7, GETDATE())
    GROUP BY 
        ISNULL(DatabaseName,''-''), 
        ISNULL(UserName,''-''), 
        ISNULL(ExecutingSQL,''-''), 
        ISNULL(StatementText,''-''), 
        ISNULL(StoredProcedure,''-'')
    HAVING COUNT(*) > 1
) 
SELECT @tableHTML = @tableHTML +
    N''<tr>
        <td>'' + CAST(ROW_NUMBER() OVER(ORDER BY MaxElapsedSec DESC) AS VARCHAR) + N''</td>
        <td>'' + DatabaseName + N''</td>
        <td>'' + UserName + N''</td>
		 <td>'' + StoredProcedure + N''</td>
        <td><div class="sql-box">'' + ExecutingSQL + N''</div></td>
        <td><div class="sql-box">'' + StatementText + N''</div></td>
       
        <td>'' + CAST(ExecutionCount AS VARCHAR) + N''</td>
        <td>'' + CONVERT(varchar, DATEADD(SECOND, CAST(MaxElapsedSec AS INT), 0), 108) + N''</td>
      </tr>''
FROM QuerySummary
ORDER BY MaxElapsedSec DESC;

SET @tableHTML = @tableHTML + 
N''</table>
<div class="footer">
 <br>
  Only queries with Execution Count > 1 are included.
</div>
</div>
</body></html>'';

SET @subject = ''Long Running Query Summary - '' + @ServerName + '' - '' + CONVERT(VARCHAR(10), GETDATE(), 105);

EXEC msdb.dbo.sp_send_dbmail
    @profile_name = ''dba'',                     
   @recipients = ''aswin.kumarvpkothuru@thyrocare.com;nikhil@pharmeasy.in;ankit.g@pharmeasy.in;rajesh.n@pharmeasy.in;pushparaj.j@pharmeasy.in'',
   @copy_recipients=''mssqlalerts@geopits.com'',
   @blind_copy_recipients=''mohamed@geopits.com;vishnupriya@geopits.com'',
    @subject      = @subject,
    @body         = @tableHTML,
    @body_format  = ''HTML'';
			
        ', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N's1', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=2, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20250915, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'ab890066-9dfb-41da-b74b-5f53ba88a1f2'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_PLE_Data_Collection]    Script Date: 2/10/2026 6:29:10 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:10 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_PLE_Data_Collection', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'MSGeopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Data_Collection]    Script Date: 2/10/2026 6:29:10 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Data_Collection', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'

--Schedule data collection job every one min
-- Ensure the PageLifeExpectancyLog table exists in DBADB
    IF NOT EXISTS (
        SELECT 1 
        FROM DBADB.sys.tables 
        WHERE name = ''PageLifeExpectancyLog'' AND schema_id = SCHEMA_ID(''dbo'')
    )
    BEGIN
        EXEC(''
            USE DBADB;
            CREATE TABLE dbo.PageLifeExpectancyLog (
                LogID INT IDENTITY(1,1) PRIMARY KEY,
                CounterName NVARCHAR(255),
                PageLifeExpectancy BIGINT,
                LoggedAt DATETIME DEFAULT GETDATE()
            );
        '');
    END

INSERT INTO DBADB.dbo.PageLifeExpectancyLog (CounterName, PageLifeExpectancy)
SELECT
    [counter_name],
    [cntr_value]
FROM
    sys.dm_os_performance_counters
WHERE
    [object_name] = ''SQLServer:Buffer Manager''
    AND [counter_name] = ''Page life expectancy'';
', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Every1Minutes', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=4, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20250902, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'1971ee3e-204e-42ef-9461-713b1b31e2cc'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO

/****** Object:  Job [DBA_Updatestatistics]    Script Date: 2/10/2026 6:29:10 PM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[BigLoad]]    Script Date: 2/10/2026 6:29:10 PM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[BigLoad]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[BigLoad]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DBA_Updatestatistics', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[BigLoad]', 
		@owner_login_name=N'geopits', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [S1]    Script Date: 2/10/2026 6:29:10 PM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'S1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXECUTE dbo.IndexOptimize
@Databases = ''DWH'',
@FragmentationLow = NULL,
@FragmentationMedium = NULL,
@FragmentationHigh = NULL,
@UpdateStatistics = ''ALL''', 
		@database_name=N'DBADB', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'S1', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20230415, 
		@active_end_date=99991231, 
		@active_start_time=10000, 
		@active_end_time=235959, 
		@schedule_uid=N'feaed9e4-a6b8-4ee5-a380-96e380f4409c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:
GO


